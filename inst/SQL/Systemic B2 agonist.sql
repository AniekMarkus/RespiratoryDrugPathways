CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (43814721,43814722,43796642,35136989,35160455,35142553,35155727,35135940,35148898,35160834,35136697,35134199,35130548,35139606,35159929,35156103,35130812,35130475,35134005,35158985,35153633,35138212,42918209,42918212,42918213,42918215,42918216,42918214,42918217,42918210,42918211,41448404,41447936,41448330,41448609,42918161,42918162,43297914,43265307,41419937,41416752,41421087,41418935,41418047,41414774,41425296,41421848,41419314,41423985,41417971,41421592,41422464,41424164,41423178,41427341,41415405,41421591,41425896,41426927,41426926,41424857,41416245,41414130,41418821,41421391,41427489,41423571,41423558,41419247,41421379,41417012,43865930,41423524,43865931,43793455,43829580,43667895,43739631,41422164,41415271,41419215,41420956,41423066,41416137,41419014,41418305,41418686,41423810,41417211,41420901,41425172,41422102,41427156,41415713,41421708,41418284,41422074,41416048,41426697,41425913,41426978,41425350,41416295,21039807,41425038,21069362,41419370,21118286,41421607,41413824,41413913,41422797,41420200,41426184,35143687,35155515,35138321,35134553,35150536,35148731,43789878,43844182,43646226,43826106,43772059,43700252,41370501,41367433,41361813,41365517,41370287,41369732,41361471,41365518,41362598,41365877,41370460,41372709,41361175,41367394,41368458,41371535,41365458,41368457,41367197,41373056,41373294,43682183,43682184,43862306,43682185,43862307,43664347,43826051,43646176,43844131,41370442,41370441,41372687,41371505,41364699,41363245,43592124,43862383,43808008,43682251,43736165,43772082,43682250,43772083,43717994,43628140,43789901,43610069,43844201,43826119,43736166,43664415,43682252,43736167,43844200,43808007,43772081,43826118,43700267,43789898,43844199,43754029,43789899,43772078,43862381,43772076,43772077,43664414,1154576,1154620,1154379,40171426,1154577,1154378,40171427,19103746,19107332,19103785,40166145,21118349,36778415,21088881,21049671,21167590,21088882,21137964,21098778,21137965,21157798,36778414,36778413,21177329,36281731,41428947,41430089,41430088,41430155,41428988,41428987,41428933,41429879,41429570,41430002,41429914,41429145,41430355,41428946,41429288,41428986,41429569,35782781,35782780,21068580,21078332,35139690,35150307,41334883,43038844,43038845,36277712,41333519,43038843,41330373,41337072,41335399,43038848,43038849,43038850,35776273,36277678,36277992,35776829,35776697,43038846,43038847,35776964,43258720,43258719,21096839,43174652,43038851,21057605,43207398,43141435,43163651,43185499,43174653,43152532,43174654,21136052,21116442,21028168,43152533,43174655,21037969,41330809,41327417,41334406,41331018,43680277,43751987,43680278,35130230,35148540,35142444,43842132,43608046,43698216,35137271,35152263,43770097,43626135,43608146,43662272,41332237,41332904,43607975,41333208,41334553,41335914,41333423,41331146,41335481,43751924,35150574,35157221,35135906,35146896,35142129,35159356,35136723,35133935,35152841,35150816,35161496,35161478,35130267,35152891,35158414,35137163,43787959,43770084,41337540,41333521,43806013,41334887,41333520,41332835,41332155,43824134,43752054,41331692,43662415,41332375,43662414,41329042,41335079,41333350,41334708,41337074,41337073,43770085,43842065,43607966,43860274,43715920,43680219,43860275,43769943,43680218,43842066,43285965,43285966,43258724,43285967,35150922,35135405,21107052,43174629,21166033,21048159,43163626,43174630,21087382,21116807,21097206,40163433,35137439,35155999,35139177,35130138,41433431,41434087,41433082,41431996,41434650,41432250,41434655,41433897,41435387,41381251,41380416,41376823,41381007,41380351,43592665,41380849,41381394,41379039,41381546,43826659,43700886,41378494,41380597,41378652,43736710,41435885,41436674,41436394,41438049,41437147,41437957,41437478,41436751,41437328,41438204,41437203,41436138,43704673,41438475,43830583,43812573,41437853,41436028,41438417,41437561,41438730,41437089,41436981,41436646,41437023,41437461,41437090,41437460,41438467,41437358,41431130,41431561,41431617,41431702,41431540,41431017,41431541,41431454,41431309,41431478,41431270,41431432,41431636,41431498,41431326,41431882,41431216,41431796,41431701,41431382,41431269,41431239,41431735,41431734,41431453,41431149,41431495,41431148,41431497,41431496,41431781,41431020,44198992,44198964,44198931,44199007,44198921,44198997,41431039,41431268,41431954,41431828,41431655,41431539,41431923,41431794,41431523,44198963,44198953,44199004,44198976,44198994,44198998,44198943,44198932,41431366,41431128,41431558,41431214,41338891,41341503,41340725,41341737,41439443,41439380,41439333,41439144,41439220,41439163,41439141,41439459,41439115,41439157,41439094,41439348,41439627,21167774,41439286,21098977,41439317,21128297,21089061,21098976,21089060,21177516,21158000,41385002,41385306,41387576,41386044,41385151,41387157,41385221,41388161,41386166,41386037,41389427,41389495,43629164,41387048,43827020,41388290,41388847,43845135,43611021,43683227,42918811,42918812,42918801,42918802,43614720,43848792,43740790,43614721,43632873,43596756,43722670,43867004,43596755,42918667,42918668,42918670,42918674,42918675,42918669,42918671,42918672,42918632,42918673,42918424,42918425,41393419,41400917,41395744,41390656,41400109,35784434,35784083,35784048,35784615,21039361,21098233,21058936,21127568,41392065,41400916,41397702,41397701,41394733,43755600,41396778,43755601,43701821,43611600,41398405,41393021,41396685,41396393,43593620,43665933,43719488,43809561,43827600,43863915,41392064,41390993,41393715,41391282,41392649,41391395,43629712,41395478,41392343,41395743,43755602,41392962,41399758,41390645,41395336,44131560,44131482,44130315,44130164,589200,586995,41359293,41353329,41359978,41353497,41357629,784492,35780533,43040676,43040677,41355990,41359977,41359976,41353201,43040678,43040679,43040680,35780059,784493,35780215,35781002,784494,43275360,35781340,589988,21068247,21176183,43275359,36278802,36278912,36780461,36780460,36780459,36780458,36895426,36895350,43040681,43040682,43196909,43218831,43164028,43196910,43196911,43164029,43218832,43152975,43152976,43185929,43663682,43663683,43663684,35780710,35780875,35780050,35780049,35781095,35780774,21087862,21048640,21127025,21097683,21156739,21078125,43719695,43719696,43593823,43648017,43864124,19104814,40927621,41083930,40965110,41152958,19060644,19027037,19004086,44045261,986180,19101538,35770835,42480427,21101422,40958901,40990144,40965106,41183984,41052323,40958897,40933907,41183976,1166126,41177653,41302098,40933930,40933929,19105773,1154654,36782814,21042572,21032659,21052340,21140661,21042571,19128414,44111353,44087994,44033851,44075128,19128415,21150502,21062168,19128416,35138382,19128417,36782813,21062167,41209180,41052326,41090207,41246311,1154351,41277216,40933934,41271004,41240139,36274884,44071119,41146735,43036321,41177656,41083939,40840587,40902750,40871719,41277215,40902749,41184012,43036323,43036324,41246331,41277214,41308380,41215336,41184011,41308379,19027038,40996451,41058645,40996450,40996449,40902748,19004087,36259962,35754633,44126988,43036322,36882905,43279283,44058227,44062399,42480991,43194374,21072083,43172443,43150280,43172444,43139338,43150281,42480992,21111260,43161461,41083934,40865441,41052331,44173039,44176809,41027457,41152967,44188013,44180493,41058626,40996441,41083929,40958898,40965104,41277181,41177642,40990145,40965109,41183987,44172540,44172539,44164960,44177276,44169755,44177275,36883895,41177643,43639179,43729018,43729019,41090206,41308358,41308357,43657251,43639181,19063963,19061106,783976,35762423,40927617,44032257,44049389,41152950,40840554,43036318,43036319,19027039,41183979,41246304,19004088,783977,35771374,44059883,44113847,42483387,21072077,43262896,590017,587738,36782811,36782810,36782809,36782808,1154581,40996424,41121414,41209177,19000911,36886777,36882903,36892711,43172440,43194371,43150277,43161458,43139336,43194372,35130198,35129472,35154658,1154349,44072710,44036266,19027033,40896628,41083933,41021128,41177644,40865435,21150493,21062160,21101421,21150494,21022897,21032658,21160445,21091529,43216224,41240136,40990146,40825151,41052329,41270995,21160444,21101420,21120934,21150492,21150491,21150489,35159832,21150490,19027032,44098512,44075127,44111351,44049388,1154376,44046872,44087992,40822405,40996435,40976479,41090211,41195639,41308362,40976480,19000909,43172446,43183361,43216225,42931127,19027031,40965117,41058619,40965116,40871697,40965115,41121423,40933917,40840567,41183990,41277190,41183989,35143651,19000907,36272721,36271417,19128692,44085589,44087995,19017861,21091530,42931118,21111258,21072081,21101423,19072360,35758219,35744340,35756902,35769392,35765170,35752692,35769393,35769391,21130710,21062164,21160448,21150498,35765171,35756903,35773765,35769394,35773764,21160447,35752693,21022903,19134868,19004084,19134513,21091532,21081766,21052338,21101425,21160449,19098298,1154350,44072706,44087988,19027036,40865444,41209183,41021136,41177652,21170234,21081765,21072082,21042564,21052337,21042565,21160446,21062163,41146734,41302097,40865443,41146733,40958904,21081764,21150497,21091531,21101424,21022902,21120937,21022901,19027035,41184003,41058635,41215324,40933927,41152972,44111345,44075126,44111344,44101005,19048068,44085586,44113846,40840579,41058637,41226705,41121443,41070191,40996442,41320010,19000910,42931117,19027034,41277207,40871707,41257558,40871708,40821895,40840578,41164323,41152973,40871711,40933928,41058636,41246327,40871710,41027461,41184004,41215325,40871709,19000908,44049382,41246326,40840577,41058634,41152971,41215323,36886778,41240132,43729033,40840562,40840561,43675413,19017862,40965125,41058630,40976483,41183997,40945522,41308370,41070190,41052332,41021133,41083935,21022898,41121434,41183996,41257555,41246320,40976482,41152968,40945521,41121433,41058629,41070189,41090219,41132970,42931125,21052336,21150495,21130707,1154457,41115160,40896631,41288603,41302095,40914163,41083936,41177651,40865442,41270999,41270998,41177650,41007830,21120935,21150496,21022899,21072080,41302094,21062161,21072079,41121442,40840576,41090223,40902742,41184002,40933926,41121439,41038895,41090221,40945524,41090220,40914161,40871705,41246323,40933925,41121438,40933924,41058632,40871704,41277205,41183999,40902741,41121436,19004085,40965126,41308371,41038894,41246321,41101642,41215320,40902740,40945523,19134512,21120936,21130709,21062162,40723757,21170233,21111257,21130708,40723758,21022900,1154537,19101859,40896632,41146732,41288602,41083937,40914162,41302093,41209182,41115159,41021135,41052333,41021134,40945525,40990150,41121441,41215322,40902743,41246324,41121440,41090222,41152970,41257556,40965129,41288601,41027459,41257557,41184001,41184000,41027458,41058633,41246322,40965127,41215321,41308372,41121437,41183998,40965128,41152969,41058631,41038893,40871703,41007829,40902739,41121435,41288600,36891718,43837201,43621016,40006790,40006960,40831442,40987343,41112322,42931139,40006962,41081081,40142702,40956108,40824815,40006963,43693105,40006908,40006964,40145234,40006994,41299317,41081079,41081078,40831440,44172123,43036311,41237316,41206452,41174863,41081077,40956107,40006995,41206451,40006996,42480424,587720,44042715,36782817,36782816,44186991,44172188,40145235,40006797,41079955,41049632,40104188,40987342,40145307,44043678,44069556,40145308,21072074,40831441,40082688,40145309,35162019,40145310,40006997,44069555,40006998,40006999,41143900,44095364,44121270,40007000,44056679,40956110,40007001,43161455,42931138,42931137,40007002,40987344,40956109,35132619,40007003,41206453,35154239,35145519,42482229,43172436,43194367,43161454,42480425,42966570,42966574,42966576,42966582,42966583,42966571,42966575,42966578,42966579,42966580,42966584,42966572,42966581,42966573,19060435,41213202,41025299,41131383,40850386,41193981,40974870,41318366,42966600,42966601,42966603,42966604,42966602,42966599,19097829,41056486,41025298,40962973,41088007,41068580,41131382,40950503,41169414,41325126,41255973,41106868,40888390,41231874,41225051,41287035,41262621,41193980,40850385,40888388,40888389,41131381,40950502,43639770,19063136,19097830,19128694,19097841,41088008,41318365,41318364,40008351,41020252,36421458,41020251,42966617,42966621,42966623,42966629,42966630,42966618,42966622,42966624,42966625,42966627,42966631,42966619,42966628,42966620,40008352,42966612,42966613,42966615,41301191,42966616,42966614,42966611,36421457,40833418,40838029,41243802,41305807,41286373,40974247,41224348,41080475,40824208,19004167,42968741,42968740,21061333,41255349,40950223,41231567,41169134,41137970,41293498,41324852,40888087,41075104,41231566,41137969,41036662,41130743,40888088,40950225,41324855,41231568,41169135,41200525,41075108,21080951,21090671,21031815,40748903,21159638,40748904,21100631,41067896,40943261,41075107,41075106,40981328,40950224,41043735,40856766,41075105,41200524,41324854,41324853,21169409,21129930,40748905,21022087,42968742,42968739,42968743,41056123,40869133,40838016,21139841,21120149,41305798,40900201,43160548,43182450,43138413,19004168,21071251,21159637,21129928,21080950,40749530,21022086,21100630,40749531,21120148,21169408,21159636,43204399,43215271,43215272,40096077,42968751,42968750,21149700,42968752,42968749,42968753,43138412,19030497,41254914,41317273,41098951,41024613,41212561,19106262,40880543,41005203,40918790,41036249,41324674,40849331,41036248,41324673,41024614,40993642,41055862,41274401,40016511,41113957,40016512,41238968,41243265,41118379,41212310,40910973,41129759,41066902,41274130,41055586,41243264,41055587,41118378,41129758,41098386,41043269,40910972,40848795,41066901,41261861,41080361,40988907,40924212,41238861,42943285,42943286,19097826,40868304,43676034,43621651,43676035,41003943,41222724,40941579,19105906,40961801,41284684,40824042,41118070,40993050,40910278,41160504,19097827,19106183,40961802,41024005,41273834,35160104,41284685,41253668,41042960,40848117,41253667,41105738,35150698,35150262,35161643,19097843,19097825,41304928,41304929,41212016,41242954,41118071,40879248,41284687,41168342,41160506,41284686,40855985,41315966,41261552,43801560,40941580,41137163,41261551,41261550,40918190,41042962,41074332,41042961,41066193,41042963,40855984,40887343,40879247,41160505,41137162,41137164,41230844,41199738,40887342,43621650,36882978,41180618,43585621,41315965,40910279,43729631,42800513,42800514,35155079,35150027,40030511,43639769,40832835,42800605,42943288,42943289,40030512,40957449,43693752,35133214,43657854,43801529,43783654,43693730,43603678,43676007,35156309,35146511,40867397,41282810,40908458,41242072,43764440,41211173,41023102,43602572,41251940,41282811,40970743,41002119,41242074,41314105,40939703,41304070,41117167,40867398,40898509,40836324,40929610,41064346,41220951,40939702,40970741,40970742,43836754,43764439,43764438,43656805,43782572,43620586,19128804,19054035,40939704,40877453,41064350,41085948,41148647,35133246,36881048,43656806,43764442,43800447,43764441,43800446,43854661,43656807,19053980,44125328,41314109,41198815,41158617,41229880,41220956,40908463,41229879,44102313,40929617,41085952,41272968,40929616,42937993,35130334,35136052,35156717,35142311,19106680,41242079,41179735,41179734,41033192,41033191,41167434,41229881,40846327,41064353,41167433,41229882,43764437,40925793,43836752,43638697,43728594,43854660,40038055,43746510,41207374,35141358,40038056,44095886,42937995,41113280,35152462,35154472,35134996,35133658,19107695,41085676,40867097,40898223,40898222,40907700,41251236,41001362,41322778,40907699,40907698,40970069,41001361,41220223,1236755,41303801,40907701,41282112,40045268,41238165,40045269,41144734,41238166,19062439,41054037,41116803,41032354,41220097,41157778,19064837,19129005,19068990,40960589,41095079,41157779,40821300,19062436,19106169,40048180,40863445,40146814,40048181,40988145,40048182,19000919,19024175,41148004,41000399,40938051,41198074,40844578,40906684,40991487,41303409,41303408,40049960,40049961,40955161,40987990,19107322,40102262,19004163,19004161,41059679,19107586,40990450,40927906,40865722,40966142,41122416,41091291,41133612,41091290,19128995,19128779,19004164,19004162,19107532,41052644,41271294,41052645,40997475,41091292,40946155,41216304,40852615,41216303,41039571,40100441,40100442,41206593,40148130,40148131,40100443,40831571,35138683,35137560,35161593,35152702,35137473,35135857,35154979,19028988,35158908,35158577,35150456,42941596,19028982,35158151,35145502,35149524,35156119,35153348,35135627,35146967,35141671,42941601,19028983,41021291,40959083,41021292,40959084,41240305,35151447,35146001,35142199,35142807,35150466,35143077,35133472,35143525,41184691,41153665,41059411,40852428,41122138,40914607,41309097,41090993,40852429,35153443,19107216,41084101,41177838,40834486,40865618,41177839,41059412,40872415,41216010,40965825,40841257,40934662,41257982,35145527,35131907,35137157,40147160,35132629,35138517,35134129,40074679,35150332,35129989,35147635,42941605,40924967,35148771,35155811,35134951,35149458,43765500,43621599,43765502,43729595,43621600,43783652,43855751,43603677,43855752,43693729,43711631,43711630,43639736,43765501,19104361,43729594,41021208,40821098,43819642,40958996,40958995,40896707,41021209,43855750,43603674,41153329,41059029,43747546,41121794,41277537,40903093,41215656,19000915,41084005,40958994,40865528,40896706,19000913,41121793,41090592,41027819,40903092,41090593,41288861,19129138,19129095,40098728,43711628,43769283,43639735,43585592,40148060,40148061,40098729,40098730,41268368,43279459,43257704,40896361,40989872,40933227,40964443,41146456,41020851,41152314,41245607,41020854,41052056,41276580,40964442,35159535,35157138,35161451,40927344,40964439,21164324,21056239,21164323,21134692,21124765,21174108,35758092,43620428,43746346,42620819,43746347,43584403,36894809,43257703,36880386,43268593,35152660,35161356,42478940,21046486,21144580,21095482,42480129,21134693,21056240,40995731,41276575,40976078,41152311,41069749,41026791,40902025,40871012,41038480,41089502,40976077,41114848,41114847,41208888,40865160,41052053,41146454,41208887,41146453,41089501,40964438,41163899,41038478,41257128,40882815,41195222,41038477,40976076,41132551,41120720,41152310,40871011,41057937,41132554,41226291,41132553,40945096,41007419,41132552,41288180,41038479,44113591,41026790,40933223,41038476,40839870,41132550,41152309,41101241,41120719,41026789,41007418,41245605,40851538,40839869,41163898,41307655,40964437,40976075,41226290,43728436,41214683,41183350,40976073,41183351,40976074,43710417,41214682,41245604,40851537,41152308,41195221,41214681,41152307,40964436,40933222,41007417,41276574,41183349,41288179,41214680,35134524,35161861,35141302,19134673,41301759,40896359,40865159,41239845,41183347,41026788,40995728,41319621,40871008,41288178,40902024,41069748,19134693,35774951,35771012,35745882,35767532,35767533,21066065,41020850,43215080,41146455,43138189,21164325,41152313,21026817,40839871,41007420,43034851,43034852,21115164,43138190,43160357,43215081,43204225,43215082,19103879,40871018,40995735,41069752,41245610,41069753,41120726,41195226,41057944,41152317,40851541,41276579,41288183,41270712,40865161,41163901,40834060,40834059,41146457,41083638,40851542,41026796,41276578,40882817,41214686,41069751,40964441,41195225,41089508,40839873,41195224,40871017,40945097,40933226,40913780,40995734,41152316,41026795,41026794,40995733,41089507,41307659,41057943,41132555,41257131,41120725,41007424,40913779,40964440,41038482,41288182,43602426,41307658,40871016,41069750,41057941,41038481,43656645,41089506,41089505,41007423,41120724,41195223,41120723,41152315,40882816,40871014,40976079,40902029,41245609,40976080,40839872,41288181,40871015,41226292,41057940,41245608,41007421,40902028,41007422,41307657,40902027,41120722,41257130,41276577,41026793,40851540,40995732,41089503,40902026,41163900,41089504,40851539,41307656,40823959,41214684,41319622,41057939,40933224,41026792,41257129,21095483,43692504,43854513,21036611,21105348,21076008,21056241,41114850,41239846,41114849,41270713,40839874,40871019,40995736,41319625,41319624,41257132,41319623,41069754,41226293,41245611,41069755,41163902,41288184,41319626,41038483,40913781,40085736,40862540,40862539,40924745,40987220,40823562,41206322,41112199,41206321,41206320,40893721,41299180,40955972,41206319,41268193,40893720,40085737,35770450,43638537,21076006,40085743,42620440,1593776,36893552,35150077,40085746,40147371,21056237,40085747,41018199,40955973,40085748,40085749,43149130,41174734,41018198,40924746,41112200,41143773,41018197,41174733,42480128,42479537,40163427,19128603,40163431,1593777,40163441,40163442,40163443,40163449,40163450,40163451,40163455,40085383,40831315,35155201,35135874,35147998,35141838,35148185,35139844,35138194,35151091,35158347,35155286,35129682,35138160,35142013,35156905,35157058,35150637,35151072,35156579,35155933,35139285,35144075,40989695,40839392,40870525,40896171,41120225,41182874,19043194,41120224,40870524,41214188,41114661,41177186,41270504,40870523,40901592,41182873,19043192,35135683,35153936,35150120,35139235,19043193,40870522,41088993,41151801,41088992,41245129,41146250,41208696,40896170,41146251,41151800,41245128,40975791,41214187,41088991,41225987,40870521,40851273,40100370,40924684,40955907,40100371,40955908,35154593,40831240,35144817,35132439,35146710,35160907)

) I
) C UNION ALL 
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (35136989,35160455,35142553,35155727,35135940,35148898,35160834,35136697,35134199,35130548,35139606,35159929,35156103,35130812,35130475,35134005,35158985,35153633,35138212,42918161,42918162,43297914,43265307,41419937,41416752,41421087,41418935,41418047,41414774,41423558,41419247,41421379,41417012,43865930,41423524,43865931,43793455,43829580,43667895,43739631,41422164,41415271,41419215,41420956,41423066,41416137,41419014,41418305,41418686,41423810,41417211,41420901,41425172,41422102,41427156,41415713,41426697,41425913,41426978,41425350,41416295,21039807,41425038,21069362,41419370,21118286,41421607,41413824,41413913,41422797,41420200,41426184,35143687,35155515,35138321,35134553,35150536,35148731,43789878,43844182,43646226,43826106,43772059,43700252,41370501,41367433,41361813,41365517,41370287,41369732,41361471,41365518,41362598,41365877,41370460,41372709,41361175,41367394,41368458,41371535,41365458,41368457,41367197,41373056,41373294,43682183,43682184,43862306,43682185,43862307,43664347,43826051,43646176,43844131,41370442,41370441,41372687,41371505,41364699,41363245,43592124,43862383,43808008,43682251,43736165,43772082,43682250,43772083,43717994,43628140,43789901,43610069,43844201,43826119,43736166,43664415,43682252,43736167,43844200,43808007,43772081,43826118,43700267,43789898,43844199,43754029,43789899,43772078,43862381,43772076,43772077,43664414,1154576,1154620,1154379,40171426,1154577,1154378,40171427,19107332,19103785,40166145,21118349,36778415,21088881,21049671,21167590,21088882,21137964,21098778,21137965,21157798,36778414,36778413,21177329,36281731,41428947,41430089,41430088,41430155,41428988,41428987,41428933,41429879,41429570,41430002,41429914,41429145,41430355,41428946,41429288,41428986,41429569,35782781,35782780,21068580,21078332,35139690,35150307,41334883,43038844,43038845,36277712,41333519,43038843,41330373,41337072,41335399,43038848,43038849,43038850,35776273,36277678,36277992,35776829,35776697,43038846,43038847,35776964,43258720,43258719,21096839,43174652,43038851,21057605,43207398,43141435,43163651,43185499,43174653,43152532,43174654,21136052,21116442,21028168,43152533,43174655,21037969,41330809,41327417,41334406,41331018,43680277,43751987,43680278,35130230,35148540,35142444,43842132,43608046,43698216,35137271,35152263,43770097,43626135,43608146,43662272,41332237,41332904,43607975,41333208,41334553,41335914,41333423,41331146,41335481,43751924,35150574,35157221,35135906,35146896,35142129,35159356,35136723,35133935,35152841,35150816,35161496,35161478,35130267,35152891,35158414,35137163,43787959,43770084,41337540,41333521,43806013,41334887,41333520,41332835,41332155,43824134,43752054,41331692,43662415,41332375,43662414,41329042,41335079,41333350,41334708,41337074,41337073,43770085,43842065,43607966,43860274,43715920,43680219,43860275,43769943,43680218,43842066,43285965,43285966,43258724,43285967,35150922,35135405,21107052,43174629,21166033,21048159,43163626,43174630,21087382,21116807,21097206,40163433,35137439,35155999,35139177,35130138,41432250,41434655,41433897,41435387,41381251,41380416,41376823,41381007,41380351,43592665,41380849,41381394,41379039,41381546,43826659,43700886,41378494,41380597,41378652,43736710,43704673,41438475,43830583,43812573,41437853,41436028,41438417,41437561,41438730,41437089,41436981,41436646,41437023,41437461,41437090,41437460,41438467,41437358,41431130,41431561,41431617,41431702,41431540,41431017,41431541,41431454,41431309,41431478,41431270,41431432,41431636,41431498,41431326,41431882,41431216,41431796,41431701,41431382,41431269,41431239,41431735,41431734,41431453,41431149,41431495,41431148,41431497,41431496,41431781,41431020,44198992,44198964,44198931,44199007,44198921,44198997,41431039,41431268,41431954,41431828,41431655,41431539,41431923,41431794,41431523,41431366,41431128,41431558,41431214,41338891,41341503,41340725,41341737,41439443,41439380,41439333,41439144,41439115,41439157,41439094,41439348,41439627,21167774,41439286,21098977,41439317,21128297,21089061,21098976,21089060,21177516,21158000,41385002,41385306,41387576,41386044,41385151,41387157,41385221,41388161,41386166,41386037,41389427,41389495,43629164,41387048,43827020,41388290,41388847,43845135,43611021,43683227,43614720,43848792,43740790,43614721,43632873,43596756,43722670,43867004,43596755,42918424,42918425,41393419,41400917,41395744,41390656,41400109,35784434,35784083,35784048,35784615,21039361,21098233,21058936,21127568,41392065,41400916,41397702,41397701,41394733,43755600,41396778,43755601,43701821,43611600,41398405,41393021,41396685,41396393,43593620,43665933,43719488,43809561,43827600,43863915,41392064,41390993,41393715,41391282,41392649,41391395,43629712,41395478,41392343,41395743,43755602,44131560,44131482,44130315,44130164,589200,586995,41359293,41353329,41359978,41353497,41357629,784492,35780533,43040676,43040677,41355990,41359977,41359976,41353201,43040678,43040679,43040680,35780059,784493,35780215,35781002,784494,43275360,35781340,589988,21068247,21176183,43275359,36278802,36278912,36780461,36780460,36780459,36780458,36895426,36895350,43040681,43040682,43196909,43218831,43164028,43196910,43196911,43164029,43218832,43152975,43152976,43185929,35780710,35780875,35780050,35780049,35781095,35780774,21087862,21048640,21127025,21097683,21156739,21078125,19104814,40927621,41083930,40965110,41152958,19060644,19027037,19004086,44045261,19101538,35770835,42480427,21101422,40958901,40990144,40965106,41183984,41052323,40958897,40933907,41183976,41177653,41302098,40933930,40933929,1154654,36782814,21042572,21032659,21052340,21140661,21042571,19128414,44111353,44087994,44033851,44075128,19128415,21150502,21062168,19128416,35138382,19128417,36782813,21062167,41209180,41052326,41090207,41246311,1154351,41277216,40933934,41271004,41240139,36274884,44071119,41146735,43036321,41177656,41083939,40840587,40902750,40871719,41277215,40902749,41184012,43036323,43036324,41246331,41277214,41308380,41215336,41184011,41308379,19027038,40996451,41058645,40996450,40996449,40902748,19004087,36259962,35754633,44126988,43036322,36882905,43279283,44058227,44062399,42480991,43194374,21072083,43172443,43150280,43172444,43139338,43150281,42480992,21111260,43161461,41083934,40865441,41052331,44173039,44176809,41027457,41152967,44188013,44180493,41058626,40996441,41083929,40958898,40965104,41277181,41177642,40990145,40965109,41183987,36883895,41177643,43639179,43729018,43729019,41090206,41308358,41308357,43657251,43639181,19061106,783976,35762423,40927617,44032257,44049389,41152950,40840554,43036318,43036319,19027039,41183979,41246304,19004088,783977,35771374,44059883,44113847,42483387,21072077,43262896,590017,587738,36782811,36782810,36782809,36782808,1154581,40996424,41121414,41209177,19000911,36886777,36882903,36892711,43172440,43194371,43150277,43161458,43139336,43194372,35130198,35129472,35154658,1154349,44072710,44036266,19027033,40896628,41083933,41021128,41177644,40865435,21150493,21062160,21101421,21150494,21022897,21032658,21160445,21091529,43216224,41240136,40990146,40825151,41052329,41270995,21160444,21101420,21120934,21150492,21150491,21150489,35159832,21150490,19027032,44098512,44075127,44111351,44049388,1154376,44046872,44087992,40822405,40996435,40976479,41090211,41195639,41308362,40976480,19000909,43172446,43183361,43216225,42931127,19027031,40965117,41058619,40965116,40871697,40965115,41121423,40933917,40840567,41183990,41277190,41183989,35143651,19000907,36272721,36271417,19128692,44085589,44087995,19017861,21091530,42931118,21111258,21072081,21101423,19072360,35758219,35744340,35756902,35769392,35765170,35752692,35769393,35769391,21130710,21062164,21160448,21150498,35765171,35756903,35773765,35769394,35773764,21160447,35752693,21022903,19134868,19004084,19134513,21091532,21081766,21052338,21101425,21160449,19098298,1154350,44072706,44087988,19027036,40865444,41209183,41021136,41177652,21170234,21081765,21072082,21042564,21052337,21042565,21160446,21062163,41146734,41302097,40865443,41146733,40958904,21081764,21150497,21091531,21101424,21022902,21120937,21022901,19027035,41184003,41058635,41215324,40933927,41152972,44111345,44075126,44111344,44101005,19048068,44085586,44113846,40840579,41058637,41226705,41121443,41070191,40996442,41320010,19000910,42931117,19027034,41277207,40871707,41257558,40871708,40821895,40840578,41164323,41152973,40871711,40933928,41058636,41246327,40871710,41027461,41184004,41215325,40871709,19000908,44049382,41246326,40840577,41058634,41152971,41215323,36886778,41240132,43729033,40840562,40840561,43675413,19017862,40965125,41058630,40976483,41183997,40945522,41308370,41070190,41052332,41021133,41083935,21022898,41121434,41183996,41257555,41246320,40976482,41152968,40945521,41121433,41058629,41070189,41090219,41132970,42931125,21052336,21150495,21130707,1154457,41115160,40896631,41288603,41302095,40914163,41083936,41177651,40865442,41270999,41270998,41177650,41007830,21120935,21150496,21022899,21072080,41302094,21062161,21072079,41121442,40840576,41090223,40902742,41184002,40933926,41121439,41038895,41090221,40945524,41090220,40914161,40871705,41246323,40933925,41121438,40933924,41058632,40871704,41277205,41183999,40902741,41121436,19004085,40965126,41308371,41038894,41246321,41101642,41215320,40902740,40945523,19134512,21120936,21130709,21062162,40723757,21170233,21111257,21130708,40723758,21022900,1154537,19101859,40896632,41146732,41288602,41083937,40914162,41302093,41209182,41115159,41021135,41052333,41021134,40945525,40990150,41121441,41215322,40902743,41246324,41121440,41090222,41152970,41257556,40965129,41288601,41027459,41257557,41184001,41184000,41027458,41058633,41246322,40965127,41215321,41308372,41121437,41183998,40965128,41152969,41058631,41038893,40871703,41007829,40902739,41121435,41288600,36891718,43837201,43621016,40006960,40831442,40987343,41112322,42931139,40006962,41081081,40142702,40956108,40824815,40006963,43693105,40006908,40006964,40006994,41299317,41081079,41081078,40831440,44172123,43036311,41237316,41206452,41174863,41081077,40956107,40006995,41206451,40006996,42480424,587720,44042715,36782817,36782816,41079955,41049632,40104188,40987342,40145307,44043678,44069556,40145308,21072074,40831441,40082688,40145309,35162019,40145310,40006997,44069555,40006998,40006999,41143900,44095364,44121270,40007000,44056679,40956110,40007001,43161455,42931138,42931137,40007002,40987344,40956109,35132619,40007003,41206453,35154239,35145519,42482229,43172436,43194367,43161454,42480425,19004167,42968741,42968740,21061333,41255349,40950223,41231567,41169134,41137970,41293498,41324852,40888087,41075104,41231566,41137969,41036662,41130743,40888088,40950225,41324855,41231568,41169135,41200525,41075108,21080951,21090671,21031815,40748903,21159638,40748904,21100631,41067896,40943261,41075107,41075106,40981328,40950224,41043735,40856766,41075105,41200524,41324854,41324853,21169409,21129930,40748905,21022087,42968742,42968739,42968743,41056123,40869133,40838016,21139841,21120149,41305798,40900201,43160548,43182450,43138413,19004168,21071251,21159637,21129928,21080950,40749530,21022086,21100630,40749531,21120148,21169408,21159636,43204399,43215271,43215272,40096077,42968751,42968750,21149700,42968752,42968749,42968753,43138412,41243265,41118379,41212310,40910973,41129759,41066902,41274130,41055586,41243264,41055587,41118378,41129758,41098386,41043269,40910972,40848795,41066901,41261861,41080361,40988907,40924212,41238861,42943285,42943286,19097826,40868304,43676034,43621651,43676035,41003943,41222724,40941579,19105906,40961801,41284684,40824042,41118070,40993050,40910278,41160504,19097827,19106183,40961802,41024005,41273834,35160104,41284685,41253668,41042960,40848117,41253667,41105738,35150698,35150262,35161643,19097843,19097825,41304928,41304929,41212016,41242954,41118071,40879248,41284687,41168342,41160506,41284686,40855985,41315966,41261552,43801560,40941580,41137163,41261551,41261550,40918190,41042962,41074332,41042961,41066193,41042963,40855984,40887343,40879247,41160505,41137162,41137164,41230844,41199738,40887342,43621650,36882978,41180618,43585621,41315965,40910279,43729631,42800513,42800514,35155079,35150027,40030511,43639769,40832835,42800605,42943288,42943289,40030512,40957449,43693752,35133214,35156309,35146511,40867397,41282810,40908458,41242072,43764440,41211173,41023102,43602572,41251940,41282811,40970743,41002119,41242074,41314105,40939703,41304070,41117167,40867398,40898509,40836324,40929610,41064346,41220951,40939702,40970741,40970742,43836754,43764439,43764438,43656805,43782572,43620586,19128804,19054035,40939704,40877453,41064350,41085948,41148647,35133246,36881048,43656806,43764442,43800447,43764441,43800446,19053980,44125328,41314109,41198815,41158617,41229880,41220956,40908463,41229879,44102313,40929617,41085952,41272968,40929616,42937993,35130334,35136052,35156717,35142311,19106680,41242079,41179735,41179734,41033192,41033191,41167434,41229881,40846327,41064353,41167433,41229882,43764437,40925793,43836752,43638697,40038055,43746510,41207374,35141358,40038056,44095886,42937995,41113280,35152462,35154472,35134996,35133658,19062439,41054037,41116803,41032354,41220097,41157778,19064837,19129005,19068990,40960589,41095079,41157779,40821300,19062436,19106169,40048180,40863445,40146814,40048181,40988145,40048182,19000919,19024175,41148004,41000399,40938051,41198074,40844578,40906684,40991487,41303409,41303408,40049960,40049961,40955161,40987990,19004163,19004161,41059679,19107586,40990450,40927906,40865722,40966142,41122416,41091291,41133612,41091290,19128995,19128779,19004164,19004162,19107532,41052644,41271294,41052645,40997475,41091292,40946155,41216304,40852615,41216303,41039571,40100441,40100442,41206593,40148130,40148131,40100443,40831571,35138683,35137560,35161593,35152702,35137473,35135857,35154979,19028988,35158908,35158577,35150456,42941596,19028982,35158151,35145502,35149524,35156119,35153348,35135627,35146967,35141671,42941601,19028983,41021291,40959083,41021292,40959084,41240305,35151447,35146001,35142199,35142807,35150466,35143077,35133472,35143525,41184691,41153665,41059411,40852428,41122138,40914607,41309097,41090993,40852429,35153443,19107216,41084101,41177838,40834486,40865618,41177839,41059412,40872415,41216010,40965825,40841257,40934662,41257982,35145527,35131907,35137157,40147160,35132629,35138517,35134129,40074679,35150332,35129989,35147635,42941605,40924967,35148771,35155811,35134951,35149458,43765500,43621599,43765502,43729595,43621600,43783652,43855751,43603677,43855752,43693729,43711631,43711630,43639736,43765501,19104361,43729594,41021208,40821098,43819642,40958996,40958995,40896707,41021209,43855750,43603674,41153329,41059029,43747546,41121794,41277537,40903093,41215656,19000915,41084005,40958994,40865528,40896706,19000913,41121793,41090592,41027819,40903092,41090593,41288861,19129138,19129095,40098728,43711628,43769283,43639735,43585592,40148060,40148061,40098729,40098730,41268368,43279459,43257704,40896361,40989872,40933227,40964443,41146456,41020851,41152314,41245607,41020854,41052056,41276580,40964442,35159535,35157138,35161451,40927344,40964439,21164324,21056239,21164323,21134692,21124765,21174108,35758092,43620428,43746346,42620819,43746347,43584403,36894809,43257703,36880386,43268593,35152660,35161356,42478940,21046486,21144580,21095482,42480129,21134693,21056240,40995731,41276575,40976078,41152311,41069749,41026791,40902025,40871012,41038480,41089502,40976077,41114848,41114847,41208888,40865160,41052053,41146454,41208887,41146453,41089501,40964438,41163899,41038478,41257128,40882815,41195222,41038477,40976076,41132551,41120720,41152310,40871011,41057937,41132554,41226291,41132553,40945096,41007419,41132552,41288180,41038479,44113591,41026790,40933223,41038476,40839870,41132550,41152309,41101241,41120719,41026789,41007418,41245605,40851538,40839869,41163898,41307655,40964437,40976075,41226290,43728436,41214683,41183350,40976073,41183351,40976074,43710417,41214682,41245604,40851537,41152308,41195221,41214681,41152307,40964436,40933222,41007417,41276574,41183349,41288179,41214680,35134524,35161861,35141302,19134693,35774951,35771012,35745882,35767532,35767533,21066065,41020850,43215080,41146455,43138189,21164325,41152313,21026817,40839871,41007420,43034851,43034852,21115164,43138190,43160357,43215081,43204225,43215082,19103879,40871018,40995735,41069752,41245610,41069753,41120726,41195226,41057944,41152317,40851541,41276579,41288183,41270712,40865161,41163901,40834060,40834059,41146457,41083638,40851542,41026796,41276578,40882817,41214686,41069751,40964441,41195225,41089508,40839873,41195224,40871017,40945097,40933226,40913780,40995734,41152316,41026795,41026794,40995733,41089507,41307659,41057943,41132555,41257131,41120725,41007424,40913779,40964440,41038482,41288182,43602426,41307658,40871016,41069750,41057941,41038481,43656645,41089506,41089505,41007423,41120724,41195223,41120723,41152315,40882816,40871014,40976079,40902029,41245609,40976080,40839872,41288181,40871015,41226292,41057940,41245608,41007421,40902028,41007422,41307657,40902027,41120722,41257130,41276577,41026793,40851540,40995732,41089503,40902026,41163900,41089504,40851539,41307656,40823959,41214684,41319622,41057939,40933224,41026792,41257129,21095483,43692504,43854513,21036611,21105348,21076008,21056241,41114850,41239846,41114849,41270713,40839874,40871019,40995736,41319625,41319624,41257132,41319623,41069754,41226293,41245611,41069755,41163902,41288184,41319626,41038483,40913781,40085736,40862540,40862539,40924745,40987220,40823562,41206322,41112199,41206321,41206320,40893721,41299180,40955972,41206319,41268193,40893720,40085737,35770450,43638537,21076006,40085743,42620440,1593776,36893552,35150077,40085746,40147371,21056237,40085747,41018199,40955973,40085748,40085749,43149130,41174734,41018198,40924746,41112200,41143773,41018197,41174733,42480128,42479537,40163427,19128603,40163431,1593777,40163441,40163442,40163443,40163449,40163450,40163451,40163455,35155201,35135874,35147998,35141838,35148185,35139844,35138194,35151091,35158347,35155286,35129682,35138160,35142013,35156905,35157058,35150637,35151072,35156579,35155933,35139285,35144075,40989695,40839392,40870525,40896171,41120225,41182874,19043194,41120224,40870524,41214188,41114661,41177186,41270504,40870523,40901592,41182873,19043192,35135683,35153936,35150120,35139235,19043193,40870522,41088993,41151801,41088992,41245129,41146250,41208696,40896170,41146251,41151800,41245128,40975791,41214187,41088991,41225987,40870521,40851273,40100370,40924684,40955907,40100371,40955908,35154593,40831240,35144817,35132439,35146710,35160907)

) I
) C
;

with primary_events (event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id) as
(
-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 1))
) C


-- End Drug Exposure Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events

)
SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM primary_events pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

with cteIncludedEvents(event_id, person_id, start_date, end_date, op_start_date, op_end_date, ordinal) as
(
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

)
select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM cteIncludedEvents Results

;

-- custom era strategy

with ctePersons(person_id) as (
	select distinct person_id from #included_events
)

select person_id, drug_exposure_start_date, drug_exposure_end_date
INTO #drugTarget
FROM (
	select de.PERSON_ID, DRUG_EXPOSURE_START_DATE, COALESCE(DRUG_EXPOSURE_END_DATE, DATEADD(day,DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,DRUG_EXPOSURE_START_DATE)) as DRUG_EXPOSURE_END_DATE 
	FROM @cdm_database_schema.DRUG_EXPOSURE de
	JOIN ctePersons p on de.person_id = p.person_id
	JOIN #Codesets cs on cs.codeset_id = 2 AND de.drug_concept_id = cs.concept_id

	UNION ALL

	select de.PERSON_ID, DRUG_EXPOSURE_START_DATE, COALESCE(DRUG_EXPOSURE_END_DATE, DATEADD(day,DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,DRUG_EXPOSURE_START_DATE)) as DRUG_EXPOSURE_END_DATE 
	FROM @cdm_database_schema.DRUG_EXPOSURE de
	JOIN ctePersons p on de.person_id = p.person_id
	JOIN #Codesets cs on cs.codeset_id = 2 AND de.drug_source_concept_id = cs.concept_id
) E
;

select et.event_id, et.person_id, ERAS.era_end_date as end_date
INTO #strategy_ends
from #included_events et
JOIN 
(
  select ENDS.person_id, min(drug_exposure_start_date) as era_start_date, DATEADD(day,0, ENDS.era_end_date) as era_end_date
  from
  (
    select de.person_id, de.drug_exposure_start_date, MIN(e.END_DATE) as era_end_date
    FROM #drugTarget DE
    JOIN 
    (
      --cteEndDates
      select PERSON_ID, DATEADD(day,-1 * 30,EVENT_DATE) as END_DATE -- unpad the end date by 30
      FROM
      (
				select PERSON_ID, EVENT_DATE, EVENT_TYPE, 
				MAX(START_ORDINAL) OVER (PARTITION BY PERSON_ID ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal,
				ROW_NUMBER() OVER (PARTITION BY PERSON_ID ORDER BY EVENT_DATE, EVENT_TYPE) AS OVERALL_ORD -- this re-numbers the inner UNION so all rows are numbered ordered by the event date
				from
				(
					-- select the start dates, assigning a row number to each
					Select PERSON_ID, DRUG_EXPOSURE_START_DATE AS EVENT_DATE, 0 as EVENT_TYPE, ROW_NUMBER() OVER (PARTITION BY PERSON_ID ORDER BY DRUG_EXPOSURE_START_DATE) as START_ORDINAL
					from #drugTarget D

					UNION ALL

					-- add the end dates with NULL as the row number, padding the end dates by 30 to allow a grace period for overlapping ranges.
					select PERSON_ID, DATEADD(day,30,DRUG_EXPOSURE_END_DATE), 1 as EVENT_TYPE, NULL
					FROM #drugTarget D
				) RAWDATA
      ) E
      WHERE 2 * E.START_ORDINAL - E.OVERALL_ORD = 0
    ) E on DE.PERSON_ID = E.PERSON_ID and E.END_DATE >= DE.DRUG_EXPOSURE_START_DATE
    GROUP BY de.person_id, de.drug_exposure_start_date
  ) ENDS
  GROUP BY ENDS.person_id, ENDS.era_end_date
) ERAS on ERAS.person_id = et.person_id 
WHERE et.start_date between ERAS.era_start_date and ERAS.era_end_date;

TRUNCATE TABLE #drugTarget;
DROP TABLE #drugTarget;


-- generate cohort periods into #final_cohort
with cohort_ends (event_id, person_id, end_date) as
(
	-- cohort exit dates
  -- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
UNION ALL
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

),
first_ends (person_id, start_date, end_date) as
(
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, E.end_date, row_number() over (partition by I.person_id, I.event_id order by E.end_date) as ordinal 
	  from #included_events I
	  join cohort_ends E on I.event_id = E.event_id and I.person_id = E.person_id and E.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
)
select person_id, start_date, end_date
INTO #cohort_rows
from first_ends;

with cteEndDates (person_id, end_date) AS -- the magic
(	
	SELECT
		person_id
		, DATEADD(day,-1 * 30, event_date)  as end_date
	FROM
	(
		SELECT
			person_id
			, event_date
			, event_type
			, MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal 
			, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type) AS overall_ord
		FROM
		(
			SELECT
				person_id
				, start_date AS event_date
				, -1 AS event_type
				, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
			FROM #cohort_rows
		
			UNION ALL
		

			SELECT
				person_id
				, DATEADD(day,30,end_date) as end_date
				, 1 AS event_type
				, NULL
			FROM #cohort_rows
		) RAWDATA
	) e
	WHERE (2 * e.start_ordinal) - e.overall_ord = 0
),
cteEnds (person_id, start_date, end_date) AS
(
	SELECT
		 c.person_id
		, c.start_date
		, MIN(e.end_date) AS end_date
	FROM #cohort_rows c
	JOIN cteEndDates e ON c.person_id = e.person_id AND e.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
)
select person_id, min(start_date) as start_date, end_date
into #final_cohort
from cteEnds
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;