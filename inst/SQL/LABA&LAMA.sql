CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (43633767,43615577,43651812,43759480,43687724,43777558,43831583,43651821,43741655,790206,790207,43868523,43670542,43706314,43796133,43760160,40711488,40711490,40711489,36778541,36778540,36778539,36778538,36778537,36778536,36778535,36778534,43043368,21050044,35421286,41522374,35421291,35421275,41522488,41522334,41522298,35421293,43043384,44217535,44217601,21109002,21050045,41522468,41522450,41522459,41522404,41522333,41522332,41522368,41522367,41522476,41522421,41522345,41522405,41522369,41522513,44217699,41522496,41522315,44217625,41522536,41522512,41522447,35421287,35421280,35421300,43043385,41522326,41522359,41522420,44217534,41522427,41522340,41522446,41522475,41522457,41522365,41522535,41522312,41522297,41522534,41522458,44217533,41522331,41522366,41522279,44217623,41522314,44217624,41522313,41522505,41522394,36414880,36778507,36283889,36414881,36414877,36283886,36778506,36778505,36283890,36283875,36283881,21079568,35421290,35421274,35421279,35421277,21050043,21138375,41522274,35421295,35421282,35421289,36283869,36778504,36778503,36283897,41522469,43043381,43043382,43043383,21030432,35421294,41522448,43043390,43043391,21118724,21167975,41522360,41522524,35421283,35421302,35421285,43043392,41522523,41522506,41522441,41522341,36414882,36778513,36414879,36414878,36283868,36778512,36778511,36283878,21138376,36778510,21079569,21050046,41522395,36283895,36778509,36778508,36283893,41522451,43043386,43043387,43043388,43043389,43276341,43297964,35421301,35421272,35421296,35421284,35421273,43043370,43043371,42708504,42708505,35421281,35421278,35421288,35421292,35421299,43043379,43043380,43043375,43043376,36778519,35421298,35421297,35421276,36778518,36778517,43043377,43043378,36778527,36778526,36778525,36778524,36778523,784985,784987,784989,784990,784991,784992,784993,43043372,43043373,42708508,42708509,43259909,43265353,21109004,21158204,41522388,21128505,41522495,21158205,21118726,44217598,41522445,21138380,21167980,44217676,21138381,21109005,41522266,41522305,41522310,44217621,44217531,41522444,41522510,41522403,44217697,44217530,41522532,41522309,41522509,21089257,21158206,41522304,21148233,41522308,41522344,41522456,44217580,21050049,41522508,21158207,41522277,21118727,21118728,21148232,41522422,41522436,41522435,36778552,41522462,41522301,36778551,41522338,41522363,41522430,41522306,36778550,41522399,41522491,44217524,40711497,40711496,40711501,40711500,40711499,40711498,21059879,21128503,36283898,21138374,21148228,784979,784980,784981,36778563,36778562,36778561,36778560,36778559,40711511,40711513,40711512,40711510,40711508,40711509,21089255,21108998,21177683,36283879,21050041,784968,784969,784970,41522461,41522425,41522464,41522317,41522329,44217575,41522433,41522376,44217537,44217632,36778544,44217682,36778543,36778542,44217549,40711503,40711502,40711507,40711506,40711505,40711504,35798410,35798414,36283873,35798431,35798424,784971,784972,784973,40711577,40711563,40711562,40711561,40711560,36778555,40711576,40711581,40711580,40711579,40711578,40711572,36778554,36778553,40711570,40711569,40711564,40711567,40711565,40711568,40711573,40711566,40711575,40711574,40711689,40711675,40711584,40711583,40711582,40711688,40711693,40711692,40711691,40711690,40711684,40711683,40711682,40711676,40711679,40711677,40711681,40711685,40711678,40711687,40711686,35798427,35798473,35798403,35798461,35798432,35798459,36283891,35798460,35798425,35798418,35798440,35798415,35798450,36809033,784959,784960,784961,784955,784957,784958,44217603,44217542,44217647,44217541,44217540,44217692,44217631,44217522,44217681,44217657,44217566,41522406,41522409,41522467,41522318,41522466,41522377,41522398,21167974,21069817,21089256,21109001,21030431,21128499,21109000,21128501,21158202,21099181,21040256,21138372,21050042,21108999,21138373,21099182,41522282,41522408,41522449,41522281,41522362,41522518,41522480,41522479,41522260,41522507,41522478,41522500,41522490,41522392,41522517,41522347,41522460,41522267,41522424,41522371,41522269,41522288,41522336,41522426,41522356,41522275,44217613,21158203,21099183,36283872,21128502,21167973,36778549,36778548,36778547,36778546,36778545,40711495,40711494,40711493,40711492,784974,784975,784976,784977,784978,40711532,40711517,40711516,40711515,40711514,36778558,40711531,40711536,40711535,40711534,40711533,40711526,36778557,36778556,40711524,40711523,40711518,40711521,40711519,40711522,40711527,40711525,40711520,40711530,40711529,40711528,40711555,40711540,40711539,40711538,40711537,40711554,40711559,40711558,40711557,40711556,40711549,40711547,40711546,40711541,40711544,40711542,40711545,40711550,40711548,40711543,40711553,40711552,40711551,21167968,21069815,21177682,21050039,21158201,21167969,36283870,21059878,21069816,21059877,21079567,21148227,21167970,21167971,21167972,36809032,784965,784966,784967,784962,784963,784964,41522265,41522482,41522465,41522515,41522417,44217523,41522287,41522286,41522452,41522384,44217548,44217669,41522481,41522520,41522525,44217547,41522519,41522434,41522397,44217592,41522355,41522502,41522370,41522497,41522268,41522501,40169218,40169219,40169232,40169233,40169236,40169237,42629523,42629527,1361703,1361704,42708510,42708511,42708512,42708513,43616242,43616243,43634458,43688414,43832356,43778269,43850368,43634457,43670568,43634456,43850369,43688415,43814263,43868557,43760188,43281706,43259899,43259897,43259898,792485,792490,43531861,45775246,46234368,46234370,40169242,40169243,40169244,40169245,40169246,40169247,44217804,44217806,44217805,41522591,41522593,41522592,41522594,41476532,41476543,41476537,41476534,41476528,41476519,41476544,41476518,43042435,43042436,43522400,43522403,43042433,43042434,43042427,43042428,43522401,43522399,43042425,43042426,43042431,43042432,43522402,43522404,43042429,43042430,40169202,40169203,40169206,40169207,40169208,40169209,46233856,46233860,36779316,36779315,36779314,36779313,36779312,36779311,36779310,36779309,43042501,43042502,43042500,40713914,40713913,40713912,40713911,36779308,36779307,40713910,40714389,40714388,40714387,36779306,36779305,36779304,36779303,40714385,40714386,43042505,43042506,21128469,35421234,21059836,21108975,21138338,35421237,35421231,21089236,21177667,36414719,36283791,36414700,36414713,36414714,36283776,36283780,36414717,36283784,36414718,41519872,41519874,44216645,44216643,43259903,43270828,21059834,21128467,21059835,21128468,21030407,21040231,36414710,36779302,36414696,40714384,36414712,36414698,36779301,36779300,36414709,36283775,36414702,43042503,43042504,43292539,43276329,44216636,44216641,41519879,41519880,792493,792494,43531871,45775248,46234373,46234374,35421239,35421238,35421233,36283782,36283786,36779295,36779294,36283779,36283787,36283781,36779296,36283790,43042509,43042510,43042507,43042508,21040232,21128470,21167940,21118701,36414707,36414697,36414708,36414699,40714383,44785540,44785541,43259902,43287171,44216648,44216637,41519875,41519876,44216656,41490030,41490024,41490025,41490029,41490033,41490032,41490026,41490027,41350941,41350873,41350892,41351222,41350987,41350676,41351081,41351045,43666068,43755728,43611730,43864062,43701956,43773760,43719630,43276333,36778929,36283819,43287175,36283843,36778928,36778927,36283842,36283851,36283840,21167955,21050026,44217179,21158188,41521465,44217103,35798223,40713457,35798253,35798271,41521561,41521601,44217047,44217102,41521536,44217076,44217178,43042921,43042922,43042923,42708514,42708515,42708516,42708517,44217078,44217085,44217059,44217127,41521497,41521575,41521540,41521464,41521533,35421264,35421263,35421266,35421251,35421256,43042929,43042930,43042924,43042925,35421261,35421259,35421254,35421257,43042926,43042928,43042927,21079555,44217140,44217101,41521478,44217248,41521505,44217075,44217132,44217074,41521494,44217131,41521493,44217058,21089245,21079556,41521594,44217247,21069799,21118714,44217130,21089246,44217129,21030418,21040243,44217155,44217163,41521496,41521535,41521485,44217245,41521456,21148210,21089240,21148213,21030414,21148212,21099166,21059853,21177670,21118711,36897495,43522467,36778974,43270835,36778973,36778972,35798236,35798290,35798340,36283816,35798291,35798263,40713510,40713511,35798262,35798342,35798341,21069794,21118710,21059852,21138347,21079549,21128480,21079548,21128481,36897492,43522466,36778980,40713515,40713514,43297958,36778979,36778978,35798237,35798292,35798308,36283836,35798293,35798275,40713512,40713513,35798343,35798264,784881,784883,784882,41521483,44217083,41521551,44217095,44217152,44217244,41521557,44217030,41521451,41521469,44217162,41521582,41521484,41521473,44217121,41521581,21138345,21138346,21050022,21099165,21138344,21050023,21158180,21079547,21069793,21138343,21059851,36897491,40713505,40713504,35798226,35798249,43522468,36778977,35798276,40713509,40713508,43281713,36778976,36778975,35798296,35798238,35798325,36283839,35798309,35798297,40713506,40713507,35798326,35798250,36810187,784878,784880,784879,41521542,41521455,41521462,41521468,41521564,41521539,41521516,44217042,41521579,44217151,44217120,41521472,44217219,41521448,44217029,44217119,44217187,44217243,41521522,44217082,41521563,44217150,41521556,44217242,44217118,44217201,44217070,41521507,40169262,40169263,1593840,1593842,1593825,1593830,40169275,40169276,40169269,40169270,1366746,1593834,1593836,40169279,40169280,40169281,40169282,1366747,40169285,40169286,1366748,46276021,46276022,46276023,46276024,40713497,40713495,40713494,21108988,36778968,36283829,21158190,36778967,36778966,36283811,36283837,21099170,36778965,36778964,36778963,46233863,40713493,40713492,46233864,44217050,44217158,44217111,43827848,43737847,43666140,43773840,43791614,43737846,43666139,43845897,43702029,43593847,43593846,43864145,43683962,43809768,43827846,43719719,43773841,43864146,43827847,44785544,44785545,43293569,36783453,36267546,43277372,36263377,36783452,36260808,21170512,21052645,21150788,44059521,40725609,35758722,35744200,41244423,40975208,41100372,41017134,41306433,41151031,41088219,40944259,41163043,40950628,41100374,41131696,40857185,41142667,40821761,41244424,40900856,40900855,41100373,41068898,40888500,40913007,41256307,41225382,41037666,41262741,40981763,21150787,41020362,21072356,44082127,43293568,41176892,41206083,41145957,40833532,42966588,42966590,42966595,42966596,42966585,42966589,42966591,42966592,42966593,42966598,42966586,42966594,42966587,41017030,41111099,42966606,42966607,42966609,42966610,42966608,42966605,40923601,40861325,40830146,43638203,43728093,43836226,43836227,43710082,43854191,43836225,40745349,40745351,40745350,36787952,36787951,36787950,36787948,36787947,36787946,40745352,21031160,35410561,41181401,40837974,35406946,35411609,41005569,21149021,21158945,41005568,41286313,41317634,35412399,35408504,41067845,40880920,40911948,41193265,41193264,40880919,36408230,36782838,36262335,36407708,36404118,36276086,36782837,36273483,21168749,35407460,35410825,35411608,21149020,21129302,41130718,35407724,35410040,36273484,36782836,41130717,43036257,43147133,43180285,41243757,40974193,41067847,43158331,43213065,43158332,43147132,41016876,36884970,43746015,43836231,43782069,43584050,43818064,43620097,43202246,43136227,41274601,43158333,43169206,43180286,41317635,40943214,43191166,43136228,43180287,41193267,41036626,43158330,43202245,43763953,41297792,21158947,35408246,40837975,43036261,21021442,21119499,41286315,41193266,35409295,35410041,41286314,40880921,41067846,40849697,43036258,36407525,36782842,36408416,36406425,36258164,36782841,21021441,36782840,21041056,21041057,40880922,36257031,36782839,40943213,43036259,43036260,43818059,36880215,43836229,43692179,43656299,43602094,43799957,43656300,36884029,35409034,41274602,43854192,41317636,43638204,35412400,35406947,35407842,43584048,43674444,43818061,40911949,43818062,35412728,43728095,43674443,21158944,35408943,21050841,40895572,43180284,40895571,40864407,41082854,36421291,36421290,40745353,40745354,36787954,36787953,36894458,36408839,43674441,43746013,43692178,21090035,43169205,21099959,43638202,43136226,43728092,43746012,43036256,43287626,43255057,43260402,42958513,42958503,43604286,43802100,43820227,35409041,35412138,35408530,35408529,43029018,35412738,42903191,42903396,42706341,43190570,43135588,43157729,43201609,43212444,43179678,36787266,36787264,36787265,36787263,36787260,36787259,36787262,36787261,36787267,42958510,42958509,42958508,35407466,35408254,35408531,35409326,43029028,43029026,36786570,35406978,35406977,36786569,43029027,35411152,43029024,36786575,36786574,36786573,783230,783232,783233,783234,783235,43029025,35407291,42902748,42902433,42706348,43168614,43146495,43190569,43168615,43201606,43157725,43168616,43179677,43179676,43190568,43748117,43622185,43622184,43282195,43276882,43287625,21130988,44173925,21111548,21170511,21072353,21111550,21023169,21082055,21082056,40954545,44046132,41055841,41192840,44112768,44077264,41192839,40887880,41106343,40887879,40950041,41204859,36890841,43730191,43640343,41118617,40823311,40868879,41118616,40868880,40973763,41130314,40911508,41005149,41254851,41098895,40880484,40849293,41192838,41168942,41324648,41012425,41067444,43766088,41048082,44106771,36787257,36787255,36787256,36787254,36787251,36787250,36787253,36787252,36787258,21082057,41212537,44170190,41067442,21023171,21052644,41161675,21091828,21121239,21072354,21091827,21111551,21101703,41266698,44046131,41150103,41150104,41036194,41130313,40918765,41036193,40942778,41262116,41137745,41043536,40880485,44074078,44090165,41036192,41137744,41231378,41231377,41043535,40918764,40861016,40923299,36890839,43820226,43604285,41243527,40993602,40993601,41055840,41274371,41024588,40837767,41005147,41223872,41106342,41005146,41161679,41106341,41168941,41106340,41137743,41293284,41074899,40950040,40981142,41043534,40849292,41223871,41285874,41223874,41223873,41317214,41005148,41192837,41192836,41005145,40981141,40918763,41043532,41043531,41074898,41192835,41043533,41231376,43820225,41110830,44068203,35411345,35412935,35407754,35408533,43029022,43029020,35408532,35407753,43029021,43029019,43146496,43168617,43201608,43157726,43157727,43146497,43212442,43212443,43157728,43135586,43135587,43135585,43201607,43694335,43838317,43856334,21101704,44173926,41098894,21160732,44173924,21111553,21023173,21150785,21101705,21042840,21023172,21140948,41142269,40962334,40962333,40849291,41223870,41324647,41067443,41317213,41200322,41012424,41074897,41074896,41168939,41262115,41168940,41036191,40911507,40918762,41231375,41110829,40892265,36890840,43748116,43658468,41087325,41024587,41087323,41087324,40942777,41161678,41324646,41137742,40942776,41161677,41036190,41130312,40973762,40942775,41005144,41106339,40856571,41106338,43802099,41110828,42479684,41300900,44179736,44175958,44164667,44175957,41145535,43029017,43029015,44187197,42479079,44109187,43029016,35133500,783227,36810920,36811732,35132736,783228,783229,43029014,40142910,40142912,36787269,36787268,43749255,43695497,43695498,43839463,43767273,43713317,43785326,43821377,43605423,43641482,43839464,43605422,43803265,43767274,43839462,43713319,43821378,43605424,43713318,43803264,43713315,43623304,43587354,43587353,43713314,43749253,43659666,43857548,43857547,43749254,43695496,43785324,43641481,43605421,42956235,41235053,41148556,41032949,41064074,36790294,41211065,41189496,36790293,41064073,40754961,40754960,21040523,40754965,40754964,40754963,40754962,21060130,21030653,21118950,21020924,782493,782494,40754999,36790314,36790313,36790312,36790311,40754996,40754998,40754997,40754995,40754993,40754994,21168224,21158434,21128734,21128733,782485,782486,21079795,41078699,40992089,41313862,40970490,40836223,41220696,41313861,41016038,43857488,43180282,43169202,43695427,43641426,43191165,43136224,43136225,43169203,43767205,43181572,43170553,43181573,43170554,43181574,43159666,36880101,43677641,43022542,36790320,36790319,36790318,36790317,36790316,36790315,43022584,36790321,40755791,40755790,40755789,40755792,40754981,36790300,36790299,40754980,40754979,40754978,40754977,36790298,36790297,40754975,40754976,43022651,40754982,43022650,42956251,42956250,42956252,42935517,42956238,44171955,44187550,44184833,36790288,44188674,36790287,40754967,40754966,35749481,40754971,40754970,40754969,40754968,35754175,35750600,35749372,35753548,782487,782488,44171954,40755776,40755778,44161222,44181114,40755054,40755053,40755052,36790302,40755135,40755139,40755138,40755137,40755136,40755131,36790301,40755130,40755060,40755055,40755058,40755056,40755059,40755132,40755057,40755134,40755133,40755156,40755143,40755142,40755141,40755140,40755155,40755775,40755774,40755773,40755771,40755151,40755150,40755149,40755144,40755147,40755145,40755148,40755152,40755146,40755154,40755153,35749970,35770284,35761900,35761901,35761898,35770283,35761899,35757714,35774558,35749373,35746428,35745193,36813300,782473,782474,782470,782471,782472,40755777,35766099,35774668,44186941,44172596,44184831,44166173,44166172,44162351,44181113,44164424,44186940,44168231,44186939,44176314,44181112,44164423,41235052,41148555,41001844,41095640,41241992,41158351,41189495,21030654,21148486,21109269,21070063,21148487,21118944,21079796,21109266,21089503,21109267,21050283,21089504,21089502,21070060,21060129,21118945,21070061,21060128,21070059,40984920,41204081,41054281,41032946,40877141,41158348,41189492,41158347,41023001,40836222,41023000,40970489,41158346,41282552,41001840,41001839,41220695,41158345,41095637,41078698,41016037,41172551,41265915,41148552,40929524,41189487,41064070,41141470,40825101,44168873,44169891,41303973,41001843,41095639,41001842,41078701,41016042,21089508,35409795,21030656,21109271,21070064,35406945,21128736,21030657,36409023,36275012,36408723,36407245,36409222,36257878,36409528,36405675,21109270,42714019,42722550,588761,587341,42725750,41022997,40939440,44172595,44166170,40860303,43731260,43180283,43158328,43821327,43641427,43169204,43158329,43213064,43147131,43821328,44119241,43170557,43137547,43148470,43170558,43170559,44123365,44034618,44063664,43192528,43839461,36882039,43587355,43731331,43821376,43785325,43857549,43713316,43517092,21079798,21109268,21099418,21040522,21020922,21158436,21158437,21099417,21158438,36882934,43515301,36790304,43261143,36790303,35770286,35761902,35749374,35770285,35745194,40754991,40754992,35765980,35749375,35765979,21118948,43285713,43258479,43285712,44093312,43192524,44034617,44115052,43181575,43192525,43214429,41016035,40898410,41158342,40846024,41117066,41220693,41313856,40886224,41032945,41064071,41211063,41001833,40846023,41272846,40970488,41158341,41078696,40860305,44028596,44025757,44086375,44128214,41211061,41211060,40939439,41126893,41272845,41148550,40877140,40908157,41235051,42935520,41085864,41220698,40939443,41148557,41251675,40908161,21148485,21089506,21118949,21079799,42931193,36790292,36790291,36790290,36790289,40754959,40754958,40754957,40754956,782489,782490,782491,782492,42956225,44179471,40755044,40755046,44161223,44173639,40755002,40755001,40755000,36790308,40755016,40755020,40755019,40755018,40755017,40755011,36790307,40755009,40755008,40755003,40755006,40755004,40755007,40755012,40755010,40755005,40755015,40755014,40755013,40755039,40755024,40755023,40755022,40755021,40755038,40755043,40755042,40755041,40755040,40755033,40755031,40755030,40755025,40755028,40755026,40755029,40755034,40755032,40755027,40755037,40755036,40755035,21109264,21050281,21040520,21040521,21060126,21079794,21128732,21070058,21099414,21109265,21168222,21099415,21168223,21060127,36810912,782483,782484,782481,782482,40755045,21099413,21050280,41172552,41016041,41054282,41189494,41032948,40877144,41158350,41251674,40898413,41272849,41179644,41032947,41126897,41095638,41282553,41158349,41189493,41251673,41220697,40860308,40984921,41016040,41110099,40960864,41272848,40970491,40877143,40829024,42956231,42956230,42956232,43514632,21148484,21030652,21099416,21050284,21128735,21079797,21118946,21158435,782478,40755051,36891746,43517323,36790310,40755050,40755049,43288345,36790309,35770287,35749376,35749377,35749378,35745196,40755047,40755048,35757715,35742117,782479,782480,21138618,41141471,40836224,44184832,40939442,44169890,44179470,40992090,40846026,44162352,40908160,41001841,40877142,41016039,41078700,40922535,43587289,36884561,36885902,43605357,43857486,36883177,43857487,44028595,43203574,43170555,43181577,43192527,43203575,44032705,44047641,44063663,43214431,43803263,36882935,43677642,43785322,43857546,43677643,43695495,43641480,44041552,43170556,44099361,44076321,43159667,43022645,43022642,43022643,43022644,43137546,43159668,43159669,43022641,43203576,41047312,40898411,41001837,41095632,40929525,41313858,41095631,41220694,41251670,41260533,40917130,41198678,40829023,41022999,41117067,41303972,41313857,41001836,41001835,41158343,41001834,41198677,41260532,41189488,41282550,40953754,41296982,41078697,21030655,21020926,21040524,21040525,21089507,21020927,36404433,36790296,36406450,40754974,36407985,36405404,36790295,36406449,36404920,43022648,21020925,43022647,43296484,43280251,43263900,589342,588815,42727420,42726565,42712427,44176312,44177395,40992088,40877138,41265913,44054636,44110200,44112132,44063669,40867286,41054280,41032943,41158338,41022996,41179642,41189484,40877139,40922533,42956244,42956243,42956245,40754989,21020921,43515039,21099411,21099412,21168220,21040518,21079793,21168221,21128731,21148483,21109262,21040519,21138617,782475,40754990,36885859,40754984,40754983,35746429,35753549,43516088,36790306,35749380,40754988,40754987,43261142,36790305,35749379,35765981,35757716,35765982,35765983,40754985,40754986,35757717,35745197,36813178,782476,782477,21128730,44171953,40891548,40860304,40929523,40846022,41189486,41126894,44162350,44175683,40960863,44166171,44169889,40970487,44169888,41220692,41032944,40922534,40829022,41141469,44080317,43181576,44112129,44063662,43203573,43022640,43022636,43022638,43022639,43137544,43192526,43137545,43022635,43214430,41047313,41110098,41265914,41148554,40846025,41064072,41272847,41095636,40908159,41313860,41251672,41073197,41260534,41167325,40823485,40917131,41229739,40939441,41282551,41016036,36886808,43839459,43839460,43731332,43659667,43731333,40898412,40908158,41189491,41313859,41095635,41189490,41229738,41126896,41158344,41148553,41211064,41085863,40867287,41001838,41095634,41126895,41189489,41095633,41251671,40854917,41104650,40948504,43803266,40860307,40860306,41296983,41048760,40832382,41019221,40754973,40754972,21089505,43605356,21138619,792491,792492,792487,45775244,43532284,45775247,46234369,46234371,46234372,40171022,42902807,42902351,1593841,1593843,1593844,1593827,1593831,1593832,40171032,42902547,42902808,40171027,42902666,42902665,1366413,1366410,1593835,1593837,1593838,40171036,42902703,42902951,40171038,42902746,42902601,1366415,1366414,40171043,42902745,42902878,1366417,1366416,40144020,40170634,44031154,1593828,41113246,36507253,40755779,41175785,40755782,40863558,36503400,40894767,994539,43022634,40755781,21168219,41238265,41113245,40755780,41300202,1366411,36882733,40755784,36891561,43516707,40755783,43857545,40755788,40755787,43839457,40755786,43293794,40755785,43731330,42482744,41082008,40832381,43713312,41050522,40894766,40863557,21099409,43713313,43785321,21099410,40863556,35157532,782469,35145334,40144024,40170637,792484,994538,792488,40755794,40755793,43022633,43532281,45775245,44095857,41207338,994540,43291091,43280250,36406608,41267401,40823573,43022646,37592046,44110189,44086365,44102228,44028586,44123355,44112121,44128185,44067648,42629525,42629528,42629529,1361589,1361590,1361591,42706350,42903122,42902501,42706351,42902950,42902603,42629522,42629526,40223712,40223714,44031147,35605107,35605109,35605532,21119818,21139489,21149345,21139490,21051170,21060972,21100265,21041354,21021737,36405183,36405182,36407510,36406117,36407692,36406397,36405364,36409480,36405622,21060971,44045652,44086311,44037367,44106166,36257155,36262223,36264804,36275750,36257855,36276770,36262941,36261345,36261639,42963136,43145869,35412942,43145870,43189982,43211809,35410089,35407993,43157112,43157113,43189983,43201029,43259955,43287221,43259956,43259957,43134984,41085698,41116912,41272665,40845620,41220253,40886027,41251267,41172478,41085700,41272666,41303825,41116913,40845621,41063664,41198476,40822144,40916931,41072976,41229530,40979259,41010612,40854734,40939050,44163787,40854733,41135881,40979260,40948312,41322790,40953653,40991906,41085699,41210925,41063662,41282149,40948311,41313437,41291417,41109995,41054120,40836043,41148400,41251268,41126459,41135882,41189060,41198477,40922458,43145868,43157111,41113167,41300136,43259954,43281755,1356196,1356197,35145836,35134345,43733075,43859303,43607060,43643241,43804961,41209779,40866054,40873663,41279011,41046568,42963185,40745578,40745577,40745575,21045906,36788092,36277428,44098829,44088437,21173579,36788091,36272662,21134129,36788090,36788089,44054203,46233861,40745574,40745573,46233862,21153979,46275344,36788093,35407455,35409030,35411600,35410032,35410154,35408068,40928207,40873664,41046569,44176175,44159063,44186912,40746092,40745580,21026290,44095522,41112617,43679286,46275343,40745579,46275345,35411973,43025794,35409796,35408503,36262060,36259830,36788794,36259829,36788795,36264674,43025796,43025795,43025793,21095921,21086125,21164764,21037017,21174490,36405820,36404466,36408461,36403871,40748142,44785913,36880777,44785911,44785912,43291090,43285710,44027684,44096758,44072471,44126608,40952416,44172333,44187842,41239632,41214173,41108778,40833825,40995223,41214172,41239631,40927138,40963946,40995222,40913533,40864962,42711069,590562,588824,42723392,42713147,36421515,37592341,36421514,44785908,44785909,21066482,43263899,36274622,43280248,41267166,41080829,43025792)

) I
) C UNION ALL 
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (790206,790207,43868523,43670542,43706314,43796133,43760160,40711488,40711490,40711489,36778541,36778540,36778539,36778538,36778537,36778536,36778535,36778534,43043368,42629523,42629527,792485,792490,46233856,46233860,36779316,36779315,36779314,36779313,36779312,36779311,36779310,36779309,43042501,43042502,43042500,40713914,40713913,40713912,792493,792494,35421239,35421238,35421233,36283782,36283786,36779295,36779294,36283779,36283787,36283781,36779296,36283790,43042509,43042510,43042507,43042508,21040232,21128470,21167940,21118701,36414707,36414697,36414708,36414699,40714383,44785540,44785541,43259902,43287171,44216648,44216637,41519875,41519876,44216656,41350941,41350873,41350892,41351222,41350987,41350676,41351081,41351045,43276333,36778929,36283819,43287175,36283843,36778928,36778927,36283842,36283851,36283840,21167955,21050026,44217179,21158188,41521465,44217103,35798223,40713457,35798253,35798271,41521561,41521601,44217047,44217102,41521536,44217076,44217178,43042921,43042922,43042923,40713497,40713495,40713494,21108988,36778968,36283829,21158190,36778967,36778966,36283811,36283837,21099170,36778965,36778964,36778963,46233863,40713493,40713492,46233864,44217050,44217158,44217111,44785544,44785545,43260894,36269442,43293569,36783453,36267546,43277372,36263377,36783452,36260808,42935428,41048442,21170512,21052645,21150788,21160733,44059521,40725609,35758722,35744200,41244423,40975208,41100372,41017134,41306433,41151031,41088219,40944259,41163043,40950628,41100374,41131696,40857185,41142667,40821761,41244424,40900856,40900855,41100373,41068898,40888500,40913007,41256307,41225382,41037666,41262741,40981763,21150787,41020362,21072356,44082127,43293568,41176892,41206083,41145957,40833532,40745349,40745351,40745350,36787952,36787951,36787950,36787948,36787947,36787946,40745352,36421291,36421290,40745353,40745354,36787954,36787953,43022542,36790320,36790319,36790318,36790317,36790316,36790315,43022584,36790321,40755791,40755790,40755789,40755792,792491,792492,792487,792484,994538,792488,40755794,40755793,43022633,42629525,42629528,42629529,42629522,42629526,35605107,35605109,35605532,21090339,36257155,36262223,36264804,36275750,36257855,36276770,36262941,36261345,36261639,42963136,43145869,35412942,43145870,43189982,43211809,35410089,35407993,43157112,43157113,43189983,43201029,43259955,43287221,43259956,43259957,43134984,41085698,41116912,41272665,40845620,41220253,40886027,41251267,41172478,41085700,41272666,41303825,41116913,40845621,41063664,41198476,40822144,40916931,41072976,41229530,40979259,41010612,40854734,40939050,44163787,40854733,41135881,40979260,40948312,41322790,40953653,40991906,41085699,41210925,41063662,41282149,40948311,41313437,41291417,41109995,40746648,36261638,41054120,40836043,41148400,41251268,41126459,41135882,41189060,41198477,40922458,43145868,43157111,41113167,41300136,43259954,43281755,1356196,1356197,35145836,35134345,43733075,43859303,43607060,43643241,43804961,41209779,40866054,40873663,41279011,41046568,42963185,40745578,40745577,40745575,21045906,36788092,36277428,44098829,44088437,21173579,36788091,36272662,21134129,36788090,36788089,44054203,46233861,40745574,40745573,46233862,21153979,46275344,36788093,35407455,35409030,35411600,35410032,35410154,35408068,40928207,40873664,41046569,44176175,44159063,44186912,40746092,40745580,21026290,44095522,41112617,43679286,46275343,40745579,46275345,35411973,43025794,35409796,35408503,36262060,36259830,36788794,36259829,36788795,36264674,43025796,43025795,43025793,21095921,21086125,21164764,21037017,21174490,36405820,36404466,36408461,36403871,40748142,44785913,36880777,44785911,44785912,43291090,43285710,44027684,44096758,44072471,44126608,40952416,44172333,44187842,41239632,41214173,41108778,40833825,40995223,41214172,41239631,40927138,40963946,40995222,40913533,40864962,42711069,590562,588824,42723392,42713147,36421515,37592341,36421514,44785908,44785909,21066482,43263899,36274622,43280248,41267166,41080829,43025792)

) I
) C
;

with primary_events (event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id) as
(
-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.target_concept_id, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.drug_exposure_end_date, DATEADD(day, 1, C.drug_exposure_start_date)) as end_date, C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 0))
) C


-- End Drug Exposure Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.drug_exposure_end_date, DATEADD(day, 1, C.drug_exposure_start_date)) as end_date, C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 0))
) C


-- End Drug Exposure Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
SELECT 0 as index_id, p.person_id, p.event_id
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.drug_exposure_end_date, DATEADD(day, 1, C.drug_exposure_start_date)) as end_date, C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 0))
) C


-- End Drug Exposure Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
INNER JOIN
(
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.drug_exposure_end_date, DATEADD(day, 1, C.drug_exposure_start_date)) as end_date, C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 1))
) C


-- End Drug Exposure Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

UNION ALL
select PE.person_id, PE.event_id, PE.start_date, PE.end_date, PE.target_concept_id, PE.visit_occurrence_id, PE.sort_date FROM (
-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.drug_exposure_end_date, DATEADD(day, 1, C.drug_exposure_start_date)) as end_date, C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 1))
) C


-- End Drug Exposure Criteria

) PE
JOIN (
-- Begin Criteria Group
select 0 as index_id, person_id, event_id
FROM
(
  select E.person_id, E.event_id 
  FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.drug_exposure_end_date, DATEADD(day, 1, C.drug_exposure_start_date)) as end_date, C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 1))
) C


-- End Drug Exposure Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) E
  INNER JOIN
  (
    -- Begin Correlated Criteria
SELECT 0 as index_id, p.person_id, p.event_id
FROM (SELECT Q.person_id, Q.event_id, Q.start_date, Q.end_date, Q.visit_occurrence_id, OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date
FROM (-- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.drug_exposure_end_date, DATEADD(day, 1, C.drug_exposure_start_date)) as end_date, C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 1))
) C


-- End Drug Exposure Criteria
) Q
JOIN @cdm_database_schema.OBSERVATION_PERIOD OP on Q.person_id = OP.person_id 
  and OP.observation_period_start_date <= Q.start_date and OP.observation_period_end_date >= Q.start_date
) P
INNER JOIN
(
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.drug_exposure_end_date, DATEADD(day, 1, C.drug_exposure_start_date)) as end_date, C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 0))
) C


-- End Drug Exposure Criteria

) A on A.person_id = P.person_id  AND A.START_DATE >= P.OP_START_DATE AND A.START_DATE <= P.OP_END_DATE AND A.START_DATE >= DATEADD(day,0,P.START_DATE) AND A.START_DATE <= DATEADD(day,0,P.START_DATE)
GROUP BY p.person_id, p.event_id
HAVING COUNT(A.TARGET_CONCEPT_ID) >= 1
-- End Correlated Criteria

  ) CQ on E.person_id = CQ.person_id and E.event_id = CQ.event_id
  GROUP BY E.person_id, E.event_id
  HAVING COUNT(index_id) = 1
) G
-- End Criteria Group
) AC on AC.person_id = pe.person_id and AC.event_id = pe.event_id

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P
WHERE P.ordinal = 1
-- End Primary Events

)
SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM primary_events pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

with cteIncludedEvents(event_id, person_id, start_date, end_date, op_start_date, op_end_date, ordinal) as
(
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

)
select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM cteIncludedEvents Results
WHERE Results.ordinal = 1
;



-- generate cohort periods into #final_cohort
with cohort_ends (event_id, person_id, end_date) as
(
	-- cohort exit dates
  -- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
),
first_ends (person_id, start_date, end_date) as
(
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, E.end_date, row_number() over (partition by I.person_id, I.event_id order by E.end_date) as ordinal 
	  from #included_events I
	  join cohort_ends E on I.event_id = E.event_id and I.person_id = E.person_id and E.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
)
select person_id, start_date, end_date
INTO #cohort_rows
from first_ends;

with cteEndDates (person_id, end_date) AS -- the magic
(	
	SELECT
		person_id
		, DATEADD(day,-1 * 0, event_date)  as end_date
	FROM
	(
		SELECT
			person_id
			, event_date
			, event_type
			, MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal 
			, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type) AS overall_ord
		FROM
		(
			SELECT
				person_id
				, start_date AS event_date
				, -1 AS event_type
				, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
			FROM #cohort_rows
		
			UNION ALL
		

			SELECT
				person_id
				, DATEADD(day,0,end_date) as end_date
				, 1 AS event_type
				, NULL
			FROM #cohort_rows
		) RAWDATA
	) e
	WHERE (2 * e.start_ordinal) - e.overall_ord = 0
),
cteEnds (person_id, start_date, end_date) AS
(
	SELECT
		 c.person_id
		, c.start_date
		, MIN(e.end_date) AS end_date
	FROM #cohort_rows c
	JOIN cteEndDates e ON c.person_id = e.person_id AND e.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
)
select person_id, min(start_date) as start_date, end_date
into #final_cohort
from cteEnds
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;





TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;