CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (42873639,45775571,1106776,44785907)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (42873639,45775571,1106776,44785907)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (790206,790207,1511445,1511446,43868523,43670542,43706314,43796133,43760160,43724206,43724207,43616204,40711488,40711490,40711489,36778541,36778540,36778539,36778538,36778537,36778536,36778535,36778534,43043368,42629523,42629527,792485,792490,46233856,46233860,35603332,35603333,45774779,45774780,44216652,44216647,44216644,44216658,44216638,44216660,43259900,43287170,46221170,46221171,36779316,36779315,36779314,36779313,36779312,36779311,36779310,36779309,43042501,43042502,43042500,40713914,40713913,40713912,792493,792494,42920042,42920041,42920043,43281708,43259901,44216650,44216646,44216659,36283788,36779299,36283778,36283785,36779298,36779297,36283777,36283783,36283789,35421239,35421238,35421233,36283782,36283786,36779295,36779294,36283779,36283787,36283781,36779296,36283790,43042509,43042510,43042507,43042508,45774870,45775241,21059837,21128471,36414704,36414711,36414706,21040232,21128470,21167940,21118701,36414707,36414697,36414708,36414699,40714383,44785540,44785541,43259902,43287171,41519877,41519878,41519873,44216648,44216637,41519875,41519876,44216656,41350941,41350873,41350892,41351222,41350987,41350676,41351081,41351045,43843239,43591189,43663432,43609124,43591190,43609125,43735256,43699310,43788922,43771089,43591191,43771088,43663433,43788921,43627137,43771087,43663434,43843240,43681332,43645298,41351584,41350672,41350933,41351191,41351448,41350806,41350638,41351336,41351178,41351243,41350853,41351372,41351113,41350789,41351177,41350614,41351242,41350788,41351308,41350727,41350920,41350787,41350983,41350664,41351409,41351371,41351040,41351574,41351631,41351307,41350786,41351176,41351241,41350726,41351144,41351179,41351041,41351114,41350854,41350695,41350919,36508684,36504277,36505482,36505743,995334,41351585,41351209,41350665,41350666,41350855,41351632,41350868,41351319,41351603,41350885,41351309,44217211,44217086,44217208,43297959,36778932,36283847,43297960,36778931,36778930,36283813,36283833,36283835,43276333,36778929,36283819,43287175,36283843,36778928,36778927,36283842,36283851,36283840,41521553,44217133,44217049,41521446,21158192,21089249,21030419,21118715,44217048,21079557,41521444,21167956,21167955,21050026,44217179,21158188,41521465,44217103,35798223,40713457,35798253,35798271,41521561,41521601,44217047,44217102,41521536,44217076,44217178,35798300,35798303,35798318,35798281,35798243,35798256,35798245,41521544,41521486,41521595,44217209,44217249,41521528,41521495,44217077,42873622,42873623,43042921,43042922,43042923,40713497,40713495,40713494,21108988,36778968,36283829,21158190,36778967,36778966,36283811,36283837,21099170,36778965,36778964,36778963,46233863,40713493,40713492,46233864,44217050,44217158,44217111,35603327,35603329,42919657,40713456,40713455,40713454,40713451,40713452,40713453,21108987,35421253,36283852,21128488,35421265,35421258,35421250,36283848,36283827,44217036,44217087,44217061,44217035,44217166,44217225,44217192,44217142,44217060,21138355,21158189,21050028,21089248,45774774,40713450,45774776,40713447,40713448,40713449,44217024,44217079,44217034,44217033,44217141,44217224,44217191,44217104,44217212,44217167,45892417,45892418,44785544,44785545,42873639,41108649,43296476,43285703,44165221,44185348,44174167,44179522,43258477,36783455,36270055,43263897,36783454,36258273,41267084,40869753,40869752,40869751,40944260,41131697,40919459,41256309,41325255,41100375,41256308,40857186,41106983,40923704,43280244,43260894,36269442,43293569,36783453,36267546,43277372,36263377,36783452,36260808,42935433,42935428,41077249,41267086,40944261,21105870,21164847,21066577,21037083,21027310,21037084,21155015,41048442,21170512,21052645,21150788,21160733,44059521,40725609,35758722,35744200,41244423,40975208,41100372,44059522,35759109,35767422,35767421,35762542,35775883,35750756,44087306,44103776,41275335,41318744,41068899,41017135,41151032,41056728,40963199,41318746,41068901,41106984,41044164,41037667,41006564,40857187,41287355,41013037,41200951,41142668,41017134,41306433,41151031,41088219,40944259,41163043,40950628,41100374,41131696,40857185,41142667,40821761,41244424,40900856,40900855,41100373,41068898,40888500,40913007,41256307,41225382,41037666,41262741,40981763,41244425,41025547,40994464,40944264,40944263,40913008,41262742,41006563,41068900,40944262,41138421,42873411,42902667,42903366,42873414,42873412,41239386,21135181,42873415,21150787,41020362,21072356,44082127,43293568,41176892,41206083,41145957,40833532,44069324,43258476,35745332,44070817,36243617,41236953,40824519,40864697,36247873,40745349,40745351,40745350,36787952,36787951,36787950,36787948,36787947,36787946,40745352,36421291,36421290,40745353,40745354,36787954,36787953,36250059,36233969,36233970,43022542,36790320,36790319,36790318,36790317,36790316,36790315,43022584,36790321,40755791,40755790,40755789,40755792,792491,792492,792487,792484,994538,792488,40755794,40755793,792483,43022633,42629525,42629528,42629529,1366367,42629522,42629526,36248039,36248040,42629521,35605106,35605107,35605109,35605532,35605303,35605307,35605305,793282,793284,793289,793286,42936525,42936523,42936524,42936527,42936526,963382,40224946,43819181,19022650,43621144,963385,19101238,21090339,42706497,43560542,19081297,42936529,19022681,19081298,963386,19022649,21159266,19100091,45775571,40745419,40745380,40745438,40745412,40745484,40745363,40745373,40745465,41076563,41054121,41085701,40867126,41322792,36510186,41095234,41313441,40948313,41198479,41198478,41157930,41322791,994743,36257155,36262223,36264804,36275750,36257855,36276770,36262941,36261345,36261639,40953654,40745365,40745383,42963142,42963136,42963141,43145865,35131383,35132443,43145866,35410577,43201028,43189981,43145867,35410090,35408710,43179058,43179059,43134983,43211808,43145869,35412942,43145870,43189982,43211809,35410089,35407993,43157112,43157113,43189983,43201029,43259955,43287221,43259956,43259957,43134984,41085698,41116912,41272665,40845620,41220253,40886027,41251267,41172478,43292584,40745454,36259662,40745453,40745452,40745451,40745455,40745576,36275005,40745458,40745457,40745456,43281754,40745446,40745445,36275751,36268800,40745444,40745448,40745447,36265504,36263881,40745449,40745450,40745487,43201027,41045213,41085700,41272666,41303825,41116913,40845621,41063664,41198476,40822144,40916931,41072976,41229530,40979259,41010612,40854734,40939050,44163787,40854733,41135881,40979260,40948312,41322790,40953653,40982781,40867127,40898256,41148402,41148401,41189062,41313442,41189061,40948316,41167122,41010614,40854736,41104453,41229533,41322795,44175070,40948315,40916933,41135884,41282150,40854735,44167566,40948314,41322794,41322793,41104452,40886028,41072977,41010613,40916932,41260346,41041692,44171331,41041691,41229532,41135883,41167121,40845622,40907734,41291418,41104451,41095236,41229531,40991906,41085699,41210925,41063662,41282149,40948311,41313437,41291417,41109995,40891449,41234969,40920469,40929365,41303826,40867125,41063665,41313440,41095233,41015956,40745496,40745371,40745368,40745378,40745443,40745461,40745493,40745468,40745481,40745490,40745476,40982782,40860222,40984818,40745436,40745440,37592553,40745359,40745360,36258957,40746648,36261638,40745417,40745414,40745463,40823519,40745474,40891448,40745478,35200242,35200244,41294873,40922459,40745390,40745389,40745470,40982780,41054120,40836043,41148400,41251268,41126459,41135882,41189060,41198477,40922458,43179057,41081933,40894691,43145868,43157111,41113167,41300136,43259954,43281755,1366371,1356196,1356197,35145836,35134345,43292583,43259953,1366364,1356199,1356200,1356202,1356203,1366366,35200235,35149223,35152663,1366372,1366363,1366370,1366365,1366369,1366368,35200236,36246950,793288,43733075,43859303,43607060,43643241,43804961,41209779,40866054,40873663,41279011,41046568,42963185,40745578,40745577,40745575,21045906,36788092,36277428,44098829,44088437,21173579,36788091,36272662,21134129,36788090,36788089,44054203,46233861,40745574,40745573,46233862,21153979,46275344,36788093,35407455,35409030,35411600,35410032,35410154,35408068,40928207,40873664,41046569,44176175,44159063,44186912,40746092,40745580,36248746,21026290,44095522,41112617,43679286,46275343,40745579,46275345,35200240,35200241,36240232,36240233,36240234,36248494,36228853,36248858,1106776,43751025,43661350,43624993,43751026,43733073,43733074,43624994,43589039,43751028,43661351,43589038,43751027,43715035,43697137,43768999,43624992,36884289,43715034,43589036,43589035,42722740,42715132,42728542,42717892,42728541,42723621,42726309,42712928,42710318,42716947,42710317,42727635,42711645,42714899,42720328,41044355,41270602,41020745,41114761,41020744,41146357,41208779,41026560,41057737,41089277,40839656,40839657,41183158,36505140,36507527,40983623,35603326,35603330,35603331,35603328,42956986,43213216,45774627,40725116,40725115,40725114,40725111,40725112,40725113,21144049,35410559,36274865,21045904,44072541,35412391,36257386,44100701,21045905,21055673,21075450,21173576,45774777,40725109,45774778,40725106,40725107,40725108,45774628,21026287,43169383,43213217,43191349,43169384,43158511,43158510,42956982,42956979,42956978,42956980,42956981,42956983,42956984,42956985,36249315,35150759,35158100,42480836,43213218,21153978,41051942,21134126,41114762,36505802,36508116,42480257,43202418,35410193,21055674,41026561,40944997,41226186,41319518,41007317,21114627,41288067,21173577,41163794,21134128,40975975,41132453,44163022,41163792,40975976,40975974,21144050,40913687,41257025,21036055,21026289,21075452,41038372,41319516,41195121,21124246,41007316,21065520,41226184,21173578,40882712,41226183,41319515,44178080,41257024,41163793,40975973,40944995,40882713,41214474,41319517,41257023,41069658,40882711,40851441,40851440,41319514,44181792,41288065,40944994,40944993,41069657,40913686,21094977,21094978,21065519,21075451,21026288,21134127,41057739,41152098,41276367,41307458,35766386,35770720,35766769,35746865,35772049,35767702,35763556,40725104,35750998,35750997,35758461,35767701,35755249,35750996,35755253,35751000,35772050,35767705,40725105,35751001,35759370,36783353,36783352,36783351,19112761,43035122,19121580,43035123,43035124,44032120,35762308,35753989,44059692,35750118,35763555,35763554,35772048,35759369,35755251,35767703,35762655,35755250,35772047,35746864,44087665,35750999,35755252,35746867,35767704,35746866,36510088,36249316,40890338,995051,36813970,41051941,40833935,40989782,41083548,41146358,40870804,40995520,41288066,41120510,40913685,41057738,40944996,41152097,41226185,36506332,995052,36507907,37593328,36811049,36879485,36888676,43751024,43768998,43804960,43643240,43589037,43661349,41107206,40865062,41276366,40952471,35130945,35134299,35129718,35138459,35130251,44160501,44160975,44161621,44168184,35149260,35161530,35152122,44171842,44160976,44176676,44164382,40919704,41020746,41146359,41307457,40870805,40952472,42482075,40893672,43823065,36508634,42481446,43607058,36224275,42482607,43607059,43147319,21026286,43733072,1356250,36812322,1356251,36814300,783895,36508067,45774773,45774775,42956988,792489,36243618,44785907,43263898,43291089,43296481,43296482,35409559,35407216,44183522,44172902,44183144,36272292,36788797,36277408,36262386,36788796,36264997,35411973,43025794,35409796,35408503,36262060,36259830,36788794,36259829,36788795,36264674,43025796,43025795,43025793,35410548,37592340,35412367,35410973,994660,994661,35408843,994659,43269370,44785910,45774871,45775242,21037090,21066587,45775239,21145081,36405058,36403679,36408460,21095921,21086125,21164764,21037017,21174490,36405820,36404466,36408461,36403871,40748142,44785913,36880777,44785911,44785912,43291090,43285710,44025365,44085350,44062001,44053705,43285709,43269371,43296483,44027684,44096758,44072471,44126608,40919670,41044336,41270496,41245116,41108779,40952416,44172333,44187842,41239632,41214173,41208686,40864963,41182859,40932692,40827682,40958402,40896162,40963947,41307168,41007144,41108778,40833825,40995223,41214172,41239631,40927138,40963946,40995222,40913533,40864962,42712209,42715332,42722547,42713704,42711069,590562,588824,42723392,42713147,45774869,45775240,21135187,994658,43285708,36266955,43280247,36247431,41142750,41237110,35138484,37592341,36421515,36421514,44785908,44785909,21066482,43263899,36274622,43280248,36247872,41267166,41080829,43025792,36248472)

) I
) C UNION ALL 
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (1511445,1511446,43724206,43724207,43616204,35603332,35603333,45774779,45774780,44216652,44216647,44216644,44216658,44216638,44216660,43259900,43287170,46221170,46221171,42920042,42920041,42920043,43281708,43259901,44216650,44216646,44216659,36283788,36779299,36283778,36283785,36779298,36779297,36283777,36283783,36283789,45774870,45775241,21059837,21128471,36414704,36414711,36414706,41519877,41519878,41519873,43843239,43591189,43663432,43609124,43591190,43609125,43735256,43699310,43788922,43771089,43591191,43771088,43663433,43788921,43627137,43771087,43663434,43843240,43681332,43645298,41351584,41350672,41350933,41351191,41351448,41350806,41350638,41351336,41351178,41351243,41350853,41351372,41351113,41350789,41351177,41350614,41351242,41350788,41351308,41350727,41350920,41350787,41350983,41350664,41351409,41351371,41351040,41351574,41351631,41351307,41350786,41351176,41351241,41350726,41351144,41351179,41351041,41351114,41350854,41350695,41350919,36508684,36504277,36505482,36505743,995334,41351585,41351209,41350665,41350666,41350855,41351632,41350868,41351319,41351603,41350885,41351309,44217211,44217086,44217208,43297959,36778932,36283847,43297960,36778931,36778930,36283813,36283833,36283835,41521553,44217133,41521446,44217049,21158192,21089249,21030419,21118715,44217048,21079557,41521444,21167956,35798300,35798303,35798318,35798281,35798243,35798256,35798245,41521544,41521486,41521595,44217209,44217249,41521528,41521495,44217077,42873622,42873623,35603327,35603329,42919657,40713456,40713455,40713454,40713451,40713452,40713453,21108987,35421253,36283852,21128488,35421265,35421258,35421250,36283848,36283827,44217036,44217087,44217061,44217035,44217166,44217225,44217192,44217142,44217060,21138355,21158189,21050028,21089248,45774774,40713450,45774776,40713447,40713448,40713449,44217024,44217079,44217034,44217033,44217141,44217224,44217191,44217104,44217212,44217167,45892417,45892418,42873639,41108649,43296476,43285703,44165221,44185348,44174167,44179522,43258477,36783455,36270055,43263897,36783454,36258273,41267084,40869753,40869752,40869751,40944260,41131697,40919459,41256309,41325255,41100375,41256308,40857186,41106983,40923704,43280244,42935433,41077249,41267086,40944261,21105870,21164847,21066577,21037083,21027310,21037084,21155015,44059522,35759109,35767422,35767421,35762542,35775883,35750756,44087306,44103776,41275335,41318744,41068899,41017135,41151032,41056728,40963199,41318746,41068901,41106984,41044164,41037667,41006564,40857187,41287355,41013037,41200951,41142668,41244425,41025547,40994464,40944264,40944263,40913008,41262742,41006563,41068900,40944262,41138421,42873411,42902667,42903366,42873414,42873412,41239386,21135181,42873415,44069324,43258476,35745332,44070817,36243617,41236953,40824519,40864697,36247873,36250059,36233969,36233970,792483,1366367,36248039,36248040,42629521,35605106,35605303,35605307,35605305,793282,793284,793289,793286,42936525,42936523,42936524,42936527,42936526,963382,40224946,43819181,19022650,43621144,963385,19101238,42706497,43560542,19081297,42936529,19022681,19081298,963386,19022649,21159266,19100091,45775571,40745419,40745380,40745438,40745412,40745484,40745363,40745373,40745465,41076563,41054121,41085701,40867126,41322792,36510186,41095234,41313441,40948313,41198479,41198478,41157930,41322791,994743,40953654,40745365,40745383,42963142,42963141,43145865,35131383,35132443,43145866,35410577,43201028,43189981,43145867,35410090,35408710,43179058,43179059,43134983,43211808,43292584,40745454,36259662,40745453,40745452,40745451,40745455,40745576,36275005,40745458,40745457,40745456,43281754,40745446,40745445,36275751,36268800,40745444,40745448,40745447,36265504,36263881,40745449,40745450,40745487,43201027,41045213,40982781,40867127,40898256,41148402,41148401,41189062,41313442,41189061,40948316,41167122,41010614,40854736,41104453,41229533,41322795,44175070,40948315,40916933,41135884,41282150,40854735,40948314,44167566,41322794,41322793,41104452,40886028,41072977,41010613,40916932,41260346,44171331,41041692,41041691,41229532,41135883,41167121,40845622,40907734,41291418,41104451,41095236,41229531,40891449,41234969,40920469,40929365,41303826,40867125,41063665,41313440,41095233,41015956,40745496,40745371,40745368,40745378,40745443,40745461,40745493,40745468,40745481,40745490,40745476,40982782,40860222,40984818,40745436,40745440,37592553,40745359,40745360,36258957,40745417,40745414,40745463,40823519,40745474,40891448,40745478,35200242,35200244,41294873,40922459,40745390,40745389,40745470,40982780,43179057,41081933,40894691,1366371,43292583,43259953,1366364,1356199,1356200,1356202,1356203,1366366,35200235,35149223,35152663,1366372,1366363,1366370,1366365,1366369,1366368,35200236,36246950,793288,36248746,35200240,35200241,36240232,36240233,36240234,36248494,36228853,36248858,1106776,43751025,43661350,43624993,43751026,43733073,43733074,43624994,43589039,43751028,43661351,43589038,43751027,43715035,43697137,43768999,43624992,36884289,43715034,43589036,43589035,42722740,42715132,42728542,42717892,42728541,42723621,42726309,42712928,42710318,42716947,42710317,42727635,42711645,42714899,42720328,41044355,41270602,41020745,41114761,41020744,41146357,41208779,41026560,41057737,41089277,40839656,40839657,41183158,36505140,36507527,40983623,35603326,35603330,35603331,35603328,42956986,43213216,45774627,40725116,40725115,40725114,40725111,40725112,40725113,21144049,35410559,36274865,21045904,44072541,35412391,36257386,44100701,21045905,21055673,21075450,21173576,45774777,40725109,45774778,40725106,40725107,40725108,45774628,21026287,43169383,43213217,43191349,43169384,43158511,43158510,42956982,42956979,42956978,42956980,42956981,42956983,42956984,42956985,36249315,35150759,35158100,42480836,43213218,21153978,41051942,21134126,41114762,36505802,36508116,42480257,43202418,35410193,21055674,41026561,40944997,41226186,41319518,41007317,21114627,41288067,21173577,41163794,21134128,40975975,41132453,41163792,44163022,40975976,40975974,21144050,40913687,41257025,21036055,21026289,21075452,41038372,41319516,41195121,21124246,41007316,21065520,41226184,21173578,40882712,41226183,41319515,44178080,41257024,41163793,40975973,40944995,40882713,41214474,41319517,41257023,41069658,40882711,40851441,40851440,41319514,41288065,44181792,40944994,40944993,41069657,40913686,21094977,21094978,21065519,21075451,21026288,21134127,41057739,41152098,41276367,41307458,35766386,35770720,35766769,35746865,35772049,35767702,35763556,40725104,35750998,35750997,35758461,35767701,35755249,35750996,35755253,35751000,35772050,35767705,40725105,35751001,35759370,36783353,36783352,36783351,19112761,43035122,19121580,43035123,43035124,44032120,35762308,35753989,44059692,35750118,35763555,35763554,35772048,35759369,35755251,35767703,35762655,35755250,35772047,35746864,44087665,35750999,35755252,35746867,35767704,35746866,36510088,36249316,40890338,36813970,995051,41051941,40833935,40989782,41083548,41146358,40870804,40995520,41288066,41120510,40913685,41057738,40944996,41152097,41226185,36506332,995052,36507907,37593328,36811049,36879485,36888676,43751024,43768998,43804960,43643240,43589037,43661349,41107206,40865062,41276366,40952471,35130945,35134299,35129718,35138459,35130251,44160501,44160975,44161621,44168184,35149260,35161530,35152122,44171842,44160976,44176676,44164382,40919704,41020746,41146359,41307457,40870805,40952472,42482075,40893672,43823065,36508634,42481446,43607058,36224275,42482607,43607059,43147319,21026286,43733072,1356250,36812322,1356251,36814300,783895,36508067,45774773,45774775,42956988,792489,36243618,44785907,43263898,43291089,43296481,43296482,35409559,35407216,44183522,44172902,44183144,36272292,36788797,36277408,36262386,36788796,36264997,35410548,37592340,35412367,35410973,994660,994661,35408843,994659,43269370,44785910,45774871,45775242,21037090,21066587,45775239,21145081,36405058,36403679,36408460,44025365,44085350,44062001,44053705,43285709,43269371,43296483,40919670,41044336,41270496,41245116,41108779,41208686,40864963,41182859,40932692,40827682,40958402,40896162,40963947,41307168,41007144,42712209,42715332,42722547,42713704,45774869,45775240,21135187,994658,43285708,36266955,43280247,36247431,41142750,41237110,35138484,36247872,36248472)

) I
) C
;

with primary_events (event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id) as
(
-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 2))
) C


-- End Drug Exposure Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events

)
SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM primary_events pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

with cteIncludedEvents(event_id, person_id, start_date, end_date, op_start_date, op_end_date, ordinal) as
(
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

)
select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM cteIncludedEvents Results

;

-- custom era strategy

with ctePersons(person_id) as (
	select distinct person_id from #included_events
)

select person_id, drug_exposure_start_date, drug_exposure_end_date
INTO #drugTarget
FROM (
	select de.PERSON_ID, DRUG_EXPOSURE_START_DATE, COALESCE(DRUG_EXPOSURE_END_DATE, DATEADD(day,DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,DRUG_EXPOSURE_START_DATE)) as DRUG_EXPOSURE_END_DATE 
	FROM @cdm_database_schema.DRUG_EXPOSURE de
	JOIN ctePersons p on de.person_id = p.person_id
	JOIN #Codesets cs on cs.codeset_id = 2 AND de.drug_concept_id = cs.concept_id

	UNION ALL

	select de.PERSON_ID, DRUG_EXPOSURE_START_DATE, COALESCE(DRUG_EXPOSURE_END_DATE, DATEADD(day,DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,DRUG_EXPOSURE_START_DATE)) as DRUG_EXPOSURE_END_DATE 
	FROM @cdm_database_schema.DRUG_EXPOSURE de
	JOIN ctePersons p on de.person_id = p.person_id
	JOIN #Codesets cs on cs.codeset_id = 2 AND de.drug_source_concept_id = cs.concept_id
) E
;

select et.event_id, et.person_id, ERAS.era_end_date as end_date
INTO #strategy_ends
from #included_events et
JOIN 
(
  select ENDS.person_id, min(drug_exposure_start_date) as era_start_date, DATEADD(day,0, ENDS.era_end_date) as era_end_date
  from
  (
    select de.person_id, de.drug_exposure_start_date, MIN(e.END_DATE) as era_end_date
    FROM #drugTarget DE
    JOIN 
    (
      --cteEndDates
      select PERSON_ID, DATEADD(day,-1 * 30,EVENT_DATE) as END_DATE -- unpad the end date by 30
      FROM
      (
				select PERSON_ID, EVENT_DATE, EVENT_TYPE, 
				MAX(START_ORDINAL) OVER (PARTITION BY PERSON_ID ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal,
				ROW_NUMBER() OVER (PARTITION BY PERSON_ID ORDER BY EVENT_DATE, EVENT_TYPE) AS OVERALL_ORD -- this re-numbers the inner UNION so all rows are numbered ordered by the event date
				from
				(
					-- select the start dates, assigning a row number to each
					Select PERSON_ID, DRUG_EXPOSURE_START_DATE AS EVENT_DATE, 0 as EVENT_TYPE, ROW_NUMBER() OVER (PARTITION BY PERSON_ID ORDER BY DRUG_EXPOSURE_START_DATE) as START_ORDINAL
					from #drugTarget D

					UNION ALL

					-- add the end dates with NULL as the row number, padding the end dates by 30 to allow a grace period for overlapping ranges.
					select PERSON_ID, DATEADD(day,30,DRUG_EXPOSURE_END_DATE), 1 as EVENT_TYPE, NULL
					FROM #drugTarget D
				) RAWDATA
      ) E
      WHERE 2 * E.START_ORDINAL - E.OVERALL_ORD = 0
    ) E on DE.PERSON_ID = E.PERSON_ID and E.END_DATE >= DE.DRUG_EXPOSURE_START_DATE
    GROUP BY de.person_id, de.drug_exposure_start_date
  ) ENDS
  GROUP BY ENDS.person_id, ENDS.era_end_date
) ERAS on ERAS.person_id = et.person_id 
WHERE et.start_date between ERAS.era_start_date and ERAS.era_end_date;

TRUNCATE TABLE #drugTarget;
DROP TABLE #drugTarget;


-- generate cohort periods into #final_cohort
with cohort_ends (event_id, person_id, end_date) as
(
	-- cohort exit dates
  -- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
UNION ALL
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

),
first_ends (person_id, start_date, end_date) as
(
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, E.end_date, row_number() over (partition by I.person_id, I.event_id order by E.end_date) as ordinal 
	  from #included_events I
	  join cohort_ends E on I.event_id = E.event_id and I.person_id = E.person_id and E.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
)
select person_id, start_date, end_date
INTO #cohort_rows
from first_ends;

with cteEndDates (person_id, end_date) AS -- the magic
(	
	SELECT
		person_id
		, DATEADD(day,-1 * 30, event_date)  as end_date
	FROM
	(
		SELECT
			person_id
			, event_date
			, event_type
			, MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal 
			, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type) AS overall_ord
		FROM
		(
			SELECT
				person_id
				, start_date AS event_date
				, -1 AS event_type
				, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
			FROM #cohort_rows
		
			UNION ALL
		

			SELECT
				person_id
				, DATEADD(day,30,end_date) as end_date
				, 1 AS event_type
				, NULL
			FROM #cohort_rows
		) RAWDATA
	) e
	WHERE (2 * e.start_ordinal) - e.overall_ord = 0
),
cteEnds (person_id, start_date, end_date) AS
(
	SELECT
		 c.person_id
		, c.start_date
		, MIN(e.end_date) AS end_date
	FROM #cohort_rows c
	JOIN cteEndDates e ON c.person_id = e.person_id AND e.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
)
select person_id, min(start_date) as start_date, end_date
into #final_cohort
from cteEnds
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;