CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (19097824,1196677,40240664,45775116,1137529,19043191,43532539)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (19097824,1196677,40240664,45775116,1137529,19043191,43532539)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (43702307,43720047,43791927,43720045,43720046,43630243,43633767,43615577,43651812,43759480,43687724,43777558,43831583,43651821,43741655,44217447,44217383,44217458,44217408,44217394,41521797,44217409,44217425,44217462,44217442,44217357,41521776,41521796,44217315,44217441,44217440,44217424,44217439,44217356,44217331,44217375,44217423,41521802,41521789,44217316,44217376,44217332,44217461,44217398,44217426,44217397,44217355,44217396,44217429,44217395,44217449,44217354,44217321,44217460,784942,41478794,41478833,41478790,41478810,41478800,41478804,41478788,41478813,41478808,41478816,41478824,41478818,41478829,41478809,41478795,43723669,43651985,43651987,43669995,43705789,43651988,43813746,43651986,43849837,43687858,43687859,43723671,43741815,43813740,43741813,43795619,43813742,43813741,43615728,43777724,43813743,43813744,43867999,43597746,43633915,43868000,43597747,43597745,43705787,43723670,43597748,43759622,43687857,43868003,43669994,43741814,43759624,43795620,43813745,43687860,43868001,43777725,43868002,43615730,43813747,41478841,41478861,41478852,41478840,41478857,41478835,41478874,41478850,41478853,41478858,41478871,41478877,41478870,41478878,41478869,790206,790207,43688381,43850337,43868524,43868523,43670542,43706314,43796133,43760160,42731565,36897613,36897612,36897977,36898127,43869173,36897976,36898126,43869529,42731618,36897615,36897614,36897979,36898129,43869865,36897978,36898128,43869051,43832331,43742360,43850342,43814240,43814239,43616215,43796137,43688391,43850341,43688392,43616216,43760167,43688390,43724211,43742357,43742356,43778246,43670548,43616209,43850338,43616211,43688387,43598291,43598290,43616210,43742358,43850339,43670549,43616212,43616213,43634435,43814237,43760165,43760166,43742359,43850340,43706317,43670550,43616214,43688388,43868527,43634436,43688389,43814238,43706316,43688393,43814241,43706318,43850343,43868529,43634437,43634438,43850346,43652493,43616221,43868533,43616222,43598293,43628315,43592310,43772257,43682427,43646447,43718182,43718183,43862584,43826308,43646444,43790077,43646446,43790076,43718180,43718181,43754222,43754223,43808203,43700473,43754221,43772256,43646445,43862583,43610240,43592313,43808206,43646452,43808204,43664610,43754227,43808205,43844386,40711488,40711490,40711489,36778541,36778540,36778539,36778538,36778537,36778536,36778535,36778534,43043368,21050044,35421286,41522374,35421291,35421275,41522488,41522334,41522298,35421293,43043384,44217535,44217601,21109002,21050045,41522468,41522450,41522459,41522404,41522333,41522332,41522368,41522367,41522476,41522421,41522345,41522405,41522369,41522513,44217699,41522496,41522315,44217625,41522536,41522512,41522447,35421287,35421280,35421300,43043385,41522326,41522359,41522420,44217534,41522427,41522340,41522446,41522475,41522457,41522365,41522535,41522312,41522297,41522534,41522458,44217533,41522331,41522366,44217623,41522279,41522314,44217624,41522313,41522505,41522394,36414880,36778507,36283889,36414881,36414877,36283886,36778506,36778505,36283890,36283875,36283881,21079568,35421290,35421274,35421279,35421277,21050043,21138375,41522274,35421295,35421282,35421289,36283869,36778504,36778503,36283897,41522469,43043381,43043382,43043383,21030432,35421294,41522448,43043390,43043391,21118724,21167975,41522360,41522524,35421283,35421302,35421285,43043392,41522523,41522506,41522441,41522341,36414882,36778513,36414879,36414878,36283868,36778512,36778511,36283878,21138376,36778510,21079569,21050046,41522395,36283895,36778509,36778508,36283893,41522451,43043386,43043387,43043388,43043389,43276341,43297964,35421301,35421272,35421296,35421284,35421273,43043370,43043371,42708504,42708505,35421281,35421278,35421288,35421292,35421299,43043379,43043380,43043375,43043376,36778519,35421298,35421297,35421276,36778518,36778517,43043377,43043378,36778527,36778526,36778525,36778524,36778523,784985,784987,784989,784990,784991,784992,784993,43043372,43043373,42708508,42708509,43259909,43265353,21109004,21158204,41522388,21128505,41522495,21158205,21118726,44217598,41522445,21138380,21167980,44217676,21138381,21109005,41522266,41522305,41522310,44217621,44217531,41522444,41522510,41522403,44217697,44217530,41522532,41522309,41522509,21089257,21158206,41522304,21148233,41522308,41522344,41522456,44217580,21050049,41522508,21158207,41522277,21118727,21118728,21148232,41522422,41522436,41522435,36778552,41522462,41522301,36778551,41522338,41522363,41522430,41522306,36778550,41522399,41522491,44217524,40711497,40711496,40711501,40711500,40711499,40711498,21059879,21128503,36283898,21138374,21148228,784979,784980,784981,36778563,36778562,36778561,36778560,36778559,40711511,40711513,40711512,40711510,40711508,40711509,21089255,21108998,21177683,36283879,21050041,784968,784969,784970,41522461,41522425,41522464,41522317,41522329,44217575,41522433,41522376,44217537,44217632,36778544,44217682,36778543,36778542,44217549,40711503,40711502,40711507,40711506,40711505,40711504,35798410,35798414,36283873,35798431,35798424,784971,784972,784973,40711577,40711563,40711562,40711561,40711560,36778555,40711576,40711581,40711580,40711579,40711578,40711572,36778554,36778553,40711570,40711569,40711564,40711567,40711565,40711568,40711573,40711566,40711575,40711574,40711689,40711675,40711584,40711583,40711582,40711688,40711693,40711692,40711691,40711690,40711684,40711683,40711682,40711676,40711679,40711677,40711681,40711685,40711678,40711687,40711686,35798427,35798473,35798403,35798461,35798432,35798459,36283891,35798460,35798425,35798418,35798440,35798415,35798450,36809033,784959,784960,784961,784955,784957,784958,44217603,44217542,44217647,44217541,44217540,44217692,44217631,44217522,44217681,44217657,44217566,41522406,41522409,41522467,41522318,41522466,41522377,41522398,21167974,21069817,21089256,21109001,21030431,21128499,21109000,21128501,21158202,21099181,21040256,21138372,21050042,21108999,21138373,21099182,41522282,41522408,41522449,41522281,41522362,41522518,41522480,41522479,41522260,41522507,41522478,41522500,41522490,41522392,41522517,41522347,41522460,41522267,41522424,41522371,41522269,41522288,41522336,41522426,41522356,41522275,44217613,21158203,21099183,36283872,21128502,21167973,36778549,36778548,36778547,36778546,36778545,40711495,40711494,40711493,40711492,784974,784975,784976,784977,784978,40711532,40711517,40711516,40711515,40711514,36778558,40711531,40711536,40711535,40711534,40711533,40711526,36778557,36778556,40711524,40711523,40711518,40711521,40711519,40711522,40711527,40711525,40711520,40711530,40711529,40711528,40711555,40711540,40711539,40711538,40711537,40711554,40711559,40711558,40711557,40711556,40711549,40711547,40711546,40711541,40711544,40711542,40711545,40711550,40711548,40711543,40711553,40711552,40711551,21167968,21069815,21177682,21050039,21158201,21167969,36283870,21059878,21069816,21059877,21079567,21148227,21167970,21167971,21167972,36809032,784965,784966,784967,784962,784963,784964,41522265,41522482,41522465,41522515,41522417,44217523,41522287,41522286,41522452,41522384,44217548,44217669,41522481,41522520,41522525,44217547,41522519,41522434,41522397,44217592,41522355,41522502,41522370,41522497,41522268,41522501,40169218,40169219,40169232,40169233,40169236,40169237,36283885,36283871,36283900,36283884,36283901,36283882,36283899,36283867,36283880,21167979,44217680,44217666,44217565,44217590,44217572,44217642,44217691,44217610,44217665,21059880,21050048,44217659,44217573,42629523,42629527,1361703,1361704,42708510,42708511,42708512,42708513,44217558,44217538,40711432,40711431,40711430,40711429,40711419,40711418,40711417,44217564,44217608,40711427,40711426,44217690,44217588,40711420,44217519,40711423,40711421,40711425,44217689,40711428,40711422,40711434,40711433,40711416,40711415,40711471,36778533,40712255,40711680,40711470,40711469,40711459,40711458,40711457,40711467,36778532,36778531,40711466,40711465,40711460,40711463,40711461,40711464,40711468,40711462,40711473,40711472,40711456,40711455,21030433,44217678,21167976,21138377,21167977,21128504,21030434,21148229,21118725,21138378,21079571,21138379,44217589,21109003,36283888,21177685,21148230,21177684,21079570,21167978,21099184,784982,784983,784984,44217511,44217539,40711452,40711451,40711450,40711449,40711439,40711438,40711437,44217605,44217571,40711446,40711445,44217664,44217640,40711440,44217518,40711443,40711441,40711444,44217587,40711448,40711442,40711454,40711453,40711436,40711435,41522346,41522337,41522263,41522300,41522375,41522396,41522361,41522432,41522264,41522463,41522354,41522514,41522320,41522284,41522415,41522342,41522327,41522489,41522416,41522429,43616242,43616243,43634458,43688414,43832356,43778269,43850368,43634457,43670568,43634456,43850369,43688415,43814263,43868557,43760188,43868558,43760189,43724234,43760190,43814265,43778270,43814266,43652513,43868563,43742387,43616249,43850373,43634463,43832361,43281706,43259899,43259897,43259898,792485,792490,43531861,45775246,46234368,46234370,40169242,40169243,40169244,40169245,40169246,40169247,44217804,44217806,44217805,43792241,43612439,43702596,43810420,43630542,43864823,41522591,41522593,41522592,41522594,41476532,41476543,41476537,41476534,41476528,41476519,41476544,41476518,40714254,40714253,40714252,43718690,43772756,43736822,43718691,43700994,43042435,43042436,43522400,43522403,43042433,43042434,43042427,43042428,43522401,43522399,43042425,43042426,43042431,43042432,43522402,43522404,43042429,43042430,40169202,40169203,40169206,40169207,40169208,40169209,35141720,35153409,45775123,45775125,46233856,46233860,40166837,40166838,36779316,36779315,36779314,36779313,36779312,36779311,36779310,36779309,43042501,43042502,43042500,40713914,40713913,40713912,40713911,36779308,36779307,40713910,40714389,40714388,40714387,36779306,36779305,36779304,36779303,40714385,40714386,43042505,43042506,21128469,35421234,21059836,21108975,21138338,35421237,35421231,21089236,21177667,36414719,36283791,36414700,36414713,36414714,36283776,36283780,36414717,36283784,36414718,41519872,41519874,44216645,44216643,43259903,43270828,43045404,43045403,21059834,21128467,21059835,21128468,21030407,21040231,36414710,36779302,36414696,40714384,36414712,36414698,36779301,36779300,36414709,36283775,36414702,43042503,43042504,43292539,43276329,44216636,44216641,41519879,41519880,792493,792494,43531871,45775248,46234373,46234374,35421239,35421238,35421233,36283782,36283786,36779295,36779294,36283779,36283787,36283781,36779296,36283790,43042509,43042510,43042507,43042508,21040232,21128470,21167940,21118701,36414707,36414697,36414708,36414699,40714383,44785540,44785541,43259902,43287171,44216648,44216637,41519875,41519876,44216656,43042515,41490030,41490024,41490025,41490029,41490033,41490032,41490026,41490027,43825208,43681333,43825209,43807012,43663435,43788925,43807014,43699313,43843243,43788926,43645301,43699312,43735257,43807013,43843241,43843242,43825210,43771090,43645299,43681334,43771091,43788923,43825211,43645300,43609126,43788924,43717059,43699311,41350942,41350811,41350677,41351524,41351223,41350961,41350613,41351415,41350732,41350893,41351440,36504171,995333,41350941,41350873,41350892,41351222,41350987,41350678,41351224,41351245,41350676,41351081,41351045,43742758,43652874,43760557,43814644,43778659,40712900,40712899,40712898,40712897,40712896,43634819,43652879,43742760,43652878,43796550,43670935,43760560,43666068,43755728,43611730,43864062,43701956,43773760,43719630,43276333,36778929,36283819,43287175,36283843,36778928,36778927,36283842,36283851,36283840,21167955,21050026,44217179,21158188,41521465,44217103,35798223,40713457,35798253,35798271,41521561,41521601,44217047,44217102,41521536,44217076,44217178,43042921,43042922,43042923,42708514,42708515,42708516,42708517,44217078,44217085,44217059,44217127,41521497,41521575,41521540,41521464,41521533,35421264,35421263,35421266,35421251,35421256,43042929,43042930,43042924,43042925,35421261,35421259,35421254,35421257,43042926,43042928,43042927,21079555,44217140,44217101,41521478,44217248,41521505,44217075,44217132,44217074,41521494,44217131,41521493,44217058,21089245,21079556,41521594,44217247,21069799,21118714,44217130,21089246,44217129,21030418,21040243,44217155,44217163,41521496,41521535,41521485,44217245,41521456,21148210,21089240,21148213,21030414,21148212,21099166,21059853,21177670,21118711,36897495,43522467,36778974,43270835,36778973,36778972,35798236,35798290,35798340,36283816,35798291,35798263,40713510,40713511,35798262,35798342,35798341,21069794,21118710,21059852,21138347,21079549,21128480,21079548,21128481,36897492,43522466,36778980,40713515,40713514,43297958,36778979,36778978,35798237,35798292,35798308,36283836,35798293,35798275,40713512,40713513,35798343,35798264,784881,784883,784882,41521483,44217083,41521551,44217095,44217152,44217244,41521557,44217030,41521451,41521469,44217162,41521582,41521484,41521473,44217121,41521581,21138345,21138346,21050022,21099165,21138344,21050023,21158180,21079547,21069793,21138343,21059851,36897491,40713505,40713504,35798226,35798249,43522468,36778977,35798276,40713509,40713508,43281713,36778976,36778975,35798296,35798238,35798325,36283839,35798309,35798297,40713506,40713507,35798326,35798250,36810187,784878,784880,784879,41521542,41521455,41521462,41521468,41521564,41521539,41521516,44217042,41521579,44217151,44217120,41521472,44217219,41521448,44217029,44217119,44217187,44217243,41521522,44217082,41521563,44217150,41521556,44217242,44217118,44217201,44217070,41521507,40169262,40169263,1593840,1593842,1593825,1593830,40169275,40169276,40169269,40169270,1366746,1593834,1593836,40169279,40169280,40169281,40169282,1366747,40169285,40169286,1366748,21059858,41521550,41521481,41521571,41521488,21089244,21138353,44217068,44217147,21128485,21128486,41521529,41521577,44217065,41521587,21148216,21050025,44217173,44217041,21128484,21158186,36810201,44217051,44217135,44217117,35160541,35152016,21079554,43042934,43042935,44217175,41521573,41521501,41521454,41521489,21108986,21030417,44217094,41521531,21177674,21128487,44217149,44217069,41521578,44217148,21040242,21069797,44217241,44217174,21138354,21059859,21069798,46276021,46276022,46276023,46276024,40713502,40713501,40713500,21167957,36778971,44217081,36778970,36778969,44217230,36283817,21138356,21099171,45775128,45775129,40713499,40713498,40713497,40713495,40713494,21108988,36778968,36283829,21158190,36778967,36778966,36283811,36283837,21099170,36778965,36778964,36778963,46233863,40713493,40713492,46233864,44217025,44217080,44217089,44217050,44217158,44217111,40713476,40713475,40713474,40713482,40713481,40713480,21089241,21030416,21138349,40713479,40713478,40713477,40166801,44217023,40166802,21138351,21099168,44217168,44217229,21059857,44217193,21138352,21158184,21167954,21138350,43281714,36778962,35798225,43281715,36778961,36778960,35798289,35798274,35798323,36283838,35798288,35798339,40713483,40713484,35798307,35798306,41521447,41521445,41521586,44217228,41521480,44217227,44217145,44217088,44217144,41521538,41521560,41521520,41521596,41521585,44217143,44217226,41521537,41521450,41521479,41521459,44217110,43795233,43831349,43687496,43813364,43795234,43813363,43867639,43795235,43706768,43706769,43814713,43760648,43796618,43724706,43796619,43827848,43737847,43666140,43773840,43791614,43737846,43666139,43845897,43702029,43593847,43593846,43864145,43683962,43809768,43827846,43719719,43773841,43864146,43827847,43593849,43719721,43593850,43845898,43648032,44785544,44785545,43699790,43663936,43717524,43609600,43771576,43717534,43861908,43843748,43753581,43741659,43831587,43777560,43651827,43723511,43723512,43813584,43849690,43795470,43597591,43293569,36783453,36267546,43277372,36263377,36783452,36260808,21170512,21052645,21150788,44059521,40725609,35758722,35744200,41244423,40975208,41100372,41017134,41306433,41151031,41088219,40944259,41163043,40950628,41100374,41131696,40857185,41142667,40821761,41244424,40900856,40900855,41100373,41068898,40888500,40913007,41256307,41225382,41037666,41262741,40981763,21150787,41020362,21072356,44082127,43293568,41176892,41206083,41145957,40833532,36236045,1593829,42966588,42966590,42966595,42966596,42966585,42966589,42966591,42966592,42966593,42966598,42966586,42966594,42966587,41017030,41111099,42966606,42966607,42966609,42966610,42966608,42966605,40923601,40861325,40830146,36217473,36217474,36217475,36247873,36236965,43638203,43728093,43836226,43836227,43710082,43854191,43836225,40745349,40745351,40745350,36787952,36787951,36787950,36787948,36787947,36787946,40745352,21031160,35410561,41181401,40837974,35406946,35411609,41005569,21149021,21158945,41005568,41286313,41317634,35412399,35408504,41067845,40880920,40911948,41193265,41193264,40880919,36408230,36782838,36262335,36407708,36404118,36276086,36782837,36273483,21168749,35407460,35410825,35411608,21149020,21129302,41130718,35407724,35410040,36273484,36782836,41130717,43036257,43147133,43180285,41243757,40974193,41067847,43158331,43213065,43158332,43147132,41016876,36884970,43746015,43836231,43782069,43584050,43818064,43620097,43202246,43136227,41274601,43158333,43169206,43180286,41317635,40943214,43191166,43136228,43180287,41193267,41036626,43158330,43202245,43763953,41297792,21158947,35408246,40837975,43036261,21021442,21119499,41286315,41193266,35409295,35410041,41286314,40880921,41067846,40849697,43036258,36407525,36782842,36408416,36406425,36258164,36782841,21021441,36782840,21041056,21041057,40880922,36257031,36782839,40943213,43036259,43036260,43818059,36880215,43836229,43692179,43656299,43602094,43799957,43656300,36884029,35409034,41274602,43854192,41317636,43638204,35412400,35406947,35407842,43584048,43674444,43818061,40911949,43818062,35412728,43728095,43674443,21158944,35408943,21050841,40895572,43180284,40895571,40864407,41082854,36421291,36421290,40745353,40745354,36787954,36787953,36894458,36408839,43674441,43746013,43692178,21090035,43169205,21099959,43638202,43136226,43728092,43746012,43036256,36250059,36246951,43287626,43255057,43260402,42958513,42958503,43604286,43802100,43820227,35409041,35412138,35408530,35408529,43029018,35412738,42903191,42903396,42706341,43190570,43135588,43157729,43201609,43212444,43179678,36787266,36787264,36787265,36787263,36787260,36787259,36787262,36787261,36787267,42958510,42958509,42958508,35407466,35408254,35408531,35409326,43029028,43029026,36786570,35406978,35406977,36786569,43029027,35411152,43029024,36786575,36786574,36786573,783230,783232,783233,783234,783235,43029025,35407291,42902748,42902433,42706348,43168614,43146495,43190569,43168615,43201606,43157725,43168616,43179677,43179676,43190568,43748117,43622185,43622184,43282195,43276882,43287625,21130988,44173925,21111548,21170511,21072353,21111550,21023169,21082055,21082056,40954545,44046132,41055841,41192840,44112768,44077264,41192839,40887880,41106343,40887879,40950041,41204859,36890841,43730191,43640343,41118617,40823311,40868879,41118616,40868880,40973763,41130314,40911508,41005149,41254851,41098895,40880484,40849293,41192838,41168942,41324648,41012425,41067444,43766088,41048082,44106771,36787257,36787255,36787256,36787254,36787251,36787250,36787253,36787252,36787258,21082057,41212537,44170190,41067442,21023171,21052644,41161675,21091828,21121239,21072354,21091827,21111551,21101703,41266698,44046131,41150103,41150104,41036194,41130313,40918765,41036193,40942778,41262116,41137745,41043536,40880485,44074078,44090165,41036192,41137744,41231378,41231377,41043535,40918764,40861016,40923299,36890839,43820226,43604285,41243527,40993602,40993601,41055840,41274371,41024588,40837767,41005147,41223872,41106342,41005146,41161679,41106341,41168941,41106340,41137743,41293284,41074899,40950040,40981142,41043534,40849292,41223871,41285874,41223874,41223873,41317214,41005148,41192837,41192836,41005145,40981141,40918763,41043532,41043531,41074898,41192835,41043533,41231376,43820225,41110830,44068203,35411345,35412935,35407754,35408533,43029022,43029020,35408532,35407753,43029021,43029019,43146496,43168617,43201608,43157726,43157727,43146497,43212442,43212443,43157728,43135586,43135587,43135585,43201607,43694335,43838317,43856334,21101704,44173926,41098894,21160732,44173924,21111553,21023173,21150785,21101705,21042840,21023172,21140948,41142269,40962334,40962333,40849291,41223870,41324647,41067443,41317213,41200322,41012424,41074897,41074896,41168939,41262115,41168940,41036191,40911507,40918762,41231375,41110829,40892265,36890840,43748116,43658468,41087325,41024587,41087323,41087324,40942777,41161678,41324646,41137742,40942776,41161677,41036190,41130312,40973762,40942775,41005144,41106339,40856571,41106338,43802099,41110828,42479684,41300900,44179736,44175958,44164667,44175957,41145535,43029017,43029015,44187197,42479079,44109187,43029016,36213519,35133500,783227,36810920,36811732,35132736,783228,783229,43029014,40142910,40142912,36787269,36787268,19097824,42943287,19097847,43837785,40860767,19097850,41110562,41233272,41266387,19096012,19097849,19097845,41173038,35147764,19097848,40892006,19097846,35133513,43693753,36886329,41079188,42800512,42800515,36216353,36216354,36216355,36219491,43749255,43695497,43695498,43839463,43767273,43713317,43785326,43821377,43605423,43641482,43839464,43605422,43803265,43767274,43839462,43713319,43821378,43605424,43713318,43803264,43713315,43623304,43587354,43587353,43713314,43749253,43659666,43857548,43857547,43749254,43695496,43785324,43641481,43605421,42956235,41235053,41148556,41032949,41064074,36790294,41211065,41189496,36790293,41064073,40754961,40754960,21040523,40754965,40754964,40754963,40754962,21060130,21030653,21118950,21020924,782493,782494,40754999,36790314,36790313,36790312,36790311,40754996,40754998,40754997,40754995,40754993,40754994,21168224,21158434,21128734,21128733,782485,782486,21079795,41078699,40992089,41313862,40970490,40836223,41220696,41313861,41016038,43857488,43180282,43169202,43695427,43641426,43191165,43136224,43136225,43169203,43767205,43181572,43170553,43181573,43170554,43181574,43159666,36880101,43677641,43022542,36790320,36790319,36790318,36790317,36790316,36790315,43022584,36790321,40755791,40755790,40755789,40755792,40754981,36790300,36790299,40754980,40754979,40754978,40754977,36790298,36790297,40754975,40754976,43022651,40754982,43022650,42956251,42956250,42956252,42935517,42956238,44171955,44187550,44184833,36790288,44188674,36790287,40754967,40754966,35749481,40754971,40754970,40754969,40754968,35754175,35750600,35749372,35753548,782487,782488,44171954,40755776,40755778,44161222,44181114,40755054,40755053,40755052,36790302,40755135,40755139,40755138,40755137,40755136,40755131,36790301,40755130,40755060,40755055,40755058,40755056,40755059,40755132,40755057,40755134,40755133,40755156,40755143,40755142,40755141,40755140,40755155,40755775,40755774,40755773,40755771,40755151,40755150,40755149,40755144,40755147,40755145,40755148,40755152,40755146,40755154,40755153,35749970,35770284,35761900,35761901,35761898,35770283,35761899,35757714,35774558,35749373,35746428,35745193,36813300,782473,782474,782470,782471,782472,40755777,35766099,35774668,44186941,44172596,44184831,44166173,44166172,44162351,44181113,44164424,44186940,44168231,44186939,44176314,44181112,44164423,41235052,41148555,41001844,41095640,41241992,41158351,41189495,21030654,21148486,21109269,21070063,21148487,21118944,21079796,21109266,21089503,21109267,21050283,21089504,21089502,21070060,21060129,21118945,21070061,21060128,21070059,40984920,41204081,41054281,41032946,40877141,41158348,41189492,41158347,41023001,40836222,41023000,40970489,41158346,41282552,41001840,41001839,41220695,41158345,41095637,41078698,41016037,41172551,41265915,41148552,40929524,41189487,41064070,41141470,40825101,44168873,44169891,41303973,41001843,41095639,41001842,41078701,41016042,21089508,35409795,21030656,21109271,21070064,35406945,21128736,21030657,36409023,36275012,36408723,36407245,36409222,36257878,36409528,36405675,21109270,42714019,42722550,588761,587341,42725750,41022997,40939440,44172595,44166170,40860303,43731260,43180283,43158328,43821327,43641427,43169204,43158329,43213064,43147131,43821328,44119241,43170557,43137547,43148470,43170558,43170559,44123365,44034618,44063664,43192528,43839461,36882039,43587355,43731331,43821376,43785325,43857549,43713316,43517092,21079798,21109268,21099418,21040522,21020922,21158436,21158437,21099417,21158438,36882934,43515301,36790304,43261143,36790303,35770286,35761902,35749374,35770285,35745194,40754991,40754992,35765980,35749375,35765979,21118948,43285713,43258479,43285712,44093312,43192524,44034617,44115052,43181575,43192525,43214429,41016035,40898410,41158342,40846024,41117066,41220693,41313856,40886224,41032945,41064071,41211063,41001833,40846023,41272846,40970488,41158341,41078696,40860305,44028596,44025757,44086375,44128214,41211061,41211060,40939439,41126893,41272845,41148550,40877140,40908157,41235051,42935520,41085864,41220698,40939443,41148557,41251675,40908161,21148485,21089506,21118949,21079799,42931193,36790292,36790291,36790290,36790289,40754959,40754958,40754957,40754956,782489,782490,782491,782492,42956225,44179471,40755044,40755046,44161223,44173639,40755002,40755001,40755000,36790308,40755016,40755020,40755019,40755018,40755017,40755011,36790307,40755009,40755008,40755003,40755006,40755004,40755007,40755012,40755010,40755005,40755015,40755014,40755013,40755039,40755024,40755023,40755022,40755021,40755038,40755043,40755042,40755041,40755040,40755033,40755031,40755030,40755025,40755028,40755026,40755029,40755034,40755032,40755027,40755037,40755036,40755035,21109264,21050281,21040520,21040521,21060126,21079794,21128732,21070058,21099414,21109265,21168222,21099415,21168223,21060127,36810912,782483,782484,782481,782482,40755045,21099413,21050280,41172552,41016041,41054282,41189494,41032948,40877144,41158350,41251674,40898413,41272849,41179644,41032947,41126897,41095638,41282553,41158349,41189493,41251673,41220697,40860308,40984921,41016040,41110099,40960864,41272848,40970491,40877143,40829024,42956231,42956230,42956232,43514632,21148484,21030652,21099416,21050284,21128735,21079797,21118946,21158435,782478,40755051,36891746,43517323,36790310,40755050,40755049,43288345,36790309,35770287,35749376,35749377,35749378,35745196,40755047,40755048,35757715,35742117,782479,782480,21138618,41141471,40836224,44184832,40939442,44169890,44179470,40992090,40846026,44162352,40908160,41001841,40877142,41016039,41078700,40922535,43587289,36884561,36885902,43605357,43857486,36883177,43857487,44028595,43203574,43170555,43181577,43192527,43203575,44032705,44047641,44063663,43214431,43803263,36882935,43677642,43785322,43857546,43677643,43695495,43641480,44041552,43170556,44099361,44076321,43159667,43022645,43022642,43022643,43022644,43137546,43159668,43159669,43022641,43203576,41047312,40898411,41001837,41095632,40929525,41313858,41095631,41220694,41251670,41260533,40917130,41198678,40829023,41022999,41117067,41303972,41313857,41001836,41001835,41158343,41001834,41198677,41260532,41189488,41282550,40953754,41296982,41078697,21030655,21020926,21040524,21040525,21089507,21020927,36404433,36790296,36406450,40754974,36407985,36405404,36790295,36406449,36404920,43022648,21020925,43022647,43296484,43280251,43263900,589342,588815,42727420,42726565,42712427,44176312,44177395,40992088,40877138,41265913,44054636,44110200,44112132,44063669,40867286,41054280,41032943,41158338,41022996,41179642,41189484,40877139,40922533,42956244,42956243,42956245,40754989,21020921,43515039,21099411,21099412,21168220,21040518,21079793,21168221,21128731,21148483,21109262,21040519,21138617,782475,40754990,36885859,40754984,40754983,35746429,35753549,43516088,36790306,35749380,40754988,40754987,43261142,36790305,35749379,35765981,35757716,35765982,35765983,40754985,40754986,35757717,35745197,36813178,782476,782477,21128730,44171953,40891548,40860304,40929523,40846022,41189486,41126894,44162350,44175683,40960863,44166171,44169889,40970487,44169888,41220692,41032944,40922534,40829022,41141469,44080317,43181576,44112129,44063662,43203573,43022640,43022636,43022638,43022639,43137544,43192526,43137545,43022635,43214430,41047313,41110098,41265914,41148554,40846025,41064072,41272847,41095636,40908159,41313860,41251672,41073197,41260534,41167325,40823485,40917131,41229739,40939441,41282551,41016036,36886808,43839459,43839460,43731332,43659667,43731333,40898412,40908158,41189491,41313859,41095635,41189490,41229738,41126896,41158344,41148553,41211064,41085863,40867287,41001838,41095634,41126895,41189489,41095633,41251671,40854917,41104650,40948504,43803266,40860307,40860306,41296983,41048760,40832382,41019221,40754973,40754972,21089505,43605356,21138619,792491,792492,792487,45775244,43532284,45775247,46234369,46234371,46234372,40171022,42902807,42902351,1593841,1593843,1593844,1593827,1593831,1593832,40171032,42902547,42902808,40171027,42902666,42902665,1366413,1366410,1593835,1593837,1593838,40171036,42902703,42902951,40171038,42902746,42902601,1366415,1366414,40171043,42902745,42902878,1366417,1366416,40144020,40170634,44031154,1593828,41113246,36507253,40755779,41175785,40755782,40863558,36503400,40894767,994539,43022634,40755781,21168219,41238265,41113245,40755780,41300202,1366411,36882733,40755784,36891561,43516707,40755783,43857545,40755788,40755787,43839457,40755786,43293794,40755785,43731330,36220586,42482744,41082008,40832381,43713312,41050522,40894766,40863557,21099409,43713313,43785321,21099410,40863556,35157532,782469,35145334,40144024,40170637,792484,994538,792488,40755794,40755793,792483,43022633,43532281,45775245,44095857,41207338,994540,43291091,43280250,36406608,36246367,41267401,40823573,43022646,37592046,36235527,1196677,43749179,43821323,43641425,43731259,43605350,43821324,43857483,43605354,43767199,43839390,43731258,43695421,43731255,43785269,43641418,43623236,43587281,43623237,43839388,43839389,43605351,43623240,43713251,43731256,43713249,43803201,43659606,43767200,43641419,43677580,43587279,43677579,43587278,43623239,43803202,43785270,43587285,43749177,43803203,43857481,43587280,43695424,43695425,42718807,42724372,42730984,42726011,42711332,42722478,42713073,42714389,41139435,41022967,40992062,41148523,41179617,41126843,41064013,40845965,40939381,41110087,43641424,43821326,43659610,43785272,43713254,43785273,42931222,42931226,42931223,42931227,42931228,42931229,42931230,42931224,42931231,42931225,42931232,42931233,35132869,43641423,43677581,43749178,43857485,43587287,43659608,43641421,43605352,43641422,43587283,43587284,43623238,43749176,43839391,43695423,43677583,43803198,43587277,43587276,43731254,43623235,43587288,43767203,43695422,43587282,43749175,43857484,42931208,43271855,43202241,36276993,36257873,36257871,36273174,36275010,36257872,36274426,43803205,43180281,44110189,44086365,44102228,44028586,44123355,44112121,44128185,44067648,43158322,36813813,42480278,41126832,41313801,21042837,21032937,21130983,21042838,21072350,21101700,21052638,21032936,36813462,43659605,44045683,40867262,40929494,40992059,40992058,41117037,41117036,41241966,41104630,41282503,40908101,41260485,41313804,40886183,41032884,41260484,41282499,41260483,40939382,41073156,41095587,41167286,40845968,40845966,41322943,40970434,41229701,40877093,41260482,41220616,41010773,44099346,44115033,41251626,41251624,41260481,41073155,41322942,41073154,41167279,41220613,40948472,41010768,41010767,41198643,40886182,41073153,41136038,41220615,41260488,40886189,40948477,40854883,41296965,40891540,43803199,43695420,43803200,40929497,41022965,41211037,40960833,41282502,41001773,41126841,41322947,41064010,40877095,41001772,41032886,40825354,40970436,41189418,40948476,41322946,40917097,44093297,40984904,43191164,35134649,44168871,44173632,35136428,35140184,35151957,42931238,43857480,36813020,43036236,21023168,43036237,44177387,41272809,41158278,41220620,40845969,41158279,44162346,21160730,21121238,44162347,41220624,21130985,21150784,21111547,21130987,21130986,21121237,21111545,21052642,21111546,783956,43147129,43213057,41110085,42479709,43213060,43136222,43158324,43169200,43147130,40939383,36419587,41032887,41167274,41291616,41136042,41073161,43213059,43158323,40992061,40836196,41117038,40929495,41085828,40836194,43191161,43036250,43036249,43036248,43036247,41148526,40992060,41022966,41085827,21121235,21170506,41272808,43036254,43036253,41136043,43036252,43036251,36508953,41001768,41001767,40917094,41064006,41010766,41189414,41167278,41282498,41158274,41229700,42479108,41189416,43158325,41001774,41291606,41291615,41322940,40854882,40886178,35411755,41064009,41291605,41010771,41073149,41041859,41032885,41322945,41041858,40948468,40854881,40948467,41104629,41041864,41291614,41104628,41136036,41260487,40854876,41167281,41291610,40854880,40854879,41010769,41041860,40886187,41291609,41126840,40948466,41291613,43158326,35410184,41095589,41126839,41010770,41136037,41322941,41010772,40948470,21062439,21170507,21072351,41001771,41073159,40948469,41229699,41167277,41073152,40979426,40854878,41167285,41073160,40822548,21170508,21032939,40854877,41073151,40886179,21121236,41073150,43036255,21062440,21130984,21042839,37593432,21160729,21023167,21052640,21032938,21091825,21140946,41064011,40970435,41158276,41167287,41198645,40948478,41251627,40886185,40948473,40886184,41167280,41136039,40917095,41260486,36508007,41032889,41313806,41229703,41001770,41041863,41220614,41073158,41001769,41104627,41158275,40917096,41220619,41291617,40908102,41220617,41229705,40939380,41064005,40948465,41282497,41104625,41189413,40979425,43695426,43677584,41282501,41167284,41001766,40854875,41282496,41104624,41126838,40948475,41220612,41260479,43767204,43623241,41220611,41041857,41126834,40979423,41158273,40979424,43767202,35407725,35408505,35408669,35410042,35412553,40877094,41251623,40979422,41313807,41167283,41189417,41136041,41282495,41073148,41126833,41167276,40908105,41126842,41041866,35411611,35409296,35408774,35411610,35411754,41251625,41251622,40854874,41126837,41322944,41064008,41136040,40908100,41291604,41282494,41167275,43605353,41001765,41229698,41064004,41229697,40877092,41260478,43659609,43659607,41251621,41322939,41158272,41291603,40939379,41104623,43641420,41313809,40845967,40948474,41282500,41198644,40823392,41229702,41251628,40917098,44047632,44063635,41032888,41095586,41291612,40979427,41041862,41313805,40886188,41073157,41291611,41041861,41167282,41095588,40979428,41167288,41073163,40886190,41073162,44067649,43293567,41235044,36276991,40984905,43213058,41265900,43749180,43821325,35407280,41265901,40829012,35407281,41047303,43803204,43839392,41016020,36885085,35409297,35408636,43713253,35408247,35409799,36259673,35407461,35742288,35409798,35411612,35407968,35410826,35411794,35767010,35760914,35412401,35752547,35744205,35408729,40723572,35760913,35773624,35752548,35756763,35769223,35742107,40723573,35769222,35756764,35760915,43288115,36262970,36262969,36268718,36270625,36260842,35410043,35406949,35408709,35406948,35409477,43202242,43191163,43169201,43202243,43213063,41085829,40898379,40836195,41158277,41220618,43136223,43158327,43202244,40908104,41189419,40908103,41322948,40939385,41313808,41064012,40939384,41041865,40948479,43036241,43036240,43036239,43036238,43036245,43036244,43036243,43036242,43036246,44110190,44125276,44076301,44080306,41296966,36879590,40898378,41148524,40898375,40898377,40898376,40992057,41179618,40929496,41032883,41189415,41126835,41104626,40948471,41313802,41260480,41265904,40836197,40836190,41054258,41220625,40845970,43785274,43623243,43839393,43605355,42931236,42931237,43821322,43713250,43659604,43857482,42931206,42931207,35151345,40889542,41265899,40836192,41179616,40836191,41220610,40877091,41251620,41198641,41198642,41167273,41322938,41076606,40836193,41148525,41095585,41126836,41291607,41110086,40953741,41022964,41241965,41313803,41064007,40886181,41291608,40886180,42480849,43147128,40894748,40863545,42482086,40957003,41207328,40832363,40988266,43839387,43731253,35410456,41019207,21111544,41269213,35412042,43695419,43659603,43803197,41207327,44031148,21170505,42706340,42629520,42629525,42629528,42629529,42706349,1361589,1361590,1361591,42706350,42903122,42902501,42706351,42902950,42902603,36249295,36249311,42708523,42708524,42706352,42708518,42708519,42706353,1366367,42629522,42629526,36220580,1356191,36813579,36811899,1356192,783953,783954,35140220,36811172,1356187,783955,1356188,44107471,44108708,36220577,40223712,40223714,44031147,35605107,35605109,35605532,21119818,21139489,21149345,21139490,21051170,21060972,21100265,21041354,21021737,36405183,36405182,36407510,36406117,36407692,36406397,36405364,36409480,36405622,21060971,44045652,44086311,44037367,44106166,42481318,21080584,44094568,44108666,36257155,36262223,36264804,36275750,36257855,36276770,36262941,36261345,36261639,42963136,43145869,35412942,43145870,43189982,43211809,35410089,35407993,43157112,43157113,43189983,43201029,43259955,43287221,43259956,43259957,43134984,41085698,41116912,41272665,40845620,41220253,40886027,41251267,41172478,41085700,41272666,41303825,41116913,40845621,41063664,41198476,40822144,40916931,41072976,41229530,40979259,41010612,40854734,40939050,40854733,44163787,41135881,40979260,40948312,41322790,40953653,40991906,41085699,41210925,41063662,41282149,40948311,41313437,41291417,41109995,41054120,40836043,41148400,41251268,41126459,41135882,41189060,41198477,40922458,43145868,43157111,41113167,41300136,43259954,43281755,1366371,1356196,1356197,35145836,35134345,40240664,35605530,36249313,36249314,40240666,40240667,44058588,44086200,44076083,44080170,36271710,42481778,42927688,36894303,36886429,35144686,35137290,35148479,21027232,43191478,21046935,41148114,41041402,41198158,40960387,40947991,41260021,40969323,41062876,40854408,40885706,40876040,41291119,41062879,43191479,43202520,40969326,41312681,41072636,41291118,41198157,41072635,40947990,41198156,40947989,41166770,40916600,21174497,40854412,21125197,40906954,41104096,41291123,41260020,40916599,40947983,41072640,41198155,40885708,40885707,41072639,41198150,41041401,21125196,21164770,43158616,43169489,43191480,43147446,43191481,41094471,41157214,41104095,41219502,41198149,40828755,36887915,35774930,36262207,43275120,35770979,35750797,35759148,36262877,36276365,35746635,35767459,43037185,43037186,43037187,43037188,43037189,43037190,43037191,43037192,41203793,43213339,41141193,42927687,42927686,36890386,21125194,43158617,21174496,41179161,41041400,41053872,40978944,41166774,41031719,41094476,41072638,41041399,40947988,41312683,40978943,41198153,40844835,43169490,43136483,41157221,41188291,40947986,41198152,40854411,41229213,41104097,41291122,40947987,41260019,41166772,41198151,21066490,41260018,21135101,41281346,41166773,41010275,40916598,40947985,40978942,41135518,41291121,40854410,41322438,41072637,41198154,40916597,21056659,21125195,43213340,43213341,43147447,43191482,40854409,43158618,40969324,41166771,41125700,41000655,40947984,41125699,41291120,41141194,36894797,35745546,36277562,43258655,35754241,35746636,35750798,36273104,36263493,35750799,35746637,43037193,43037194,43037195,43037196,43037197,43037198,43037199,43037200,41015798,43202521,40828756,40982683,42479568,41268992,41268991,43158615,41144590,36224220,1356211,1356212,36810697,43037184,44055847,44082788,45775116,43625059,43697194,43787036,43787035,43733075,43859303,43607060,43643241,43804961,43787033,43841226,43715101,43607129,43661411,43751080,43697193,43733130,43823113,43715102,43679353,43625058,43697192,43841227,43733129,43643304,43805028,43841225,43787034,43679352,41044828,40866055,41209780,41209781,40928208,40842423,40998389,40873665,40842422,41234356,41209779,40866054,40873663,41279011,41046568,42963185,43136581,45775122,40746097,40746096,40746095,21037089,36788095,44165759,36788094,21066585,21135185,45775126,45775127,40746094,40746093,45775124,21076490,40745578,40745577,40745575,21045906,36788092,36277428,44098829,44088437,21173579,36788091,36272662,21134129,36788090,36788089,44054203,46233861,40745574,40745573,46233862,21153979,46275344,36788093,43213417,43213418,43202596,43191563,35411040,43169576,35407455,35409030,35411600,35410032,35410154,35408068,41107677,40897236,41248226,41109399,40928207,40873664,41046569,44175580,44172459,44180743,44183164,44176175,44159063,44186912,40746100,40746099,36246958,21174574,43751079,43180629,21174575,43823112,45775117,45775119,40746098,40746092,40745580,36248746,21026290,44095522,41112617,43679286,46275343,40745579,46275345,36239885,1137529,43840087,43858147,43749839,43642094,43785891,43803860,43696055,43587928,43785890,43605982,43642093,43821961,43731910,43767853,43587927,43642092,43587930,43803861,43840091,43785894,43840088,43660247,43840090,43731909,43623838,43713891,43840086,43840085,43660246,43821962,43858150,43840092,43858151,43731913,43623839,43803862,43803863,1137536,1137534,19004165,19045230,43194099,21022346,44164392,44172389,44180487,40742239,40742238,40742237,40742236,40742227,40742226,40742225,44173033,40742234,40742233,40742228,40742231,40742229,40742232,40742235,40742230,40742241,40742240,40742224,40742223,40742278,36787271,40742277,40742276,40742275,40742274,40742264,40742263,40742262,40742272,36787270,40742271,40742270,40742265,40742268,40742266,40742269,40742273,40742267,40742280,40742279,40742261,40742260,36885860,44180488,21120395,21090942,21159873,21071494,21140068,21090943,21100881,21090944,21042023,21051766,21159874,21071496,21032076,21071495,21169664,21042022,21120396,783091,783092,44045246,44176803,40742257,40742256,40742255,40742254,40742246,40742245,40742244,44111335,40742252,40742251,44126964,40742249,40742247,40742250,40742253,40742248,40742259,40742258,40742243,40742242,21120394,21071493,40742281,21159872,40952670,41146709,40933888,40996404,40965090,41302057,41177626,41302056,40871663,40933887,41090179,41320006,41101630,41195634,41132965,41226700,41215288,41132964,41320005,41007825,41038885,37592730,36504581,43194100,43215975,43205056,43172137,43183118,43027822,43150001,36266643,36259535,36262098,36264703,36265110,36265108,36266133,36265109,36258710,36269253,36894149,40919903,40921486,40865418,40871662,41052301,41121390,41058585,41152933,41270974,41027421,41277161,40990131,41277160,41215287,40983790,41295883,41046211,41177625,40933886,40996403,40990130,40871661,40902701,40890517,36891187,40888904,36892744,43587931,43749846,43749845,21120397,1137537,44171923,42903330,44161731,42902715,21149922,21081204,21169665,21042025,21042024,21032077,21100882,36892743,36787273,40742284,35771418,43290124,36787272,35774097,35748917,35765509,35748918,35753063,40742282,40742283,35757247,35748919,40167701,43268421,41202993,42478849,40965088,41246290,41277158,40902698,41052300,41083914,40896606,21110706,21061561,21110707,21090946,21042026,21042027,41027419,41308326,41132960,41101628,41164313,41058583,21130147,21022347,40945515,41101627,21061562,21130149,21130148,21140069,21090947,994819,21081205,21130146,43215976,43215977,36404388,36408190,36408966,36406363,36408189,36404843,36407676,36405337,36404066,36403779,36404065,36407179,36405336,36405597,36409453,36406362,21169666,43194101,41294329,41171561,41146706,41121388,40958876,41121387,41121386,41234014,36879552,41202994,41146708,40958877,40840533,40821158,41257544,41257543,41302055,40902699,41152932,40865417,41115141,41146707,41021109,40965089,41121389,41152931,40851960,41132963,41027420,41308327,41132962,41038884,41132961,40851961,41101629,40945516,40921485,41075953,40827956,41021111,41277159,41215286,41021110,41209163,40902700,41058584,41320004,41090178,41070184,41171562,40167702,41299304,40742286,41299303,40167703,43215974,40742287,40742285,36224092,35158799,36810866,35161400,36814154,36811737,783089,783090,1356189,1356190,1593824,36229015,36248858,36246959,36243012,792489,19043191,35156111,35133351,35141839,41294109,41202732,41295638,19043198,40827687,41045971,42926120,42926122,42926130,42926123,42926124,42926134,42926121,42926128,42926135,42926125,42926129,42926137,42926132,42925841,42926131,42926133,42926126,42926127,42926136,19091932,42926159,42926167,35157521,42926160,42926161,42926172,42926158,42926165,42926173,42926162,42926166,42926175,42926169,42926170,42926168,42926171,42926163,42926176,42926164,42926174,19043199,42926199,42926207,41045970,40952420,42926200,42926212,42926198,42926205,42926201,42926213,42926202,42926206,42926215,42926209,42926210,42926208,42926211,42926203,42926216,42926204,42926214,36222931,36222932,36222933,35411973,43025794,35409796,35408503,36262060,36259830,36788794,36259829,36788795,36264674,43025796,43025795,43025793,21095921,21086125,21164764,21037017,21174490,36405820,36404466,36408461,36403871,40748142,44785913,36880777,44785911,44785912,43291090,43285710,44027684,44096758,44072471,44126608,40952416,44172333,44187842,41239632,41214173,41108778,40833825,40995223,41214172,41239631,40927138,40963946,40995222,40913533,40864962,42711069,590562,588824,42723392,42713147,36421515,37592341,36421514,44785908,44785909,21066482,43263899,36274622,43280248,36247872,41267166,41080829,43025792,36248472,36243525,36243526,43532539,43158363,21135095,43034849,43147164,44026327,43532540,42716181,41107129,40950781,43180317,43024344,1366412)

) I
) C UNION ALL 
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (43702307,43720047,43791927,43720045,43720046,43630243,44217447,44217383,44217458,44217408,44217394,41521797,44217409,44217425,44217462,44217442,44217357,41521776,41521796,44217315,44217441,44217440,44217424,44217439,44217356,44217331,44217375,44217423,41521802,41521789,44217316,44217376,44217332,44217461,44217398,44217426,44217397,44217355,44217396,44217429,44217395,44217449,44217354,44217321,44217460,784942,41478794,41478833,41478790,41478810,41478800,41478804,41478788,41478813,41478808,41478816,41478824,41478818,41478829,41478809,41478795,43723669,43651985,43651987,43669995,43705789,43651988,43813746,43651986,43849837,43687858,43687859,43723671,43741815,43813740,43741813,43795619,43813742,43813741,43615728,43777724,43813743,43813744,43867999,43597746,43633915,43868000,43597747,43597745,43705787,43723670,43597748,43759622,43687857,43868003,43669994,43741814,43759624,43795620,43813745,43687860,43868001,43777725,43868002,43615730,43813747,41478841,41478861,41478852,41478840,41478857,41478835,41478874,41478850,41478853,41478858,41478871,41478877,41478870,41478878,41478869,43688381,43850337,43868524,42731565,36897613,36897612,36897977,36898127,43869173,36897976,36898126,43869529,42731618,36897615,36897614,36897979,36898129,43869865,36897978,36898128,43869051,43832331,43742360,43850342,43814240,43814239,43616215,43796137,43688391,43850341,43688392,43616216,43760167,43688390,43724211,43742357,43742356,43778246,43670548,43616209,43850338,43616211,43688387,43598291,43598290,43616210,43742358,43850339,43670549,43616212,43616213,43634435,43814237,43760165,43760166,43742359,43850340,43706317,43670550,43616214,43688388,43868527,43634436,43688389,43814238,43706316,43688393,43814241,43706318,43850343,43868529,43634437,43634438,43850346,43652493,43616221,43868533,43616222,43598293,43628315,43592310,43772257,43682427,43646447,43718182,43718183,43862584,43826308,43646444,43790077,43646446,43790076,43718180,43718181,43754222,43754223,43808203,43700473,43754221,43772256,43646445,43862583,43610240,43592313,43808206,43646452,43808204,43664610,43754227,43808205,43844386,36283885,36283871,36283900,36283884,36283901,36283882,36283899,36283867,36283880,21167979,44217680,44217666,44217565,44217590,44217572,44217642,44217691,44217610,44217665,21059880,21050048,44217659,44217573,44217558,44217538,40711432,40711431,40711430,40711429,40711419,40711418,40711417,44217564,44217608,40711427,40711426,44217690,44217588,40711420,44217519,40711423,40711421,40711425,44217689,40711428,40711422,40711434,40711433,40711416,40711415,40711471,36778533,40712255,40711680,40711470,40711469,40711459,40711458,40711457,40711467,36778532,36778531,40711466,40711465,40711460,40711463,40711461,40711464,40711468,40711462,40711473,40711472,40711456,40711455,21030433,44217678,21167976,21138377,21167977,21128504,21030434,21148229,21118725,21138378,21079571,21138379,44217589,21109003,36283888,21177685,21148230,21177684,21079570,21167978,21099184,784982,784983,784984,44217511,44217539,40711452,40711451,40711450,40711449,40711439,40711438,40711437,44217605,44217571,40711446,40711445,44217664,44217640,40711440,44217518,40711443,40711441,40711444,44217587,40711448,40711442,40711454,40711453,40711436,40711435,41522346,41522337,41522263,41522300,41522375,41522396,41522361,41522432,41522264,41522463,41522354,41522514,41522320,41522284,41522415,41522342,41522327,41522489,41522416,41522429,43868558,43760189,43724234,43760190,43814265,43778270,43814266,43652513,43868563,43742387,43616249,43850373,43634463,43832361,43792241,43612439,43702596,43810420,43630542,43864823,40714254,40714253,40714252,43718690,43772756,43736822,43718691,43700994,35141720,35153409,45775123,45775125,40166837,40166838,43045404,43045403,43042515,43825208,43681333,43825209,43807012,43663435,43788925,43807014,43699313,43843243,43788926,43645301,43699312,43735257,43807013,43843241,43843242,43825210,43771090,43645299,43681334,43771091,43788923,43825211,43645300,43609126,43788924,43717059,43699311,41350942,41350811,41350677,41351524,41351223,41350961,41350613,41351415,41350732,41350893,41351440,36504171,995333,41350678,41351224,41351245,43742758,43652874,43760557,43814644,43778659,40712900,40712899,40712898,40712897,40712896,43634819,43652879,43742760,43652878,43796550,43670935,43760560,21059858,41521550,41521481,41521571,41521488,21089244,21138353,44217068,44217147,21128485,21128486,41521529,41521577,44217065,41521587,21148216,21050025,44217173,44217041,21128484,21158186,36810201,44217051,44217135,44217117,35160541,35152016,21079554,43042934,43042935,44217175,41521573,41521501,41521454,41521489,21108986,21030417,44217094,41521531,21177674,21128487,44217149,44217069,41521578,44217148,21040242,21069797,44217241,44217174,21138354,21059859,21069798,40713502,40713501,40713500,21167957,36778971,44217081,36778970,36778969,44217230,36283817,21138356,21099171,45775128,45775129,40713499,40713498,44217025,44217080,44217089,40713476,40713475,40713474,40713482,40713481,40713480,21089241,21030416,21138349,40713479,40713478,40713477,40166801,44217023,40166802,21138351,21099168,44217168,44217229,21059857,44217193,21138352,21158184,21167954,21138350,43281714,36778962,35798225,43281715,36778961,36778960,35798289,35798274,35798323,36283838,35798288,35798339,40713483,40713484,35798307,35798306,41521447,41521445,41521586,44217228,41521480,44217227,44217145,44217088,44217144,41521538,41521560,41521520,41521596,41521585,44217143,44217226,41521537,41521450,41521479,41521459,44217110,43795233,43831349,43687496,43813364,43795234,43813363,43867639,43795235,43706768,43706769,43814713,43760648,43796618,43724706,43796619,43593849,43719721,43593850,43845898,43648032,43699790,43663936,43717524,43609600,43771576,43717534,43861908,43843748,43753581,43741659,43831587,43777560,43651827,43723511,43723512,43813584,43849690,43795470,43597591,36236045,1593829,36217473,36217474,36217475,36247873,36236965,36250059,36246951,36213519,19097824,42943287,19097847,43837785,40860767,19097850,41110562,41233272,41266387,19096012,19097849,19097845,41173038,35147764,19097848,40892006,19097846,35133513,43693753,36886329,41079188,42800512,42800515,36216353,36216354,36216355,36219491,36220586,792483,36246367,36235527,1196677,43749179,43821323,43641425,43731259,43605350,43821324,43857483,43605354,43767199,43839390,43731258,43695421,43731255,43785269,43641418,43623236,43587281,43623237,43839388,43839389,43605351,43623240,43713251,43731256,43713249,43803201,43659606,43767200,43641419,43677580,43587279,43677579,43587278,43623239,43803202,43785270,43587285,43749177,43803203,43857481,43587280,43695424,43695425,42718807,42724372,42730984,42726011,42711332,42722478,42713073,42714389,41139435,41022967,40992062,41148523,41179617,41126843,41064013,40845965,40939381,41110087,43641424,43821326,43659610,43785272,43713254,43785273,42931222,42931226,42931223,42931227,42931228,42931229,42931230,42931224,42931231,42931225,42931232,42931233,35132869,43641423,43677581,43749178,43857485,43587287,43659608,43641421,43605352,43641422,43587283,43587284,43623238,43749176,43839391,43695423,43677583,43803198,43587277,43587276,43731254,43623235,43587288,43767203,43695422,43587282,43749175,43857484,42931208,43271855,43202241,36276993,36257873,36257871,36273174,36275010,36257872,36274426,43803205,43180281,43158322,36813813,42480278,41126832,41313801,21042837,21032937,21130983,21042838,21072350,21101700,21052638,21032936,36813462,43659605,44045683,40867262,40929494,40992059,40992058,41117037,41117036,41241966,41104630,41282503,40908101,41260485,41313804,40886183,41032884,41260484,41282499,41260483,40939382,41073156,41095587,41167286,40845968,40845966,41322943,40970434,41229701,40877093,41260482,41220616,41010773,44099346,44115033,41251626,41251624,41260481,41073155,41322942,41073154,41167279,41220613,40948472,41010768,41010767,41198643,40886182,41073153,41136038,41220615,41260488,40886189,40948477,40854883,41296965,40891540,43803199,43695420,43803200,40929497,41022965,41211037,40960833,41282502,41001773,41126841,41322947,41064010,40877095,41001772,41032886,40825354,40970436,41189418,40948476,41322946,40917097,44093297,40984904,43191164,35134649,44168871,44173632,35136428,35140184,35151957,42931238,43857480,36813020,43036236,21023168,43036237,44177387,41272809,41158278,41220620,40845969,41158279,44162346,21160730,21121238,44162347,41220624,21130985,21150784,21111547,21130987,21130986,21121237,21111545,21052642,21111546,783956,43147129,43213057,41110085,42479709,43213060,43136222,43158324,43169200,43147130,40939383,36419587,41032887,41167274,41291616,41136042,41073161,43213059,43158323,40992061,40836196,41117038,40929495,41085828,40836194,43191161,43036250,43036249,43036248,43036247,41148526,40992060,41022966,41085827,21121235,21170506,41272808,43036254,43036253,41136043,43036252,43036251,36508953,41001768,41001767,40917094,41064006,41010766,41189414,41167278,41282498,41158274,41229700,42479108,41189416,43158325,41001774,41291606,41291615,41322940,40854882,40886178,35411755,41064009,41291605,41010771,41073149,41041859,41032885,41322945,41041858,40948468,40854881,40948467,41104629,41041864,41291614,41104628,41136036,41260487,40854876,41167281,41291610,40854880,40854879,41010769,41041860,40886187,41291609,41126840,40948466,41291613,43158326,35410184,41095589,41126839,41010770,41136037,41322941,41010772,40948470,21062439,21170507,21072351,41001771,41073159,40948469,41229699,41167277,41073152,40979426,40854878,41167285,41073160,40822548,21170508,21032939,40854877,41073151,40886179,21121236,41073150,43036255,21062440,21130984,21042839,37593432,21160729,21023167,21052640,21032938,21091825,21140946,41064011,40970435,41158276,41167287,41198645,40948478,41251627,40886185,40948473,40886184,41167280,41136039,40917095,41260486,36508007,41032889,41313806,41229703,41001770,41041863,41220614,41073158,41001769,41104627,41158275,40917096,41220619,41291617,40908102,41220617,41229705,40939380,41064005,40948465,41282497,41104625,41189413,40979425,43695426,43677584,41282501,41167284,41001766,40854875,41282496,41104624,41126838,40948475,41220612,41260479,43767204,43623241,41220611,41041857,41126834,40979423,41158273,40979424,43767202,35407725,35408505,35408669,35410042,35412553,40877094,41251623,40979422,41313807,41167283,41189417,41136041,41282495,41073148,41126833,41167276,40908105,41126842,41041866,35411611,35409296,35408774,35411610,35411754,41251625,41251622,40854874,41126837,41322944,41064008,41136040,40908100,41291604,41282494,41167275,43605353,41001765,41229698,41064004,41229697,40877092,41260478,43659609,43659607,41251621,41322939,41158272,41291603,40939379,41104623,43641420,41313809,40845967,40948474,41282500,41198644,40823392,41229702,41251628,40917098,44047632,44063635,41032888,41095586,41291612,40979427,41041862,41313805,40886188,41073157,41291611,41041861,41167282,41095588,40979428,41167288,41073163,40886190,41073162,44067649,43293567,41235044,36276991,40984905,43213058,41265900,43749180,43821325,35407280,41265901,40829012,35407281,41047303,43803204,43839392,41016020,36885085,35409297,35408636,43713253,35408247,35409799,36259673,35407461,35742288,35409798,35411612,35407968,35410826,35411794,35767010,35760914,35412401,35752547,35744205,35408729,40723572,35760913,35773624,35752548,35756763,35769223,35742107,40723573,35769222,35756764,35760915,43288115,36262970,36262969,36268718,36270625,36260842,35410043,35406949,35408709,35406948,35409477,43202242,43191163,43169201,43202243,43213063,41085829,40898379,40836195,41158277,41220618,43136223,43158327,43202244,40908104,41189419,40908103,41322948,40939385,41313808,41064012,40939384,41041865,40948479,43036241,43036240,43036239,43036238,43036245,43036244,43036243,43036242,43036246,44110190,44125276,44076301,44080306,41296966,36879590,40898378,41148524,40898375,40898377,40898376,40992057,41179618,40929496,41032883,41189415,41126835,41104626,40948471,41313802,41260480,41265904,40836197,40836190,41054258,41220625,40845970,43785274,43623243,43839393,43605355,42931236,42931237,43821322,43713250,43659604,43857482,42931206,42931207,35151345,40889542,41265899,40836192,41179616,40836191,41220610,40877091,41251620,41198641,41198642,41167273,41322938,41076606,40836193,41148525,41095585,41126836,41291607,41110086,40953741,41022964,41241965,41313803,41064007,40886181,41291608,40886180,42480849,43147128,40894748,40863545,42482086,40957003,41207328,40832363,40988266,43839387,43731253,35410456,41019207,21111544,41269213,35412042,43695419,43659603,43803197,41207327,44031148,21170505,42706340,42629520,42706349,36249295,36249311,42708523,42708524,42706352,42708518,42708519,42706353,1366367,36220580,1356191,36813579,36811899,1356192,783953,783954,35140220,36811172,1356187,783955,1356188,44107471,44108708,36220577,42481318,21080584,44094568,44108666,1366371,40240664,35605530,36249313,36249314,40240666,40240667,44058588,44086200,44076083,44080170,36271710,42481778,42927688,36894303,36886429,35144686,35137290,35148479,21027232,43191478,21046935,41148114,41041402,41198158,40960387,40947991,41260021,40969323,41062876,40854408,40885706,40876040,41291119,41062879,43191479,43202520,40969326,41312681,41072636,41291118,41198157,41072635,40947990,41198156,40947989,41166770,40916600,21174497,40854412,21125197,40906954,41104096,41291123,41260020,40916599,40947983,41072640,41198155,40885708,40885707,41072639,41198150,41041401,21125196,21164770,43158616,43169489,43191480,43147446,43191481,41094471,41157214,41104095,41219502,41198149,40828755,36887915,35774930,36262207,43275120,35770979,35750797,35759148,36262877,36276365,35746635,35767459,43037185,43037186,43037187,43037188,43037189,43037190,43037191,43037192,41203793,43213339,41141193,42927687,42927686,36890386,21125194,43158617,21174496,41179161,41041400,41053872,40978944,41166774,41031719,41094476,41072638,41041399,40947988,41312683,40978943,41198153,40844835,43169490,43136483,41157221,41188291,40947986,41198152,40854411,41229213,41104097,41291122,40947987,41260019,41166772,41198151,21066490,41260018,21135101,41281346,41166773,41010275,40916598,40947985,40978942,41135518,41291121,40854410,41322438,41072637,41198154,40916597,21056659,21125195,43213340,43213341,43147447,43191482,40854409,43158618,40969324,41166771,41125700,41000655,40947984,41125699,41291120,41141194,36894797,35745546,36277562,43258655,35754241,35746636,35750798,36273104,36263493,35750799,35746637,43037193,43037194,43037195,43037196,43037197,43037198,43037199,43037200,41015798,43202521,40828756,40982683,42479568,41268992,41268991,43158615,41144590,36224220,1356211,1356212,36810697,43037184,44055847,44082788,45775116,43625059,43697194,43787036,43787035,43787033,43841226,43715101,43607129,43661411,43751080,43697193,43733130,43823113,43715102,43679353,43625058,43697192,43841227,43733129,43643304,43805028,43841225,43787034,43679352,41044828,40866055,41209780,41209781,40928208,40842423,40998389,40873665,40842422,41234356,43136581,45775122,40746097,40746096,40746095,21037089,36788095,44165759,36788094,21066585,21135185,45775126,45775127,40746094,40746093,45775124,21076490,43213417,43213418,43202596,43191563,35411040,43169576,41107677,40897236,41248226,41109399,44175580,44172459,44180743,44183164,40746100,40746099,36246958,21174574,43751079,43180629,21174575,43823112,45775117,45775119,40746098,36248746,36239885,1137529,43840087,43858147,43749839,43642094,43785891,43803860,43696055,43587928,43785890,43605982,43642093,43821961,43731910,43767853,43587927,43642092,43587930,43803861,43840091,43785894,43840088,43660247,43840090,43731909,43623838,43713891,43840086,43840085,43660246,43821962,43858150,43840092,43858151,43731913,43623839,43803862,43803863,1137536,1137534,19004165,19045230,43194099,21022346,44164392,44172389,44180487,40742239,40742238,40742237,40742236,40742227,40742226,40742225,44173033,40742234,40742233,40742228,40742231,40742229,40742232,40742235,40742230,40742241,40742240,40742224,40742223,40742278,36787271,40742277,40742276,40742275,40742274,40742264,40742263,40742262,40742272,36787270,40742271,40742270,40742265,40742268,40742266,40742269,40742273,40742267,40742280,40742279,40742261,40742260,36885860,44180488,21120395,21090942,21159873,21071494,21140068,21090943,21100881,21090944,21042023,21051766,21159874,21071496,21032076,21071495,21169664,21042022,21120396,783091,783092,44045246,44176803,40742257,40742256,40742255,40742254,40742246,40742245,40742244,44111335,40742252,40742251,44126964,40742249,40742247,40742250,40742253,40742248,40742259,40742258,40742243,40742242,21120394,21071493,40742281,21159872,40952670,41146709,40933888,40996404,40965090,41302057,41177626,41302056,40871663,40933887,41090179,41320006,41101630,41195634,41132965,41226700,41215288,41132964,41320005,41007825,41038885,37592730,36504581,43194100,43215975,43205056,43172137,43183118,43027822,43150001,36266643,36259535,36262098,36264703,36265110,36265108,36266133,36265109,36258710,36269253,36894149,40919903,40921486,40865418,40871662,41052301,41121390,41058585,41152933,41270974,41027421,41277161,40990131,41277160,41215287,40983790,41295883,41046211,41177625,40933886,40996403,40990130,40871661,40902701,40890517,36891187,40888904,36892744,43587931,43749846,43749845,21120397,1137537,44171923,42903330,44161731,42902715,21149922,21081204,21169665,21042025,21042024,21032077,21100882,36892743,36787273,40742284,35771418,43290124,36787272,35774097,35748917,35765509,35748918,35753063,40742282,40742283,35757247,35748919,40167701,43268421,41202993,42478849,40965088,41246290,41277158,40902698,41052300,41083914,40896606,21110706,21061561,21110707,21090946,21042026,21042027,41027419,41308326,41132960,41101628,41164313,41058583,21130147,21022347,40945515,41101627,21061562,21130149,21130148,21140069,21090947,994819,21081205,21130146,43215976,43215977,36404388,36408190,36408966,36406363,36408189,36404843,36407676,36405337,36404066,36403779,36404065,36407179,36405336,36405597,36409453,36406362,21169666,43194101,41294329,41171561,41146706,41121388,40958876,41121387,41121386,41234014,36879552,41202994,41146708,40958877,40840533,40821158,41257544,41257543,41302055,40902699,41152932,40865417,41115141,41146707,41021109,40965089,41121389,41152931,40851960,41132963,41027420,41308327,41132962,41038884,41132961,40851961,41101629,40945516,40921485,41075953,40827956,41021111,41277159,41215286,41021110,41209163,40902700,41058584,41320004,41090178,41070184,41171562,40167702,41299304,40742286,41299303,40167703,43215974,40742287,40742285,36224092,35158799,36810866,35161400,36814154,36811737,783089,783090,1356189,1356190,1593824,36229015,36248858,36246959,36243012,792489,19043191,35156111,35133351,35141839,41294109,41202732,41295638,19043198,40827687,41045971,42926120,42926122,42926130,42926123,42926124,42926134,42926121,42926128,42926135,42926125,42926129,42926137,42926132,42925841,42926131,42926133,42926126,42926127,42926136,19091932,42926159,42926167,35157521,42926160,42926161,42926172,42926158,42926165,42926173,42926162,42926166,42926175,42926169,42926170,42926168,42926171,42926163,42926176,42926164,42926174,19043199,42926199,42926207,41045970,40952420,42926200,42926212,42926198,42926205,42926201,42926213,42926202,42926206,42926215,42926209,42926210,42926208,42926211,42926203,42926216,42926204,42926214,36222931,36222932,36222933,36247872,36248472,36243525,36243526,43532539,43158363,21135095,43034849,43147164,44026327,43532540,42716181,41107129,40950781,43180317,43024344,1366412)

) I
) C
;

with primary_events (event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id) as
(
-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 2))
) C


-- End Drug Exposure Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events

)
SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM primary_events pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

with cteIncludedEvents(event_id, person_id, start_date, end_date, op_start_date, op_end_date, ordinal) as
(
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

)
select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM cteIncludedEvents Results

;

-- custom era strategy

with ctePersons(person_id) as (
	select distinct person_id from #included_events
)

select person_id, drug_exposure_start_date, drug_exposure_end_date
INTO #drugTarget
FROM (
	select de.PERSON_ID, DRUG_EXPOSURE_START_DATE, COALESCE(DRUG_EXPOSURE_END_DATE, DATEADD(day,DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,DRUG_EXPOSURE_START_DATE)) as DRUG_EXPOSURE_END_DATE 
	FROM @cdm_database_schema.DRUG_EXPOSURE de
	JOIN ctePersons p on de.person_id = p.person_id
	JOIN #Codesets cs on cs.codeset_id = 2 AND de.drug_concept_id = cs.concept_id

	UNION ALL

	select de.PERSON_ID, DRUG_EXPOSURE_START_DATE, COALESCE(DRUG_EXPOSURE_END_DATE, DATEADD(day,DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,DRUG_EXPOSURE_START_DATE)) as DRUG_EXPOSURE_END_DATE 
	FROM @cdm_database_schema.DRUG_EXPOSURE de
	JOIN ctePersons p on de.person_id = p.person_id
	JOIN #Codesets cs on cs.codeset_id = 2 AND de.drug_source_concept_id = cs.concept_id
) E
;

select et.event_id, et.person_id, ERAS.era_end_date as end_date
INTO #strategy_ends
from #included_events et
JOIN 
(
  select ENDS.person_id, min(drug_exposure_start_date) as era_start_date, DATEADD(day,0, ENDS.era_end_date) as era_end_date
  from
  (
    select de.person_id, de.drug_exposure_start_date, MIN(e.END_DATE) as era_end_date
    FROM #drugTarget DE
    JOIN 
    (
      --cteEndDates
      select PERSON_ID, DATEADD(day,-1 * 30,EVENT_DATE) as END_DATE -- unpad the end date by 30
      FROM
      (
				select PERSON_ID, EVENT_DATE, EVENT_TYPE, 
				MAX(START_ORDINAL) OVER (PARTITION BY PERSON_ID ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal,
				ROW_NUMBER() OVER (PARTITION BY PERSON_ID ORDER BY EVENT_DATE, EVENT_TYPE) AS OVERALL_ORD -- this re-numbers the inner UNION so all rows are numbered ordered by the event date
				from
				(
					-- select the start dates, assigning a row number to each
					Select PERSON_ID, DRUG_EXPOSURE_START_DATE AS EVENT_DATE, 0 as EVENT_TYPE, ROW_NUMBER() OVER (PARTITION BY PERSON_ID ORDER BY DRUG_EXPOSURE_START_DATE) as START_ORDINAL
					from #drugTarget D

					UNION ALL

					-- add the end dates with NULL as the row number, padding the end dates by 30 to allow a grace period for overlapping ranges.
					select PERSON_ID, DATEADD(day,30,DRUG_EXPOSURE_END_DATE), 1 as EVENT_TYPE, NULL
					FROM #drugTarget D
				) RAWDATA
      ) E
      WHERE 2 * E.START_ORDINAL - E.OVERALL_ORD = 0
    ) E on DE.PERSON_ID = E.PERSON_ID and E.END_DATE >= DE.DRUG_EXPOSURE_START_DATE
    GROUP BY de.person_id, de.drug_exposure_start_date
  ) ENDS
  GROUP BY ENDS.person_id, ENDS.era_end_date
) ERAS on ERAS.person_id = et.person_id 
WHERE et.start_date between ERAS.era_start_date and ERAS.era_end_date;

TRUNCATE TABLE #drugTarget;
DROP TABLE #drugTarget;


-- generate cohort periods into #final_cohort
with cohort_ends (event_id, person_id, end_date) as
(
	-- cohort exit dates
  -- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
UNION ALL
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

),
first_ends (person_id, start_date, end_date) as
(
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, E.end_date, row_number() over (partition by I.person_id, I.event_id order by E.end_date) as ordinal 
	  from #included_events I
	  join cohort_ends E on I.event_id = E.event_id and I.person_id = E.person_id and E.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
)
select person_id, start_date, end_date
INTO #cohort_rows
from first_ends;

with cteEndDates (person_id, end_date) AS -- the magic
(	
	SELECT
		person_id
		, DATEADD(day,-1 * 30, event_date)  as end_date
	FROM
	(
		SELECT
			person_id
			, event_date
			, event_type
			, MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal 
			, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type) AS overall_ord
		FROM
		(
			SELECT
				person_id
				, start_date AS event_date
				, -1 AS event_type
				, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
			FROM #cohort_rows
		
			UNION ALL
		

			SELECT
				person_id
				, DATEADD(day,30,end_date) as end_date
				, 1 AS event_type
				, NULL
			FROM #cohort_rows
		) RAWDATA
	) e
	WHERE (2 * e.start_ordinal) - e.overall_ord = 0
),
cteEnds (person_id, start_date, end_date) AS
(
	SELECT
		 c.person_id
		, c.start_date
		, MIN(e.end_date) AS end_date
	FROM #cohort_rows c
	JOIN cteEndDates e ON c.person_id = e.person_id AND e.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
)
select person_id, min(start_date) as start_date, end_date
into #final_cohort
from cteEnds
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;