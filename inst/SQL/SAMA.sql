CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (1112921,19018882)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (1112921,19018882)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (43705671,43867885,43795492,41365138,41371534,41363270,41367723,41372512,41373290,41370784,41370031,41361277,41362960,41371979,41362199,41365137,41372304,41369272,41371533,41367722,41364239,41367940,41370259,41366218,41366671,41365456,41366990,41366670,41367393,41373054,41364240,41372305,41365457,41369505,41361166,41369273,43826155,43664457,43808054,43826156,43772126,43826157,43610098,43628179,43808053,43718036,43772125,43754065,43646293,43736206,43754066,43844241,43718038,43664460,43664461,43646294,43826158,43700313,43862424,43664458,43862423,43718037,43664459,41362151,41365379,41372999,41362921,41371147,41373001,36418617,41362468,41370973,41363469,41366433,41373258,41367912,41365380,37593938,41370405,41369631,41365091,41373000,41372240,41370233,41364367,41366144,41363197,41368396,41365664,41361951,41363468,41361950,41364223,41367174,41366432,41366431,41371751,41370714,41370715,41361949,41362736,41366430,41364222,41373255,41367173,41370972,41369482,41372490,41373257,41364918,41365665,41373256,41371146,41368070,41361384,41370404,41368395,41370971,43646295,43789948,43700316,43700317,43862425,43628180,43844242,43844243,43664463,43700315,43718040,43700314,43664462,43718039,43826159,35143262,40243202,40243203,41375222,41375428,41374814,41373600,41373590,41375016,41374552,41373755,41375476,41374551,41373908,41374880,41375787,41375182,41374062,41375330,41374550,41374061,41375475,41376059,41374060,41374722,41373622,41375829,41375131,41374815,41375619,41374219,41374881,41375018,41375478,41375620,41374063,41373909,41374553,41375017,41374218,41375477,41376061,41375184,41376060,41375183,41375223,41374903,41373847,41374000,41374381,41375922,41373905,41376006,41373751,41374166,41375329,41373750,41374380,41374057,41375616,41375181,41376056,41375328,41375327,41374877,41375326,41375783,41375782,41374876,41373904,41374720,41375366,41374259,41375959,41375509,41376005,41373846,41374318,41375325,41373747,41373903,41375116,41374875,41375010,41374874,41375920,41374873,41375009,41373748,41373902,41374165,41375919,41374872,41375180,41375011,41373749,41375921,41374719,41375474,41374102,41375958,41375365,41373780,41373781,41374001,41374382,41375784,41374095,41374094,41375553,41375700,41373932,41375048,41374802,41373987,41373898,41374899,41374943,36809291,36809184,36809249,36809244,43038756,43038755,36809199,36809233,43038760,43038759,43038758,43038757,36809203,36809263,36809284,36809265,36809185,36809222,36809215,36809220,36809240,36809285,36809311,36809252,36809245,43038761,41487034,41487330,36417214,41485621,36417215,41485539,41484306,41484613,41487626,41487676,41487297,1154660,1113078,40710390,40710389,40710386,40710388,40710387,40710918,40710917,40710914,40710916,40710915,44218074,44218083,44217944,44218001,44217982,44218000,44218082,44217999,44217943,44218104,40710439,40710438,21177691,36283929,36778158,36778157,36283939,785036,43043754,43043755,40710442,40710441,40710440,44218125,44218029,44217828,44217998,44217940,44218102,44217857,44218144,44218143,44217939,44218142,44218049,44218100,44217826,44217825,44218080,44217936,35798503,35798557,35798571,35798516,35798536,35798570,35798517,35798537,35798552,35798484,35798605,44218103,44217827,44217807,44217858,44218145,44218101,44218051,44217997,44218050,44217938,44217996,44217937,44217856,44218028,44217995,43522492,43522490,40710403,40710398,40710392,40710391,40710393,40710397,40710396,40710395,40710399,40710394,40710402,40710400,40710401,40710405,40710404,40710433,40710428,40710422,40710421,40710423,40710427,40710426,40710425,40710429,40710424,40710432,40710430,40710431,40710435,40710434,785037,785040,785041,785042,43043756,785038,40710418,40710413,40710407,40710406,36778155,36778154,40710408,40710412,40710411,40710410,40710414,40710409,36778156,40710417,40710415,40710416,40710420,40710419,36809353,1113041,1113079,1113072,19134102,36809373,41379666,41377254,41377605,41376876,41381564,41376627,41381198,41378451,41381565,41378860,41382204,41379237,41380805,41381827,41378450,41377727,41381197,41376997,41377376,41378928,41378161,41378927,41376698,41379665,41376875,41379841,41379968,41379467,41376996,41380892,41376316,41377427,41380429,41376288,41376460,41379816,41376838,41376980,41380785,41381626,41380865,41377426,41379815,41377574,41381789,36896572,41431313,41431026,43614009,41431691,41431647,41431282,41431408,43793892,43668328,41431626,41431594,41431750,41431839,43775961,41431690,41431165,41431900,41431107,41431838,43775962,21167629,44135474,44135468,44135484,44135466,21167630,21138019,40717393,21030094,21049729,21177375,21098830,40717394,21039932,21079221,21177374,21128166,36281881,36281886,21069470,21108658,21098833,21167633,21118397,21088940,21069471,21098832,21177376,21167632,21128167,21108656,21108657,21167631,21098831,21039933,21088939,36281819,36281846,36281854,36281900,36281926,44135465,44135485,21030095,21128168,40717391,35788209,21079222,40717392,35788210,21039934,44135480,44135472,43632174,43650291,43686244,43686245,43775974,43632172,43866352,43614022,43704186,43848099,43848100,43848102,43650292,43757987,43830058,43632173,43812048,43740086,43757988,43614020,43614021,43866353,43596093,43866354,43596094,43650293,43866355,43848101,43812049,43757989,43721962,43686243,43704185,43775973,43793900,43686246,43596096,43793901,43721963,43650294,43650295,43793902,43686248,43812050,43721964,43614023,43686247,43740087,43866356,43830059,43596095,43848103,43614024,43632175,43614025,43757990,36418796,36418794,36418793,36418795,784245,36809579,36809623,36809592,36809611,36809608,43039486,43039488,43039487,43039484,43039482,43039485,43039483,43039481,36809563,36809562,36809603,36809580,36809596,36809609,36809604,36809599,36809568,36809564,36809588,36809616,36809602,36809575,36809560,36809630,41346261,41344926,41343502,40710234,40710233,40709814,40709813,40709812,40709811,44218215,44218209,44218196,44218275,44218274,44218248,44218208,44218247,44218207,44218273,44218258,44218198,44218206,44218239,44218197,44218223,44218189,44218238,44218222,44218221,44218211,44218262,44218224,44218199,44218244,44218272,44218265,44218267,44218204,44218194,41385257,41388533,41386848,41388357,44194817,41385486,41385256,41385258,41387950,41389074,41389173,41385549,41390110,41390109,41389832,41389637,41389661,41389715,41390335,41389938,41389831,41439878,41439874,41439883,41439880,36809819,43706745,43634865,43598713,43755782,43719693,43864121,41444750,41444781,41444815,41444836,41444791,41444763,41444800,41444831,41444726,41444785,41444747,41444812,41444830,41444796,41444823,35146129,35144772,19021327,42902622,42902809,44080150,44084296,44125109,44037182,40727739,40727738,40727735,40727737,40727736,40727732,40727734,40727733,40243275,42903409,42903280,43560453,43560451,43560452,43585032,36889752,40897884,40835657,43729034,40844650,41125490,43855161,40875846,41031528,40906753,40875845,40821820,43837214,41078381,44026104,21099391,44034431,44099163,44123231,21030633,21030634,36273092,21118934,44127924,21089484,21148465,36268008,36265427,36262865,44111925,21138591,21118935,44060504,21138590,36259084,44041403,21109241,44028421,43011917,40727741,40727740,36215322,1356123,36812203,1356124,36813156,783785,36812756,40142665,40142666,36233594,36233595,36233596,36233597,36219436,36219499,43818574,43746514,43728595,40891609,40929609,41251938,41127152,41272962,40922586,41110171,41179732,41095923,40846320,41095922,40908457,40877449,41023098,41179731,40898507,40836320,41033184,40939699,41002116,41189787,41064345,40891610,40953803,41242070,41002115,41127153,41211171,41110172,41211172,41095924,40939700,41023099,21099388,44175685,44183804,44181136,44166196,44177422,44168234,40727828,40727827,21089481,36260439,36783914,783780,43034241,43145331,43167453,43200458,43145332,43200459,43200460,40727831,40727830,40727829,40922585,43167454,43211266,40877448,40939698,41220947,40908456,41304069,43156522,41148643,40929608,43200461,43189428,43156523,36811310,43638701,44160648,44187566,44162373,41265972,41047380,41117166,41158610,41189788,41158609,41141533,36889755,41282807,40846321,40836321,41016084,41272963,40824959,43134418,41019257,43167452,41113279,40727834,40727832,40727833,36811735,43034240,36811152,1112921,41170405,41234748,40960295,40875847,36420898,41188100,36420899,40991514,44104659,44106068,44058570,44034435,44127925,44073285,44063341,44041406,43766217,43766218,43856466,43604395,43604388,43586236,43586237,43820347,43586240,43712278,43766208,43730313,43586238,43586239,43838430,40828708,41022490,41125495,41000456,40991518,43640469,43712280,43658598,43586241,43856460,43712281,43766209,43766210,43784325,43730314,43622300,43604389,44080151,40889396,41234749,41053774,41312472,41250330,40897886,44104658,44054481,40889397,41046968,41303441,41000455,41156994,40866760,40991517,41188104,41125494,41125493,40938125,40928986,41241461,41148025,41232881,41078383,40991519,41000458,36420897,41125497,40938126,40897888,41303442,41053776,40906758,41125496,40984596,41013967,41170406,40858095,41265560,40928985,41062683,41250329,40938123,41000453,41312470,41179058,41241457,40897885,40866756,40823203,41234747,41210523,40938122,40938121,41281154,40991513,41116512,36266774,44180016,44188532,44180986,44097209,35775714,35753554,35753553,35757723,35770291,35745205,35761911,35765989,35761912,35765990,44164410,44127926,44188531,36420905,36420904,36420903,36420901,36420900,36420902,36888150,43514751,43515697,44119078,36892641,43856462,43640471,43784326,43151414,44158859,40727782,40727781,40728344,40727750,40727744,40727743,40727745,40727749,40727748,40727747,40727751,40727746,40728343,40728341,40728342,40728346,40728345,40727778,40727773,40727767,40727766,40727768,40727772,40727771,40727770,40727774,40727769,40727777,40727775,40727776,40727780,40727779,44168810,44184680,783783,783784,783782,40727783,40727762,40727757,40728348,40728347,36783905,40727752,40727756,40727755,40727754,40727758,40727753,36783906,40727761,40727759,40727760,40727764,40727763,43151415,41210526,41281155,40906756,40906757,41312473,40866758,41241460,40866757,36503488,36504643,43217302,43206350,43140424,43206351,43173595,36503951,36887409,21040497,36812216,36812550,21060107,21158419,21118931,21109239,21030631,21118932,21079775,36405984,36406139,36406961,36408729,36407991,36404436,36258950,36264213,36812312,783781,36814018,36814687,36811591,36813855,43712279,42937982,41013968,44160539,44160635,44164961,44184679,41078382,40991516,41188103,41094281,40978903,41062686,41312477,40978902,40947939,41085319,41272263,40897887,43622302,36883826,43586242,43766219,43730318,43694453,43838431,43658604,43622303,43676647,43604391,43838435,43838432,43694454,43766215,43802219,43766214,43730316,43838433,43604392,43766216,43748224,43802220,43784328,43856467,43802221,43658606,43658607,43676648,43712283,43748226,43766220,43658605,43784329,43658602,43694455,36888151,43184443,44028422,44032578,44125111,44037184,44034434,44063340,44119075,36881435,41265561,43766213,40821732,41000454,40844651,41312474,40938124,41188101,41303440,41303439,41272262,40835658,41219295,36891661,41062685,41312476,41156993,41125491,41312475,43640472,43802218,43712282,43820348,43622301,40866759,36889681,43802217,43730315,36880967,41053775,40953425,43034244,43034245,19121770,19121771,43603298,43818604,43272421,19110458,43603296,41013969,41148026,41062687,40984595,40982670,41265562,41210527,41281156,40858094,44183093,1113040,19020431,42902473,42902844,1113037,19020432,42902912,42903367,1113038,19020433,40167148,40167149,40243945,19134092,19020410,43560558,1113075,19020434,1113076,1113102,42483253,42482630,40727787,40727788,40822942,36509737,44081549,35758047,36224638,36811485,36812987,36811274,36810841,1356213,1356214,36811941,36814567,40143214,40143215,40727789,40727790,44164597,36224639,36224640,36226697,19018882,35157213,35144897,35139962,35148739,40982417,41084504,41147270,41216953,41185657,41046540,40857843,41052935,40959489,40935663,41310085,41265160,41044814,41178280,41271531,41091907,41123081,41296226,40920111,40990719,40865992,40959490,40904385,40998138,40873444,40859533,41232633,36812204,36814080,36812467,41147269,41271533,40990718,41021692,40966772,41185656,40946429,40884124,41060312,40998137,41102573,40977410,40859532,40951274,40865991,41115740,41178279,41029184,40904384,40842194,41265161,41263378,41271532,41178281,40966771,41154585,40828265,40982416,41084503,41115741,40990717,41240709,40998136,40842195,41310086,41278774,41015346,40861610,41081342,36810762,36813254,35147090,35133237,36242504,36242505)

) I
) C UNION ALL 
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (43826155,43664457,43808054,43826156,43772126,43826157,43610098,43628179,43808053,43718036,43772125,43754065,43646293,43736206,43754066,43844241,43718038,43664460,43664461,43646294,43826158,43700313,43862424,43664458,43862423,43718037,43664459,41362151,41365379,41372999,41362921,41371147,41373001,36418617,41362468,41370973,41363469,41366433,41373258,41367912,41365380,37593938,41370405,41369631,41365091,41373000,41372240,41370233,41364367,41366144,41363197,41368396,41365664,41361951,41363468,41361950,41364223,41367174,41366432,41366431,41371751,41370714,41370715,41361949,41362736,41366430,41364222,41373255,41367173,41370972,41369482,41372490,41373257,41364918,41365665,41373256,41371146,41368070,41361384,41370404,41368395,41370971,43646295,43789948,43700316,43700317,43862425,43628180,43844242,43844243,43664463,43700315,43718040,43700314,43664462,43718039,43826159,35143262,41374903,41373847,41374000,41374381,41375922,41373905,41376006,41373751,41374166,41375329,41373750,41374380,41374057,41375616,41375181,41376056,41375328,41375327,41374877,41375326,41375783,41375782,41374876,41373904,41374720,41375366,41374259,41375959,41375509,41376005,41373846,41374318,41375325,41373747,41373903,41375116,41374875,41375010,41374874,41375920,41374873,41375009,41373748,41373902,41374165,41375919,41374872,41375180,41375011,41373749,41375921,41374719,41375474,41374102,41375958,41375365,41373780,41373781,41374001,41374382,41375784,41374095,41374094,41375553,41375700,41373932,41375048,41374802,41373987,41373898,41374899,41374943,36809291,36809184,36809249,36809244,43038756,43038755,36809199,36809233,43038760,43038759,43038758,43038757,36809203,36809263,36809284,36809265,36809185,36809222,36809215,36809220,36809240,36809285,36809311,36809252,36809245,43038761,41487034,41487330,36417214,41485621,36417215,41485539,41484306,41484613,41487626,41487676,41487297,44218125,44218029,44217828,44217998,44217940,44218102,44217857,44218144,44218143,44217939,44218142,44218049,44218100,44217826,44217825,44218080,44217936,35798503,35798557,35798571,35798516,35798536,35798570,35798517,35798537,35798552,35798484,35798605,44218103,44217827,44217807,44217858,44218145,44218101,44218051,44217997,44218050,44217938,44217996,44217937,44217856,44218028,44217995,43522492,43522490,40710403,40710398,40710392,40710391,40710393,40710397,40710396,40710395,40710399,40710394,40710402,40710400,40710401,40710405,40710404,40710433,40710428,40710422,40710421,40710423,40710427,40710426,40710425,40710429,40710424,40710432,40710430,40710431,40710435,40710434,785037,785040,785041,785042,43043756,785038,40710418,40710413,40710407,40710406,36778155,36778154,40710408,40710412,40710411,40710410,40710414,40710409,36778156,40710417,40710415,40710416,40710420,40710419,36809353,1113041,1113079,1113072,19134102,36809373,41379666,41377254,41377605,41376876,41381564,41376627,41381198,41378451,41381565,41378860,41382204,41379237,41380805,41381827,41378450,41377727,41381197,41376997,41377376,41378928,41378161,41378927,41376698,41379665,41376875,41379841,41379968,41379467,41376996,41380892,41376316,41377427,41380429,41376288,41376460,41379816,41376838,41376980,41380785,41381626,41380865,41377426,41379815,41377574,41381789,43632174,43650291,43686244,43686245,43775974,43632172,43866352,43614022,43704186,43848099,43848100,43848102,43650292,43757987,43830058,43632173,43812048,43740086,43757988,43614020,43614021,43866353,43596093,43866354,43596094,43650293,43866355,43848101,43812049,43757989,43721962,43686243,43704185,43775973,43793900,43686246,43596096,43793901,43721963,43650294,43650295,43793902,43686248,43812050,43721964,43614023,43686247,43740087,43866356,43830059,43596095,43848103,43614024,43632175,43614025,43757990,36418796,36418794,36418793,36418795,784245,36809579,36809623,36809592,36809611,36809608,43039486,43039488,43039487,43039484,43039482,43039485,43039483,43039481,36809563,36809562,36809603,36809580,36809596,36809609,36809604,36809599,36809568,36809564,36809588,36809616,36809602,36809575,36809560,36809630,41346261,41344926,41343502,44218199,44218244,44218272,44218265,44218267,44218204,44218194,41385257,41388533,41386848,41388357,41385486,44194817,41385256,41385258,41387950,41389074,41389173,41385549,41390110,41390109,41389832,41389637,41389661,41389715,41390335,41389938,41389831,43706745,43634865,43598713,41444750,41444781,41444815,41444836,41444791,41444763,41444800,41444831,41444726,41444785,41444747,41444812,41444830,41444796,41444823,35146129,35144772,36215322,36233594,36233595,36233596,36233597,36219436,36219499,1112921,41170405,41234748,40960295,40875847,36420898,41188100,36420899,40991514,44104659,44106068,44058570,44034435,44127925,44073285,44063341,44041406,43766217,43766218,43856466,43604395,43604388,43586236,43586237,43820347,43586240,43712278,43766208,43730313,43586238,43586239,43838430,40828708,41022490,41125495,41000456,40991518,43640469,43712280,43658598,43586241,43856460,43712281,43766209,43766210,43784325,43730314,43622300,43604389,44080151,40889396,41234749,41053774,41312472,41250330,40897886,44104658,44054481,40889397,41046968,41303441,41000455,41156994,40866760,40991517,41188104,41125494,41125493,40938125,40928986,41241461,41148025,41232881,41078383,40991519,41000458,36420897,41125497,40938126,40897888,41303442,41053776,40906758,41125496,40984596,41013967,41170406,40858095,41265560,40928985,41062683,41250329,40938123,41000453,41312470,41179058,41241457,40897885,40866756,40823203,41234747,41210523,40938122,40938121,41281154,40991513,41116512,36266774,44180016,44188532,44180986,44097209,35775714,35753554,35753553,35757723,35770291,35745205,35761911,35765989,35761912,35765990,44164410,44127926,44188531,36420905,36420904,36420903,36420901,36420900,36420902,36888150,43514751,43515697,44119078,36892641,43856462,43640471,43784326,43151414,44158859,40727782,40727781,40728344,40727750,40727744,40727743,40727745,40727749,40727748,40727747,40727751,40727746,40728343,40728341,40728342,40728346,40728345,40727778,40727773,40727767,40727766,40727768,40727772,40727771,40727770,40727774,40727769,40727777,40727775,40727776,40727780,40727779,44168810,44184680,783783,783784,783782,40727783,40727762,40727757,40728348,40728347,36783905,40727752,40727756,40727755,40727754,40727758,40727753,36783906,40727761,40727759,40727760,40727764,40727763,43151415,41210526,41281155,40906756,40906757,41312473,40866758,41241460,40866757,36503488,36504643,43217302,43206350,43140424,43206351,43173595,36503951,36887409,21040497,36812216,36812550,21060107,21158419,21118931,21109239,21030631,21118932,21079775,36405984,36406139,36406961,36408729,36407991,36404436,36258950,36812312,783781,36814018,36814687,36811591,36813855,43712279,42937982,41013968,44160539,44160635,44164961,44184679,41078382,40991516,41188103,41094281,40978903,41062686,41312477,40978902,40947939,41085319,41272263,40897887,43622302,36883826,43586242,43766219,43730318,43694453,43838431,43658604,43622303,43676647,43604391,43838435,43838432,43694454,43766215,43802219,43766214,43730316,43838433,43604392,43766216,43748224,43802220,43784328,43856467,43802221,43658606,43658607,43676648,43712283,43748226,43766220,43658605,43784329,43658602,43694455,36888151,43184443,44028422,44032578,44125111,44037184,44034434,44063340,44119075,36881435,41265561,43766213,40821732,41000454,40844651,41312474,40938124,41188101,41303440,41303439,41272262,40835658,41219295,36891661,41062685,41312476,41156993,41125491,41312475,43640472,43802218,43712282,43820348,43622301,40866759,36889681,43802217,43730315,36880967,41053775,40953425,43034244,43034245,19121770,19121771,43603298,19110458,43603296,41013969,41148026,41062687,40984595,40982670,41265562,41210527,41281156,40858094,44183093,1113040,19020431,42902473,42902844,1113037,19020432,42902912,42903367,1113038,19020433,40167148,40167149,40243945,19134092,19020410,43560558,1113075,19020434,1113076,1113102,42483253,42482630,40727787,40727788,40822942,36509737,44081549,35758047,36224638,36811485,36812987,36811274,36810841,1356213,1356214,36811941,36814567,40143214,40143215,40727789,40727790,44164597,36224639,36224640,36226697,19018882,35157213,35144897,35139962,35148739,40982417,41084504,41147270,41216953,41185657,41046540,40857843,41052935,40959489,40935663,41310085,41265160,41044814,41178280,41271531,41091907,41123081,41296226,40920111,40990719,40865992,40959490,40904385,40998138,40873444,40859533,41232633,36812204,36814080,36812467,41147269,41271533,40990718,41021692,40966772,41185656,40946429,40884124,41060312,40998137,41102573,40977410,40859532,40951274,40865991,41115740,41178279,41029184,40904384,40842194,41265161,41263378,41271532,41178281,40966771,41154585,40828265,40982416,41084503,41115741,40990717,41240709,40998136,40842195,41310086,41278774,41015346,40861610,41081342,36810762,36813254,35147090,35133237,36242504,36242505)

) I
) C
;

with primary_events (event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id) as
(
-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 2))
) C


-- End Drug Exposure Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events

)
SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM primary_events pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

with cteIncludedEvents(event_id, person_id, start_date, end_date, op_start_date, op_end_date, ordinal) as
(
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

)
select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM cteIncludedEvents Results

;

-- custom era strategy

with ctePersons(person_id) as (
	select distinct person_id from #included_events
)

select person_id, drug_exposure_start_date, drug_exposure_end_date
INTO #drugTarget
FROM (
	select de.PERSON_ID, DRUG_EXPOSURE_START_DATE, COALESCE(DRUG_EXPOSURE_END_DATE, DATEADD(day,DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,DRUG_EXPOSURE_START_DATE)) as DRUG_EXPOSURE_END_DATE 
	FROM @cdm_database_schema.DRUG_EXPOSURE de
	JOIN ctePersons p on de.person_id = p.person_id
	JOIN #Codesets cs on cs.codeset_id = 2 AND de.drug_concept_id = cs.concept_id

	UNION ALL

	select de.PERSON_ID, DRUG_EXPOSURE_START_DATE, COALESCE(DRUG_EXPOSURE_END_DATE, DATEADD(day,DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,DRUG_EXPOSURE_START_DATE)) as DRUG_EXPOSURE_END_DATE 
	FROM @cdm_database_schema.DRUG_EXPOSURE de
	JOIN ctePersons p on de.person_id = p.person_id
	JOIN #Codesets cs on cs.codeset_id = 2 AND de.drug_source_concept_id = cs.concept_id
) E
;

select et.event_id, et.person_id, ERAS.era_end_date as end_date
INTO #strategy_ends
from #included_events et
JOIN 
(
  select ENDS.person_id, min(drug_exposure_start_date) as era_start_date, DATEADD(day,0, ENDS.era_end_date) as era_end_date
  from
  (
    select de.person_id, de.drug_exposure_start_date, MIN(e.END_DATE) as era_end_date
    FROM #drugTarget DE
    JOIN 
    (
      --cteEndDates
      select PERSON_ID, DATEADD(day,-1 * 30,EVENT_DATE) as END_DATE -- unpad the end date by 30
      FROM
      (
				select PERSON_ID, EVENT_DATE, EVENT_TYPE, 
				MAX(START_ORDINAL) OVER (PARTITION BY PERSON_ID ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal,
				ROW_NUMBER() OVER (PARTITION BY PERSON_ID ORDER BY EVENT_DATE, EVENT_TYPE) AS OVERALL_ORD -- this re-numbers the inner UNION so all rows are numbered ordered by the event date
				from
				(
					-- select the start dates, assigning a row number to each
					Select PERSON_ID, DRUG_EXPOSURE_START_DATE AS EVENT_DATE, 0 as EVENT_TYPE, ROW_NUMBER() OVER (PARTITION BY PERSON_ID ORDER BY DRUG_EXPOSURE_START_DATE) as START_ORDINAL
					from #drugTarget D

					UNION ALL

					-- add the end dates with NULL as the row number, padding the end dates by 30 to allow a grace period for overlapping ranges.
					select PERSON_ID, DATEADD(day,30,DRUG_EXPOSURE_END_DATE), 1 as EVENT_TYPE, NULL
					FROM #drugTarget D
				) RAWDATA
      ) E
      WHERE 2 * E.START_ORDINAL - E.OVERALL_ORD = 0
    ) E on DE.PERSON_ID = E.PERSON_ID and E.END_DATE >= DE.DRUG_EXPOSURE_START_DATE
    GROUP BY de.person_id, de.drug_exposure_start_date
  ) ENDS
  GROUP BY ENDS.person_id, ENDS.era_end_date
) ERAS on ERAS.person_id = et.person_id 
WHERE et.start_date between ERAS.era_start_date and ERAS.era_end_date;

TRUNCATE TABLE #drugTarget;
DROP TABLE #drugTarget;


-- generate cohort periods into #final_cohort
with cohort_ends (event_id, person_id, end_date) as
(
	-- cohort exit dates
  -- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
UNION ALL
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

),
first_ends (person_id, start_date, end_date) as
(
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, E.end_date, row_number() over (partition by I.person_id, I.event_id order by E.end_date) as ordinal 
	  from #included_events I
	  join cohort_ends E on I.event_id = E.event_id and I.person_id = E.person_id and E.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
)
select person_id, start_date, end_date
INTO #cohort_rows
from first_ends;

with cteEndDates (person_id, end_date) AS -- the magic
(	
	SELECT
		person_id
		, DATEADD(day,-1 * 30, event_date)  as end_date
	FROM
	(
		SELECT
			person_id
			, event_date
			, event_type
			, MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal 
			, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type) AS overall_ord
		FROM
		(
			SELECT
				person_id
				, start_date AS event_date
				, -1 AS event_type
				, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
			FROM #cohort_rows
		
			UNION ALL
		

			SELECT
				person_id
				, DATEADD(day,30,end_date) as end_date
				, 1 AS event_type
				, NULL
			FROM #cohort_rows
		) RAWDATA
	) e
	WHERE (2 * e.start_ordinal) - e.overall_ord = 0
),
cteEnds (person_id, start_date, end_date) AS
(
	SELECT
		 c.person_id
		, c.start_date
		, MIN(e.end_date) AS end_date
	FROM #cohort_rows c
	JOIN cteEndDates e ON c.person_id = e.person_id AND e.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
)
select person_id, min(start_date) as start_date, end_date
into #final_cohort
from cteEnds
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;