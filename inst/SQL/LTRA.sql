CREATE TABLE #Codesets (
  codeset_id int NOT NULL,
  concept_id bigint NOT NULL
)
;

INSERT INTO #Codesets (codeset_id, concept_id)
SELECT 0 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (43009091,1154161,43009065,1111706)
UNION  select c.concept_id
  from @vocabulary_database_schema.CONCEPT c
  join @vocabulary_database_schema.CONCEPT_ANCESTOR ca on c.concept_id = ca.descendant_concept_id
  and ca.ancestor_concept_id in (43009091,1154161,43009065,1111706)
  and c.invalid_reason is null

) I
) C UNION ALL 
SELECT 1 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (42917240,42917242,42917241,42918233,42918235,42918234,35154316,35156156,35159984,35144502,35153134,35135921,35154453,35153856,35146952,35138833,35134260,35143522,35156224,35160726,35148326,35145742,35137222,42917212,42917214,42917213,42918087,42918089,42918088,42920752,42920753,42920754,42920755,43758751,43651035,43812823,43632959,43740854,36896836,43867087,43596841,43740855,43812824,43686952,43830830,43848857,43848858,43794650,42918777,42918779,42918778,43597338,43849415,43795195,43723235,43867609,43759208,42918260,42918262,42918261,42918247,42918249,42918248,42918244,42918246,42918245,42917264,42917266,42917265,36221800,36221801,43009091,35152872,35130342,35151741,42959456,42959340,35132945,35147877,35143729,42959283,42959453,42959454,42959455,35131943,35135110,35157140,35154765,42959457,42959458,42959459,42964086,42964084,42964085,42964087,42964088,1154161,43804378,43732452,43714428,43696548,43786390,43678717,43606477,43660746,43660747,43840566,43786397,43786396,36886189,43660733,43804379,43858672,36892605,43696549,43660734,43696550,43822471,43858673,43786391,43732453,42964495,42964496,42964493,42964494,42964499,42964500,42964497,42964498,1154200,42964439,43732455,44054298,43256572,42964413,42964440,42964471,42964414,44105868,42964415,42964416,42964417,42964418,43206286,41178550,40835114,41302910,43184370,35760941,35744242,35765062,35756790,40746309,43026380,43026381,43026375,35744243,43026378,35765063,35756789,35756788,43026374,43026376,43026377,35748430,35769251,43026373,43026372,35769252,35752577,40746310,35752576,35744241,43026379,43206287,43026382,41021947,43217232,41116018,41116017,35760942,35773649,35765064,35773648,40746311,35756792,35769255,35769254,35769253,35748431,35744244,35760943,35769256,40746312,35752578,35756791,41279655,41279654,41310954,41123980,40874309,40843102,41186534,40874317,41165822,41217847,40947027,41061207,41040440,41186533,40936531,41259073,40843110,40915653,40874316,41165821,41123978,40999028,41071749,41092773,40822846,41123973,40915645,40999027,40999026,40915650,41310953,41165820,41155485,41259067,43217233,43173516,43162515,41061204,41155491,41134572,41061203,40915649,40936530,40884717,43151340,41248845,40947035,41279653,40978006,43184371,43195382,40874315,41009358,40936529,41061201,41071748,41061202,40947033,41186527,40853498,43173517,43140361,35407975,43217234,43217235,43162516,43173518,36260191,36267892,36266118,36260189,36261260,40936528,41217860,41103136,41217846,41071739,41310952,41165815,43151341,43162517,43184372,40843109,40905275,40884716,41092771,41197198,41123976,41228260,41092770,41186531,41009357,41310948,41321456,41030035,41197192,43195383,43217236,43173519,41030034,40843100,41290146,40967650,41197191,41310947,41228255,43162518,35409135,35407860,43151342,43151343,41155483,41092765,41197190,40905274,41217856,41259072,41217843,41259065,41217857,41071747,43151344,43217237,43184373,36788297,36272950,36271618,36270419,36263518,36788296,43140362,43217238,43195384,40874313,41030033,40884709,41123975,40843098,41259071,41310946,40915642,40874312,40843107,40915648,40999023,40947024,40936525,41259070,41217855,40821184,41259069,41217841,40915641,41155480,41321455,40843106,41186529,41071746,41217840,41165805,41217854,41228258,41092769,41061197,40915643,40936526,41103134,41310950,41009350,43217239,43184374,43151345,36788295,36788294,36260184,36266382,43206288,43140363,43162519,43173520,43206289,43206290,40936524,40936523,41134570,40967652,40853503,40936522,44171023,43195385,43140364,43140365,41030039,41217851,41071745,41217839,41009349,41217853,41165810,41155487,41134568,41186525,41228254,43184375,43184376,43217240,36275543,36258519,36257648,36788293,36271332,41155479,40999022,41259063,40936521,41197187,40936519,40915639,43206291,43217241,36788292,43195386,36260186,36258553,36257646,36788291,36266541,41310949,40967649,41009348,41217850,41197197,43162521,43173521,41279657,41103132,43151652,43173818,43151653,43195387,41030036,40884708,40915646,41103130,41228251,40978003,41228250,41040433,41134564,41134563,41259068,40853492,41321453,41321458,40967651,40843104,41290147,40978010,41103126,40824097,40853495,40884713,40884712,41197196,40947029,41290150,40853493,41071738,41071740,43162522,43195388,35744237,35748428,43140366,43206292,43140367,36266536,40746305,43026383,36788299,40746306,35744239,35744238,35754615,35773645,41217849,40947028,43151346,41009347,41009354,40853500,41071743,40915647,41071736,41134566,41009352,41228249,41197195,41134560,43151347,43026384,41134565,36260185,36263686,36788298,35756787,35744240,35773647,35765061,40746307,40746308,35769250,35748429,42964410,35157043,35129246,35162161,35145838,35134675,35130125,35152668,42964411,42964412,35158805,44041212,42964472,42964419,42964421,42964422,42964473,44067292,42964474,35147203,42964475,42964476,42964455,42964423,43294551,42964456,43732454,42964441,43768372,42964477,42964424,42964457,44041211,42964425,44054297,42964458,42964459,42964442,43858675,42964443,42964426,43278340,42964478,43272876,42964427,42964460,42964444,42964479,42964428,42964461,42964445,42964480,43660737,42964429,42964481,42964430,43714429,42964446,42964482,42964431,40828409,43696551,43732456,43140357,41203471,43173514,43750398,43217230,43184367,36271809,43660736,43140358,40890952,43678724,43606465,43162514,41046704,43217231,43804381,43840558,43206284,43140359,41234461,43822472,43804380,40953137,43606466,43750397,43184368,43804382,43206285,43140360,43840557,43151338,41296374,43151339,43840559,43858674,43184369,43624316,43660735,43624317,43184681,42964463,42964462,42964447,42964483,42964432,42964464,42964448,42964484,42964465,42964485,42964433,42964449,42964486,42964466,42964450,42964487,42964434,42964452,42964488,42964435,19023368,42964357,43696555,43678719,44111709,44088579,43261884,43267376,42964333,42964358,42964388,42964334,44034229,44036850,41021948,43283668,43289121,43289122,43272878,40866257,41147513,21032887,21082003,21032888,21062381,21121175,40746300,43294553,43256574,36812558,43283670,21062379,21062380,21091766,21082004,21101639,21130936,43256575,21091765,21101640,40746301,21111494,43283669,21111495,21130937,43267380,43272877,41271779,41302911,40835113,40897413,35154049,21160693,21062378,21023127,21023126,40746303,43267378,35133999,43278342,36811926,35144241,35149290,43283667,35147018,21121174,35153830,35156973,21140885,21052586,21072300,35159213,35150485,35140877,35131176,21052584,21170470,35155487,35131187,35158006,35138965,35155001,35151565,35160778,35137593,43283666,44088580,21052585,21023125,44101585,35156492,35151528,35156478,40746304,21082002,44101584,35153117,35145789,43267377,21091764,35158065,35143938,35133035,35149247,42964335,42964336,42964337,42964338,44047265,44063005,42964389,42964339,42964340,42964341,42964390,44111708,44063004,42964391,35145138,42964392,42964393,42964372,42964342,43272879,43272880,42964373,43696552,43750399,42964359,43768376,40874310,43606467,42964394,42964343,42964374,44098930,44075728,42964344,44085976,44075727,42964375,42964376,42964360,43660739,40874318,40874308,40843101,43750402,42964361,42964345,43283671,43261885,42964395,43267381,43261886,43289123,42964377,42964362,42964396,42964346,42964378,42964363,42964397,43768375,41123979,41197200,40905270,40853499,41155493,41259074,43624320,42964347,42964398,42964348,43642614,41092774,40884718,41248849,41321459,41186532,40915652,43642615,42964364,42964399,42964349,41155492,43786393,41061206,40978013,40905278,40915651,41186528,41321457,43714435,43840561,40905277,41165818,41061205,41165819,41155484,40884711,43606468,41248848,41248847,41165817,41030041,41103137,41123977,40978012,40905276,41092772,40947034,40905269,41103129,41248846,40821910,43732457,41248844,41197199,41279658,41134571,41248842,40884710,43660740,36260190,36267891,36266548,36260188,36271481,43642613,40936527,41165814,41279652,40947026,40999025,41165816,43840560,41217859,40967655,41103135,41217858,41228261,40874314,41165813,43642624,43678725,43750401,41310951,40884715,41092766,41197193,41217845,41165806,43858678,40905268,40821805,40978005,41217844,41103128,40905267,41103127,43624318,41186526,40821600,43714433,43642617,41155490,40978011,41155482,41290145,41030040,40947032,43624321,36267890,36272951,36268688,36257649,36263601,36270418,36276467,40843108,41155481,40947025,41186530,41279650,41165812,40843099,40853497,43660738,43606469,41092768,41103133,41217842,40853496,40874311,41228259,43624322,43642618,40843111,41040441,41186536,40915654,41186535,41165823,43678721,41092767,43714434,43624319,40905273,41290151,41123972,40978004,41061200,40884714,43750400,41279651,41259066,40967654,41040439,40967653,40915644,43858676,36275542,36262735,36258932,782915,782916,36272949,36266154,43768374,43678718,44098929,44114438,43696553,40905272,41134569,41155489,41165811,40905266,44159748,43588444,41155488,40843105,41071744,41092764,41321454,41217852,41009356,41030038,41009355,41092763,40947023,43786392,43804383,36260187,36266043,36270417,36256953,36265314,782917,36261169,43678720,44049989,43696557,41123971,41259064,40936520,41197188,41310945,40915640,43840562,43822473,43642616,44073064,36265313,782918,36263659,36257647,36273886,36270416,782919,36276589,44114437,43714432,43588443,43714431,43858677,43696556,41217838,41228253,40905271,40853502,41030037,40947031,43588445,42964380,42964379,42964365,42964400,42964350,42964381,42964366,42964401,42964382,42964402,42964351,42964367,42964403,42964383,42964368,42964404,42964352,42964369,42964405,42964353,44124914,44075726,42964384,44085975,44127573,44047264,44127572,44098928,44036849,43267374,43267375,44111707,44049990,42964354,42964385,1154192,41279656,41290144,41197194,41040434,40884707,41259060,41040431,41071742,41040432,41290148,41165807,41040429,40947022,41009351,41061199,41217848,41071741,40947030,41228252,41040438,41134562,41165809,41040437,40853501,41134567,41040436,41321451,41134561,40978007,21130939,21023128,21091767,21062384,36261188,40746296,782913,40746297,21042784,21082005,21091768,21150731,43278343,41123974,41228257,41248843,41259062,41165808,41009353,41228256,41290149,41071737,40978009,41040435,41009346,41103131,41103125,41259061,40978008,36270415,36271424,782914,37592495,21062383,21042783,21170471,43714436,40746298,40746299,21062382,21121176,42964406,42964355,42964386,42964370,42964407,42964356,42964387,42964371,42964408,42964409,43261883,43294552,44025841,42964467,44105867,44041210,44118868,43278341,44118867,42964436,42964468,19117210,42964489,42964437,42964469,42964453,42964490,42964438,42964470,42964454,42964491,42964492,43289120,19086487,44028224,42964182,43714447,44041209,42964166,42964124,42964206,42964167,44092925,1154197,44124913,44036848,42964099,43822483,43732465,44025644,44036847,42964089,42964101,42964123,44085974,44036846,41084761,41178551,40866258,21082008,21023129,21052588,21023130,21150736,43272881,43294554,36814054,43278348,21140888,21091771,21140890,21091772,43026370,21072307,21121180,43267382,21101641,21140889,40746263,21052589,43261889,21140891,21130943,41084762,41053206,40897414,21150735,21062386,21062388,21032890,43278347,43283672,36813622,43278346,21140887,21150734,21121179,21160694,21032889,21130941,43289124,44101583,21062387,21121178,44127571,40746264,21082007,44088578,43278345,21130942,42964090,42964091,44085973,44036845,42964125,42964126,42964127,42964128,42964129,42964092,43267383,43267384,43624323,43606471,42964102,43804385,41310959,43768380,42964093,42964109,44085972,44063002,44073063,44127570,42964110,42964111,42964103,43624325,41186540,40905284,43696560,42964104,42964094,43283673,43261891,42964130,42964112,42964105,42964095,42964131,40967659,41310958,41197203,40843118,40915665,40843117,40915664,43714445,42964096,42964113,43732460,41123985,41321464,41248857,41134578,43660744,42964132,41248856,43642621,40936542,41040448,40936543,41228267,40874321,41134577,43768377,43768382,41155497,40853507,40905283,40947041,43642622,41092786,41310957,40884728,41092785,40947040,41310956,40843116,41009364,40999039,40915663,43768381,36421372,41092784,41009363,41123984,41197202,43732462,36265319,36275546,36258324,36262741,36274268,43714441,40967658,41134576,40999038,40947039,41217867,41228266,43624324,41030046,41030045,41321463,41248855,41165832,43588451,43642623,43822475,41092783,40884727,41248854,41290154,41248853,43768378,40999037,40967657,40915662,40843114,40947038,41310955,40915661,41030043,40936541,43822481,36257655,36257654,36258579,36262740,36274089,36275545,36274270,41155496,40967656,41092782,41259079,41040446,41217866,40853506,43768383,43750405,40999036,41040445,41217865,41009362,43822482,43714440,40905282,40936540,41165831,40843113,40915660,43858680,40936539,43858681,43822476,40936538,41228265,41061212,41040444,41123983,41030044,41321462,40843115,41040447,41248852,41103139,43206295,43206296,43151352,36788302,36788301,36257653,36261414,43732461,43606472,43714448,41279662,40884726,41092781,40915659,43804387,43714442,40999035,41248851,43804384,37592494,41155495,41092780,41165830,41061211,40915658,40905281,40978015,43732463,43660745,36272953,36271251,36265318,36261415,36270420,36266152,43606473,44036842,41092779,40936537,41009361,40874320,40915657,43714444,43768379,43822477,44034228,36267895,36271238,36275544,36276329,36265317,36788300,36273942,44127569,43660743,43732459,43858682,41279661,40947037,40999034,41259078,43588449,42964114,42964106,42964115,42964133,42964116,42964117,42964107,42964118,42964134,42964135,42964097,44060270,44101582,42964119,44098926,44101581,44098925,44036844,43267385,43289125,44047263,44036843,42964098,42964120,1154196,41061210,40884722,41217864,41186539,40884721,40947036,40915656,41165829,41321461,41228264,41259077,41259076,41009360,40915655,43173533,40746256,43217249,36271523,40746255,43026371,40746257,40746254,40746253,40746252,40905280,41259075,41134575,40853505,41103138,41165828,40884725,40884724,40884723,41134574,41290153,40978014,36262739,36265979,36788303,40746261,40746258,44036841,40746260,40746262,40746259,21082009,21072308,21140894,21111496,21091773,21091774,21130944,21062390,21062389,21101642,21082010,21140892,21140893,42964136,42964121,42964137,42964122,42964108,42964138,42964139,43294555,43261892,42964168,42964169,42964159,42964160,42964161,42964162,42964163,42964165,42964164,44105866,42964207,42964170,42964208,42964209,35144788,42964210,42964211,42964171,43256576,43858679,42964183,43750403,42964172,42964192,44118865,44105865,42964193,42964194,42964184,43714439,42964185,42964173,43278344,42964212,42964174,42964195,42964186,42964175,42964213,41203473,42964176,42964196,42964187,43804375,42964214,42964177,41140859,43660741,43696558,41078079,41296375,43606470,36259048,43732458,35407233,41046705,43858683,43714437,41203472,40859676,36259047,40953138,43750404,43840563,41234463,43714438,40859677,43140372,43822474,43606475,43642619,41109525,43660742,41140858,43642620,43184384,43588446,43588447,42964197,42964188,42964198,42964215,42964178,42964199,42964200,42964189,42964201,42964216,42964217,42964179,1154201,42964145,42964140,43173534,40746271,40746272,40746269,43026369,40746270,43026368,40746267,40746268,36269840,40746277,40746278,40746275,35155665,35158989,35152101,40746276,35151487,35143074,35144806,35160802,35130256,35132534,35142184,40746273,35145787,35151028,40746274,35140706,35138727,35134490,35153603,42964141,35130826,42964155,42964149,42964146,42964142,42964147,42964150,42964148,35408331,35410657,35410918,44098927,44075725,43151353,43206297,43217250,36272952,36258531,43151354,43217251,43217252,42964151,42964143,42964152,42964156,42964157,42964153,42964144,42964154,19102732,43195396,40746265,43151355,36258387,40746266,44063003,42964158,42482182,41147514,21042785,21091769,21042786,21072304,21150733,21072305,41240958,41240957,21072302,21140886,21150732,21130940,21072303,40936534,40874319,41290152,41061208,41228263,41248850,41009359,43642610,40936533,41197201,43786387,41092775,41279659,41040443,41123981,40999031,41165825,40905279,41165824,40936532,41030042,41321460,41134573,41165827,41071750,41040442,40853504,40884720,41228262,41165826,40884719,21042787,21121177,21072306,21091770,21052587,21042788,19101792,35775074,35773642,35744232,35765058,35765059,35744233,35748425,35748424,35744231,35748426,35773641,35760939,35769246,35765060,35769245,35775073,35756786,35760940,35744234,35773643,35773644,35769248,35744236,35744235,35769249,35769247,35752572,35752574,35752573,35748427,19113985,35762943,35775519,35773639,35748420,35773640,35748422,35750380,35752571,35744229,35756785,35760938,35744230,35748423,44118864,42964202,44118863,44105864,43261887,44028223,42964180,42964203,19113984,21062385,42964218,42964204,42964190,42964219,42964181,42964205,42964191,42964220,42964221,43256577,19084256,44067293,42964295,44054299,42964296,42964318,42964279,43714449,44105871,1154195,44098933,44088581,42964233,44111711,44101588,42964234,42964255,43786394,43588452,44060273,44114442,40990988,41240960,41240959,21062392,21101645,21150738,21150739,21042790,43283664,43026393,43278337,43026388,36812941,43283662,21111498,43026391,21023133,21062394,21052590,43026387,43026389,43026390,21091777,21072310,43026386,43026385,43256570,21111500,21111499,40746294,21062393,43278338,21160695,43026392,21091778,43026394,43206293,40866260,40866259,35147531,21130947,21140895,21023132,21072309,43294550,35150136,43278334,36813391,43278335,35159396,21032891,35141383,35143944,21091776,21101643,21101644,35161870,35157841,21130946,35135366,21111497,35140641,35148530,35160906,35141986,35153178,35161738,43261882,44114443,21082011,21062391,44127574,35152544,35149444,35148539,40746295,21042789,44036851,35156144,35145327,43272872,21150737,35142959,35156921,35154228,42964222,42964223,44098932,44075730,42964256,42964224,42964257,42964258,35159957,42964259,42964260,42964225,43267373,43278339,43822465,43678713,42964235,43840555,41155503,43642612,42964226,42964241,44098931,44063006,44124915,44114441,42964242,42964243,42964236,43588442,41186549,41279667,40843125,43732450,42964237,42964227,43272873,43272874,42964261,42964244,43660729,43678714,42964228,42964262,41186548,41279666,41071754,41092793,40821288,41061215,40853510,43750396,42964229,42964245,43588439,40967666,41103144,41061214,40978025,40905296,41259088,43588440,42964263,40905295,43840552,40874334,41259087,41186547,41134586,40843124,40978024,43642611,43786389,40874332,41321472,40874333,40884733,41186546,41197211,43732451,41155502,41061213,40978023,40936548,41321471,41155501,41071753,41310965,41030054,41009371,40843123,41009372,41092792,41228275,43822470,41030052,41165837,40905294,40915669,41030053,41228274,43840556,36265316,36257652,36266414,36260192,36261456,43768370,41248862,41009370,41217876,41197210,40905293,41134585,43696544,43151349,43184379,43140368,41248861,40967665,41321470,40905292,40978022,41123987,40978021,43840565,43588453,43732449,41279665,40978020,40905291,41134584,40967664,41259086,43588441,43217244,43162526,43151350,40874331,41248860,41165835,40843121,41321469,41030051,41197208,43195390,43195391,43173525,41310964,41279664,44186033,43822468,43195392,43217245,43184380,36265315,36266376,36262738,36263742,35413018,35409887,35407942,41030050,41310963,40884732,40874330,40905290,41009369,40874329,41321468,43624314,43660732,40905289,41009368,40967663,41321467,40874328,41040454,43858671,43660730,41030049,41040453,41248859,41259085,41310962,41228273,43858668,40821497,43858669,43840554,41155499,41259084,41123986,41040452,41248858,41197207,41092791,41155500,41071752,40843122,41197209,40936547,41165836,43140369,43173526,43140370,36788289,36788288,36257650,36258902,43696545,43840553,43162527,41310961,40978019,41186545,41134583,43195393,43173527,41217875,40947045,43786395,43162528,43184381,43162529,43732466,41217874,41186544,41279663,44174781,43606476,43140371,43162530,43206294,41217873,40874327,41228272,41217872,41134582,40905288,40884731,41092790,41103143,40967662,41009367,43858670,43195394,43162531,43217246,36267894,36276783,36267893,36273978,43696547,44101587,40967661,40843120,41197206,40999040,41103142,41092789,40825965,43588438,43696546,43768371,43173528,43217247,43217248,36257651,36263904,36262737,36263759,44101586,43822467,43678715,41030048,40905287,41259083,41186543,40884730,43184382,43173529,41092788,40947044,43151351,43195395,43173530,42964246,42964238,42964264,42964247,42964265,42964248,42964230,42964249,42964239,42964250,42964266,42964267,42964231,44047269,44075729,42964251,44111710,44114439,44060272,44049993,43283665,43272875,44047268,44049992,42964232,42964252,1154193,41217871,40915666,40947043,40978017,41290156,41040449,41103141,41259080,41228270,40884729,41228269,41134579,41030047,40905286,41165833,40978018,41134581,40915668,41040451,41165834,41321466,41259082,41290155,41228271,41228268,43162533,40746285,40746284,43184383,40746281,43173531,43162534,36266244,40746283,43026395,40746286,40746282,40746280,40746279,43173532,41134580,41040450,41009366,41197205,40853509,41259081,40915667,41071751,40978016,43162535,43026396,41290157,36262736,36263598,36788290,40746292,40746291,40746288,44049991,40746290,40746293,40746289,43822469,21160697,21140896,21101647,21032892,21091780,21111501,21062395,21042791,21140897,21150740,21150741,21130948,43606463,21101646,21072311,42964268,42964253,42964269,42964254,42964240,42964270,42964271,43289119,43256571,42964280,42964281,42964272,42964273,35130375,35145914,35131908,35151368,35139099,35155804,42964274,42964275,42964276,42964278,42964277,44041215,42964319,42964282,42964283,42964320,42964321,35149852,42964322,42964323,42964284,43256569,43696541,42964297,43696543,42964285,42964304,44041214,44092927,42964305,42964306,42964298,43858667,42964299,42964286,43283660,42964324,42964287,42964307,43804376,42964288,42964325,41046710,42964289,42964308,43696542,42964326,42964290,41234465,43660726,43588437,41046709,41046708,43660727,36274369,43768369,43173522,41046707,43714450,43750395,43184377,40828412,43162523,41296378,43217242,35411078,41078081,43840551,43678711,41171978,43678712,41109527,43162524,43822464,43173523,43195389,43840564,43173524,41296377,43217243,40953139,43606462,43184378,43732446,41015490,43162525,42964309,42964300,42964327,42964310,42964328,42964311,42964291,42964312,42964301,42964313,42964329,42964330,42964292,19101818,35775072,35773635,35769242,35752566,35773637,35744222,35760936,35773636,35752567,35752569,35744221,35752568,35765055,35765054,35760935,35749884,35139316,35744225,35744227,35744223,35756784,35146915,35131268,35158666,35769244,35140995,35157463,35773638,35752570,35760937,35150415,35145670,35150209,35141091,35748419,35744224,35148706,35130148,35130136,35159287,35129859,35137579,35134120,35146291,35765056,35744226,35143480,35135095,35142724,35765057,35135539,35156218,35769243,35157180,35136145,35141151,35148735,35762942,35746235,35765051,35752564,35744218,35744216,35756783,35769241,35762941,35769240,35752565,35760934,35744220,35765052,35773634,35765053,44105870,42964314,44092926,44105869,43283661,44079969,42964293,42964315,19023676,43732448,42964331,42964316,42964302,42964332,42964294,42964317,42964303,42964045,42964100,43278333,36243759,40057420,44121521,42964513,43588435,44121520,42964501,42964514,42964536,43768368,44095585,42964502,42964503,44082620,42964537,42964504,42964538,42964539,35132678,42964540,42964541,42964505,43283657,43606459,42964515,43822463,42964506,42964522,44025353,44030865,42964523,42964524,42964516,43588436,42964517,42964507,43272870,42964542,42964525,42964518,43642608,42964508,42964543,41144302,42964509,42964526,43858665,42964544,41144301,43732444,43732445,41175257,41112704,43696540,36274692,43750393,43206280,40894248,43732443,43822462,43217219,41206816,43217220,40831825,43217221,35406795,41299708,43858666,43696537,40863052,43588434,41081482,43206281,43840549,43195377,43173509,43822461,43162511,41299707,43151336,41237688,43696538,43206282,43804374,43696539,43217222,42964527,42964519,42964545,42964528,42964546,42964529,42964510,42964530,42964520,42964531,42964547,42964548,42964511,44030864,42964532,44043923,44030863,43289117,44095584,42964512,42964533,40057421,43678709,42964549,42964534,42964550,42964535,42964521,42964551,42964552,43256567,43217223,41299705,40925248,40956488,41268696,40925247,40894246,43162512,40925246,43217224,41050003,43140356,43173510,36277233,41144299,43217225,41299706,40822631,43151337,40863051,43217226,41018722,40831823,43162513,43206283,40956487,41206815,41268695,41018723,41112702,43217227,43195378,43217228,41144298,43195379,40925245,43173511,40925244,43217229,41237685,43206552,43195381,42964653,42964654,42964655,35137780,42964656,42964657,35144360,42964660,42964659,36245776,40057422,42964558,42964553,42964554,35134907,42964568,42964562,42964559,42964555,42964560,42964563,42964561,35408127,44108441,43173512,43173513,42964564,42964556,42964565,42964569,42964570,42964566,42964557,42964567,40057423,42964571,36215752,42482181,40831821,43588433,41299704,43858664,43804373,41237684,43732442,40987743,21111493,42964651,42964652,40057424,42964596,43606458,44095586,43261881,42964572,42964597,42964629,42964573,44121524,42964574,42964575,42964576,42964577,44043925,42964630,42964578,42964579,42964580,42964631,44121523,42964632,35152382,42964633,42964634,42964612,42964581,43283659,42964613,43642601,42964598,43840548,42964635,42964582,42964614,44082622,42964583,44030868,42964615,42964616,42964600,43750391,42964601,42964584,43256568,42964636,43272871,42964617,42964602,42964637,42964585,42964618,42964603,42964638,43642604,42964586,42964639,42964587,43660723,42964604,42964640,42964588,41081479,43588432,43786385,41237686,41050004,43858663,36264487,43858662,40831824,43660721,43786383,40987742,43606457,43786384,36259345,40831822,43642605,43696536,41081478,43624313,43642602,36267020,43642603,44069791,43660724,40956486,43642606,43660725,43714425,44030866,43660722,43804371,43588431,42964620,42964619,42964605,42964641,42964589,42964621,42964606,42964642,42964622,42964643,42964590,42964607,42964644,42964623,42964608,42964645,42964591,42964609,42964646,42964592,44056894,42964624,44043924,44030867,44121522,43289118,44082621,42964593,42964626,40057425,35762156,42964647,42964594,42964627,42964610,42964648,42964595,42964628,42964611,42964649,42964650,43283658,36215753,44107380,44095583,43009065,42962474,42962476,42962475,42962471,42962473,42962472,35141191,35145516,42962451,42962452,42962449,42962450,42962484,42962485,42962488,42962477,35138173,35147432,35129127,35148194,35153578,35131416,35141173,42962478,42962481,42962482,42962483,42962479,42962480,35151068,35157661,35154626,35139462,35157754,35129619,42962489,42962490,42962486,42962487,42962469,42962470,42962467,42962468,35133142,35135936,35131194,35155499,35159604,35141255,35131992,35140538,35129930,42962465,42962466,42962461,42962462,42962463,42962464,42962459,42962460,42962457,42962458,42962455,42962453,42962454,42962456,42962497,42962498,42962501,42962502,42962504,42962499,42962500,42962494,42962496,42962495,42962491,42962492,42962493,35153952,35143347,42962505,42962506,36244748,36244256,36241756,36241757,1111706,19085161,19015809,1111710,1111709,1111711,19120007,19103386,1111707,1111708,43296373,21053178,21033448,21082559,21082561,21082560,40725102,21171011,21171012,21023681,21082558,21151297,21043369,40725103,21112072,21141483,43269282,21121750,35137348,35138662,35152464,35162144,40101211,36219055,40101212,40101213,36219056)

) I
) C UNION ALL 
SELECT 2 as codeset_id, c.concept_id FROM (select distinct I.concept_id FROM
( 
  select concept_id from @vocabulary_database_schema.CONCEPT where concept_id in (42917240,42917242,42917241,42918233,42918235,42918234,35154316,35156156,35159984,35144502,35153134,35135921,35154453,35153856,35146952,35138833,35134260,35143522,35156224,35160726,35148326,35145742,35137222,42917212,42917214,42917213,42918087,42918089,42918088,42920752,42920753,42920754,42920755,43758751,43651035,43812823,43632959,43740854,36896836,43867087,43596841,43740855,43812824,43686952,43830830,43848857,43848858,43794650,42918777,42918779,42918778,43597338,43849415,43795195,43723235,43867609,43759208,42918260,42918262,42918261,42918247,42918249,42918248,42918244,42918246,42918245,42917264,42917266,42917265,36221800,36221801,43009091,35152872,35130342,35151741,42959456,42959340,35132945,35147877,35143729,42959283,42959453,42959454,42959455,35131943,35135110,35157140,35154765,42959457,42959458,42959459,1154161,43804378,43732452,43714428,43696548,43786390,43678717,43606477,43660746,43660747,43840566,43786397,43786396,36886189,43660733,43804379,43858672,36892605,43696549,43660734,43696550,43822471,43858673,43786391,43732453,42964495,42964496,42964493,42964494,42964499,42964500,42964497,42964498,1154200,42964439,43732455,44054298,43256572,42964413,42964440,42964471,42964414,44105868,42964415,42964416,42964417,42964418,43206286,41178550,40835114,41302910,43184370,35760941,35744242,35765062,35756790,40746309,43026380,43026381,43026375,35744243,43026378,35765063,35756789,35756788,43026374,43026376,43026377,35748430,35769251,43026373,43026372,35769252,35752577,40746310,35752576,35744241,43026379,43206287,43026382,41021947,43217232,41116018,41116017,35760942,35773649,35765064,35773648,40746311,35756792,35769255,35769254,35769253,35748431,35744244,35760943,35769256,40746312,35752578,35756791,41279655,41279654,41310954,41123980,40874309,40843102,41186534,40874317,41165822,41217847,40947027,41061207,41040440,41186533,40936531,41259073,40843110,40915653,40874316,41165821,41123978,40999028,41071749,41092773,40822846,41123973,40915645,40999027,40999026,40915650,41310953,41165820,41155485,41259067,43217233,43173516,43162515,41061204,41155491,41134572,41061203,40915649,40936530,40884717,43151340,41248845,40947035,41279653,40978006,43184371,43195382,40874315,41009358,40936529,41061201,41071748,41061202,40947033,41186527,40853498,43173517,43140361,35407975,43217234,43217235,43162516,43173518,36260191,36267892,36266118,36260189,36261260,40936528,41217860,41103136,41217846,41071739,41310952,41165815,43151341,43162517,43184372,40843109,40905275,40884716,41092771,41197198,41123976,41228260,41092770,41186531,41009357,41310948,41321456,41030035,41197192,43195383,43217236,43173519,41030034,40843100,41290146,40967650,41197191,41310947,41228255,43162518,35409135,35407860,43151342,43151343,41155483,41092765,41197190,40905274,41217856,41259072,41217843,41259065,41217857,41071747,43151344,43217237,43184373,36788297,36272950,36271618,36270419,36263518,36788296,43140362,43217238,43195384,40874313,41030033,40884709,41123975,40843098,41259071,41310946,40915642,40874312,40843107,40915648,40999023,40947024,40936525,41259070,41217855,40821184,41259069,41217841,40915641,41155480,41321455,40843106,41186529,41071746,41217840,41165805,41217854,41228258,41092769,41061197,40915643,40936526,41103134,41310950,41009350,43217239,43184374,43151345,36788295,36788294,36260184,36266382,43206288,43140363,43162519,43173520,43206289,43206290,40936524,40936523,41134570,40967652,40853503,40936522,44171023,43195385,43140364,43140365,41030039,41217851,41071745,41217839,41009349,41217853,41165810,41155487,41134568,41186525,41228254,43184375,43184376,43217240,36275543,36258519,36257648,36788293,36271332,41155479,40999022,41259063,40936521,41197187,40936519,40915639,43206291,43217241,36788292,43195386,36260186,36258553,36257646,36788291,36266541,41310949,40967649,41009348,41217850,41197197,43162521,43173521,41279657,41103132,43151652,43173818,43151653,43195387,41030036,40884708,40915646,41103130,41228251,40978003,41228250,41040433,41134564,41134563,41259068,40853492,41321453,41321458,40967651,40843104,41290147,40978010,41103126,40824097,40853495,40884713,40884712,41197196,40947029,41290150,40853493,41071738,41071740,43162522,43195388,35744237,35748428,43140366,43206292,43140367,36266536,40746305,43026383,36788299,40746306,35744239,35744238,35754615,35773645,41217849,40947028,43151346,41009347,41009354,40853500,41071743,40915647,41071736,41134566,41009352,41228249,41197195,41134560,43151347,43026384,41134565,36260185,36263686,36788298,35756787,35744240,35773647,35765061,40746307,40746308,35769250,35748429,42964410,35157043,35129246,35162161,35145838,35134675,35130125,35152668,42964411,42964412,35158805,44041212,42964472,42964419,42964421,42964422,42964473,44067292,42964474,35147203,42964475,42964476,42964455,42964423,43294551,42964456,43732454,42964441,43768372,42964477,42964424,42964457,44041211,42964425,44054297,42964458,42964459,42964442,43858675,42964443,42964426,43278340,42964478,43272876,42964427,42964460,42964444,42964479,42964428,42964461,42964445,42964480,43660737,42964429,42964481,42964430,43714429,42964446,42964482,42964431,40828409,43696551,43732456,43140357,41203471,43173514,43750398,43217230,43184367,36271809,43660736,43140358,40890952,43678724,43606465,43162514,41046704,43217231,43804381,43840558,43206284,43140359,41234461,43822472,43804380,40953137,43606466,43750397,43184368,43804382,43206285,43140360,43840557,43151338,41296374,43151339,43840559,43858674,43184369,43624316,43660735,43624317,43184681,42964463,42964462,42964447,42964483,42964432,42964464,42964448,42964484,42964465,42964485,42964433,42964449,42964486,42964466,42964450,42964487,42964434,42964452,42964488,42964435,19023368,42964357,43696555,43678719,44111709,44088579,43261884,43267376,42964333,42964358,42964388,42964334,44034229,44036850,41021948,43283668,43289121,43289122,43272878,40866257,41147513,21032887,21082003,21032888,21062381,21121175,40746300,43294553,43256574,36812558,43283670,21062379,21062380,21091766,21082004,21101639,21130936,43256575,21091765,21101640,40746301,21111494,43283669,21111495,21130937,43267380,43272877,41271779,41302911,40835113,40897413,35154049,21160693,21062378,21023127,21023126,40746303,43267378,35133999,43278342,36811926,35144241,35149290,43283667,35147018,21121174,35153830,35156973,21140885,21052586,21072300,35159213,35150485,35140877,35131176,21052584,21170470,35155487,35131187,35158006,35138965,35155001,35151565,35160778,35137593,43283666,44088580,21052585,21023125,44101585,35156492,35151528,35156478,40746304,21082002,44101584,35153117,35145789,43267377,21091764,35158065,35143938,35133035,35149247,42964335,42964336,42964337,42964338,44047265,44063005,42964389,42964339,42964340,42964341,42964390,44111708,44063004,42964391,35145138,42964392,42964393,42964372,42964342,43272879,43272880,42964373,43696552,43750399,42964359,43768376,40874310,43606467,42964394,42964343,42964374,44098930,44075728,42964344,44085976,44075727,42964375,42964376,42964360,43660739,40874318,40874308,40843101,43750402,42964361,42964345,43283671,43261885,42964395,43267381,43261886,43289123,42964377,42964362,42964396,42964346,42964378,42964363,42964397,43768375,41123979,41197200,40905270,40853499,41155493,41259074,43624320,42964347,42964398,42964348,43642614,41092774,40884718,41248849,41321459,41186532,40915652,43642615,42964364,42964399,42964349,41155492,43786393,41061206,40978013,40905278,40915651,41186528,41321457,43714435,43840561,40905277,41165818,41061205,41165819,41155484,40884711,43606468,41248848,41248847,41165817,41030041,41103137,41123977,40978012,40905276,41092772,40947034,40905269,41103129,41248846,40821910,43732457,41248844,41197199,41279658,41134571,41248842,40884710,43660740,36260190,36267891,36266548,36260188,36271481,43642613,40936527,41165814,41279652,40947026,40999025,41165816,43840560,41217859,40967655,41103135,41217858,41228261,40874314,41165813,43642624,43678725,43750401,41310951,40884715,41092766,41197193,41217845,41165806,43858678,40905268,40821805,40978005,41217844,41103128,40905267,41103127,43624318,41186526,40821600,43714433,43642617,41155490,40978011,41155482,41290145,41030040,40947032,43624321,36267890,36272951,36268688,36257649,36263601,36270418,36276467,40843108,41155481,40947025,41186530,41279650,41165812,40843099,40853497,43660738,43606469,41092768,41103133,41217842,40853496,40874311,41228259,43624322,43642618,40843111,41040441,41186536,40915654,41186535,41165823,43678721,41092767,43714434,43624319,40905273,41290151,41123972,40978004,41061200,40884714,43750400,41279651,41259066,40967654,41040439,40967653,40915644,43858676,36275542,36262735,36258932,782915,782916,36272949,36266154,43768374,43678718,44098929,44114438,43696553,40905272,41134569,41155489,41165811,40905266,44159748,43588444,41155488,40843105,41071744,41092764,41321454,41217852,41009356,41030038,41009355,41092763,40947023,43786392,43804383,36260187,36266043,36270417,36256953,36265314,782917,36261169,43678720,44049989,43696557,41123971,41259064,40936520,41197188,41310945,40915640,43840562,43822473,43642616,44073064,36265313,782918,36263659,36257647,36273886,36270416,782919,36276589,44114437,43714432,43588443,43714431,43858677,43696556,41217838,41228253,40905271,40853502,41030037,40947031,43588445,42964380,42964379,42964365,42964400,42964350,42964381,42964366,42964401,42964382,42964402,42964351,42964367,42964403,42964383,42964368,42964404,42964352,42964369,42964405,42964353,44124914,44075726,42964384,44085975,44127573,44047264,44127572,44098928,44036849,43267374,43267375,44111707,44049990,42964354,42964385,1154192,41279656,41290144,41197194,41040434,40884707,41259060,41040431,41071742,41040432,41290148,41165807,41040429,40947022,41009351,41061199,41217848,41071741,40947030,41228252,41040438,41134562,41165809,41040437,40853501,41134567,41040436,41321451,41134561,40978007,21130939,21023128,21091767,21062384,36261188,40746296,782913,40746297,21042784,21082005,21091768,21150731,43278343,41123974,41228257,41248843,41259062,41165808,41009353,41228256,41290149,41071737,40978009,41040435,41009346,41103131,41103125,41259061,40978008,36270415,36271424,782914,37592495,21062383,21042783,21170471,43714436,40746298,40746299,21062382,21121176,42964406,42964355,42964386,42964370,42964407,42964356,42964387,42964371,42964408,42964409,43261883,43294552,44025841,42964467,44105867,44041210,44118868,43278341,44118867,42964436,42964468,19117210,42964489,42964437,42964469,42964453,42964490,42964438,42964470,42964454,42964491,42964492,43289120,19086487,44028224,42964182,43714447,44041209,42964166,42964124,42964206,42964167,44092925,1154197,44124913,44036848,42964099,43822483,43732465,44025644,44036847,42964089,42964101,42964123,44085974,44036846,41084761,41178551,40866258,21082008,21023129,21052588,21023130,21150736,43272881,43294554,36814054,43278348,21140888,21091771,21140890,21091772,43026370,21072307,21121180,43267382,21101641,21140889,40746263,21052589,43261889,21140891,21130943,41084762,41053206,40897414,21150735,21062386,21062388,21032890,43278347,43283672,36813622,43278346,21140887,21150734,21121179,21160694,21032889,21130941,43289124,44101583,21062387,21121178,44127571,40746264,21082007,44088578,43278345,21130942,42964090,42964091,44085973,44036845,42964125,42964126,42964127,42964128,42964129,42964092,43267383,43267384,43624323,43606471,42964102,43804385,41310959,43768380,42964093,42964109,44085972,44063002,44073063,44127570,42964110,42964111,42964103,43624325,41186540,40905284,43696560,42964104,42964094,43283673,43261891,42964130,42964112,42964105,42964095,42964131,40967659,41310958,41197203,40843118,40915665,40843117,40915664,43714445,42964096,42964113,43732460,41123985,41321464,41248857,41134578,43660744,42964132,41248856,43642621,40936542,41040448,40936543,41228267,40874321,41134577,43768377,43768382,41155497,40853507,40905283,40947041,43642622,41092786,41310957,40884728,41092785,40947040,41310956,40843116,41009364,40999039,40915663,43768381,36421372,41092784,41009363,41123984,41197202,43732462,36265319,36275546,36258324,36262741,36274268,43714441,40967658,41134576,40999038,40947039,41217867,41228266,43624324,41030046,41030045,41321463,41248855,41165832,43588451,43642623,43822475,41092783,40884727,41248854,41290154,41248853,43768378,40999037,40967657,40915662,40843114,40947038,41310955,40915661,41030043,40936541,43822481,36257655,36257654,36258579,36262740,36274089,36275545,36274270,41155496,40967656,41092782,41259079,41040446,41217866,40853506,43768383,43750405,40999036,41040445,41217865,41009362,43822482,43714440,40905282,40936540,41165831,40843113,40915660,43858680,40936539,43858681,43822476,40936538,41228265,41061212,41040444,41123983,41030044,41321462,40843115,41040447,41248852,41103139,43206295,43206296,43151352,36788302,36788301,36257653,36261414,43732461,43606472,43714448,41279662,40884726,41092781,40915659,43804387,43714442,40999035,41248851,43804384,37592494,41155495,41092780,41165830,41061211,40915658,40905281,40978015,43732463,43660745,36272953,36271251,36265318,36261415,36270420,36266152,43606473,44036842,41092779,40936537,41009361,40874320,40915657,43714444,43768379,43822477,44034228,36267895,36271238,36275544,36276329,36265317,36788300,36273942,44127569,43660743,43732459,43858682,41279661,40947037,40999034,41259078,43588449,42964114,42964106,42964115,42964133,42964116,42964117,42964107,42964118,42964134,42964135,42964097,44060270,44101582,42964119,44098926,44101581,44098925,44036844,43267385,43289125,44047263,44036843,42964098,42964120,1154196,41061210,40884722,41217864,41186539,40884721,40947036,40915656,41165829,41321461,41228264,41259077,41259076,41009360,40915655,43173533,40746256,43217249,36271523,40746255,43026371,40746257,40746254,40746253,40746252,40905280,41259075,41134575,40853505,41103138,41165828,40884725,40884724,40884723,41134574,41290153,40978014,36262739,36265979,36788303,40746261,40746258,44036841,40746260,40746262,40746259,21082009,21072308,21140894,21111496,21091773,21091774,21130944,21062390,21062389,21101642,21082010,21140892,21140893,42964136,42964121,42964137,42964122,42964108,42964138,42964139,43294555,43261892,42964168,42964169,42964159,42964160,42964161,42964162,42964163,42964165,42964164,44105866,42964207,42964170,42964208,42964209,35144788,42964210,42964211,42964171,43256576,43858679,42964183,43750403,42964172,42964192,44118865,44105865,42964193,42964194,42964184,43714439,42964185,42964173,43278344,42964212,42964174,42964195,42964186,42964175,42964213,41203473,42964176,42964196,42964187,43804375,42964214,42964177,41140859,43660741,43696558,41078079,41296375,43606470,36259048,43732458,35407233,41046705,43858683,43714437,41203472,40859676,36259047,40953138,43750404,43840563,41234463,43714438,40859677,43140372,43822474,43606475,43642619,41109525,43660742,41140858,43642620,43184384,43588446,43588447,42964197,42964188,42964198,42964215,42964178,42964199,42964200,42964189,42964201,42964216,42964217,42964179,1154201,42964145,42964140,43173534,40746271,40746272,40746269,43026369,40746270,43026368,40746267,40746268,36269840,40746277,40746278,40746275,35155665,35158989,35152101,40746276,35151487,35143074,35144806,35160802,35130256,35132534,35142184,40746273,35145787,35151028,40746274,35140706,35138727,35134490,35153603,42964141,35130826,42964155,42964149,42964146,42964142,42964147,42964150,42964148,35408331,35410657,35410918,44098927,44075725,43151353,43206297,43217250,36272952,36258531,43151354,43217251,43217252,42964151,42964143,42964152,42964156,42964157,42964153,42964144,42964154,19102732,43195396,40746265,43151355,36258387,40746266,44063003,42964158,42482182,41147514,21042785,21091769,21042786,21072304,21150733,21072305,41240958,41240957,21072302,21140886,21150732,21130940,21072303,40936534,40874319,41290152,41061208,41228263,41248850,41009359,43642610,40936533,41197201,43786387,41092775,41279659,41040443,41123981,40999031,41165825,40905279,41165824,40936532,41030042,41321460,41134573,41165827,41071750,41040442,40853504,40884720,41228262,41165826,40884719,21042787,21121177,21072306,21091770,21052587,21042788,19101792,35775074,35773642,35744232,35765058,35765059,35744233,35748425,35748424,35744231,35748426,35773641,35760939,35769246,35765060,35769245,35775073,35756786,35760940,35744234,35773643,35773644,35769248,35744236,35744235,35769249,35769247,35752572,35752574,35752573,35748427,19113985,35762943,35775519,35773639,35748420,35773640,35748422,35750380,35752571,35744229,35756785,35760938,35744230,35748423,44118864,42964202,44118863,44105864,43261887,44028223,42964180,42964203,19113984,21062385,42964218,42964204,42964190,42964219,42964181,42964205,42964191,42964220,42964221,43256577,19084256,44067293,42964295,44054299,42964296,42964318,42964279,43714449,44105871,1154195,44098933,44088581,42964233,44111711,44101588,42964234,42964255,43786394,43588452,44060273,44114442,40990988,41240960,41240959,21062392,21101645,21150738,21150739,21042790,43283664,43026393,43278337,43026388,36812941,43283662,21111498,43026391,21023133,21062394,21052590,43026387,43026389,43026390,21091777,21072310,43026386,43026385,43256570,21111500,21111499,40746294,21062393,43278338,21160695,43026392,21091778,43026394,43206293,40866260,40866259,35147531,21130947,21140895,21023132,21072309,43294550,35150136,43278334,36813391,43278335,35159396,21032891,35141383,35143944,21091776,21101643,21101644,35161870,35157841,21130946,35135366,21111497,35140641,35148530,35160906,35141986,35153178,35161738,43261882,44114443,21082011,21062391,44127574,35152544,35149444,35148539,40746295,21042789,44036851,35156144,35145327,43272872,21150737,35142959,35156921,35154228,42964222,42964223,44098932,44075730,42964256,42964224,42964257,42964258,35159957,42964259,42964260,42964225,43267373,43278339,43822465,43678713,42964235,43840555,41155503,43642612,42964226,42964241,44098931,44063006,44124915,44114441,42964242,42964243,42964236,43588442,41186549,41279667,40843125,43732450,42964237,42964227,43272873,43272874,42964261,42964244,43660729,43678714,42964228,42964262,41186548,41279666,41071754,41092793,40821288,41061215,40853510,43750396,42964229,42964245,43588439,40967666,41103144,41061214,40978025,40905296,41259088,43588440,42964263,40905295,43840552,40874334,41259087,41186547,41134586,40843124,40978024,43642611,43786389,40874332,41321472,40874333,40884733,41186546,41197211,43732451,41155502,41061213,40978023,40936548,41321471,41155501,41071753,41310965,41030054,41009371,40843123,41009372,41092792,41228275,43822470,41030052,41165837,40905294,40915669,41030053,41228274,43840556,36265316,36257652,36266414,36260192,36261456,43768370,41248862,41009370,41217876,41197210,40905293,41134585,43696544,43151349,43184379,43140368,41248861,40967665,41321470,40905292,40978022,41123987,40978021,43840565,43588453,43732449,41279665,40978020,40905291,41134584,40967664,41259086,43588441,43217244,43162526,43151350,40874331,41248860,41165835,40843121,41321469,41030051,41197208,43195390,43195391,43173525,41310964,41279664,44186033,43822468,43195392,43217245,43184380,36265315,36266376,36262738,36263742,35413018,35409887,35407942,41030050,41310963,40884732,40874330,40905290,41009369,40874329,41321468,43624314,43660732,40905289,41009368,40967663,41321467,40874328,41040454,43858671,43660730,41030049,41040453,41248859,41259085,41310962,41228273,43858668,40821497,43858669,43840554,41155499,41259084,41123986,41040452,41248858,41197207,41092791,41155500,41071752,40843122,41197209,40936547,41165836,43140369,43173526,43140370,36788289,36788288,36257650,36258902,43696545,43840553,43162527,41310961,40978019,41186545,41134583,43195393,43173527,41217875,40947045,43786395,43162528,43184381,43162529,43732466,41217874,41186544,41279663,44174781,43606476,43140371,43162530,43206294,41217873,40874327,41228272,41217872,41134582,40905288,40884731,41092790,41103143,40967662,41009367,43858670,43195394,43162531,43217246,36267894,36276783,36267893,36273978,43696547,44101587,40967661,40843120,41197206,40999040,41103142,41092789,40825965,43588438,43696546,43768371,43173528,43217247,43217248,36257651,36263904,36262737,36263759,44101586,43822467,43678715,41030048,40905287,41259083,41186543,40884730,43184382,43173529,41092788,40947044,43151351,43195395,43173530,42964246,42964238,42964264,42964247,42964265,42964248,42964230,42964249,42964239,42964250,42964266,42964267,42964231,44047269,44075729,42964251,44111710,44114439,44060272,44049993,43283665,43272875,44047268,44049992,42964232,42964252,1154193,41217871,40915666,40947043,40978017,41290156,41040449,41103141,41259080,41228270,40884729,41228269,41134579,41030047,40905286,41165833,40978018,41134581,40915668,41040451,41165834,41321466,41259082,41290155,41228271,41228268,43162533,40746285,40746284,43184383,40746281,43173531,43162534,36266244,40746283,43026395,40746286,40746282,40746280,40746279,43173532,41134580,41040450,41009366,41197205,40853509,41259081,40915667,41071751,40978016,43162535,43026396,41290157,36262736,36263598,36788290,40746292,40746291,40746288,44049991,40746290,40746293,40746289,43822469,21160697,21140896,21101647,21032892,21091780,21111501,21062395,21042791,21140897,21150740,21150741,21130948,43606463,21101646,21072311,42964268,42964253,42964269,42964254,42964240,42964270,42964271,43289119,43256571,42964280,42964281,42964272,42964273,35130375,35145914,35131908,35151368,35139099,35155804,42964274,42964275,42964276,42964278,42964277,44041215,42964319,42964282,42964283,42964320,42964321,35149852,42964322,42964323,42964284,43256569,43696541,42964297,43696543,42964285,42964304,44041214,44092927,42964305,42964306,42964298,43858667,42964299,42964286,43283660,42964324,42964287,42964307,43804376,42964288,42964325,41046710,42964289,42964308,43696542,42964326,42964290,41234465,43660726,43588437,41046709,41046708,43660727,36274369,43768369,43173522,41046707,43714450,43750395,43184377,40828412,43162523,41296378,43217242,35411078,41078081,43840551,43678711,41171978,43678712,41109527,43162524,43822464,43173523,43195389,43840564,43173524,41296377,43217243,40953139,43606462,43184378,43732446,41015490,43162525,42964309,42964300,42964327,42964310,42964328,42964311,42964291,42964312,42964301,42964313,42964329,42964330,42964292,19101818,35775072,35773635,35769242,35752566,35773637,35744222,35760936,35773636,35752567,35752569,35744221,35752568,35765055,35765054,35760935,35749884,35139316,35744225,35744227,35744223,35756784,35146915,35131268,35158666,35769244,35140995,35157463,35773638,35752570,35760937,35150415,35145670,35150209,35141091,35748419,35744224,35148706,35130148,35130136,35159287,35129859,35137579,35134120,35146291,35765056,35744226,35143480,35135095,35142724,35765057,35135539,35156218,35769243,35157180,35136145,35141151,35148735,35762942,35746235,35765051,35752564,35744218,35744216,35756783,35769241,35762941,35769240,35752565,35760934,35744220,35765052,35773634,35765053,44105870,42964314,44092926,44105869,43283661,44079969,42964293,42964315,19023676,43732448,42964331,42964316,42964302,42964332,42964294,42964317,42964303,42964045,42964100,43278333,36243759,40057420,44121521,42964513,43588435,44121520,42964501,42964514,42964536,43768368,44095585,42964502,42964503,44082620,42964537,42964504,42964538,42964539,35132678,42964540,42964541,42964505,43283657,43606459,42964515,43822463,42964506,42964522,44025353,44030865,42964523,42964524,42964516,43588436,42964517,42964507,43272870,42964542,42964525,42964518,43642608,42964508,42964543,41144302,42964509,42964526,43858665,42964544,41144301,43732444,43732445,41175257,41112704,43696540,36274692,43750393,43206280,40894248,43732443,43822462,43217219,41206816,43217220,40831825,43217221,35406795,41299708,43858666,43696537,40863052,43588434,41081482,43206281,43840549,43195377,43173509,43822461,43162511,41299707,43151336,41237688,43696538,43206282,43804374,43696539,43217222,42964527,42964519,42964545,42964528,42964546,42964529,42964510,42964530,42964520,42964531,42964547,42964548,42964511,44030864,42964532,44043923,44030863,43289117,44095584,42964512,42964533,40057421,43678709,42964549,42964534,42964550,42964535,42964521,42964551,42964552,43256567,43217223,41299705,40925248,40956488,41268696,40925247,40894246,43162512,40925246,43217224,41050003,43140356,43173510,36277233,41144299,43217225,41299706,40822631,43151337,40863051,43217226,41018722,40831823,43162513,43206283,40956487,41206815,41268695,41018723,41112702,43217227,43195378,43217228,41144298,43195379,40925245,43173511,40925244,43217229,41237685,43206552,43195381,42964653,42964654,42964655,35137780,42964656,42964657,35144360,42964660,42964659,36245776,40057422,42964558,42964553,42964554,35134907,42964568,42964562,42964559,42964555,42964560,42964563,42964561,35408127,44108441,43173512,43173513,42964564,42964556,42964565,42964569,42964570,42964566,42964557,42964567,40057423,42964571,36215752,42482181,40831821,43588433,41299704,43858664,43804373,41237684,43732442,40987743,21111493,42964651,42964652,40057424,42964596,43606458,44095586,43261881,42964572,42964597,42964629,42964573,44121524,42964574,42964575,42964576,42964577,44043925,42964630,42964578,42964579,42964580,42964631,44121523,42964632,35152382,42964633,42964634,42964612,42964581,43283659,42964613,43642601,42964598,43840548,42964635,42964582,42964614,44082622,42964583,44030868,42964615,42964616,42964600,43750391,42964601,42964584,43256568,42964636,43272871,42964617,42964602,42964637,42964585,42964618,42964603,42964638,43642604,42964586,42964639,42964587,43660723,42964604,42964640,42964588,41081479,43588432,43786385,41237686,41050004,43858663,36264487,43858662,40831824,43660721,43786383,40987742,43606457,43786384,36259345,40831822,43642605,43696536,41081478,43624313,43642602,36267020,43642603,44069791,43660724,40956486,43642606,43660725,43714425,44030866,43660722,43804371,43588431,42964620,42964619,42964605,42964641,42964589,42964621,42964606,42964642,42964622,42964643,42964590,42964607,42964644,42964623,42964608,42964645,42964591,42964609,42964646,42964592,44056894,42964624,44043924,44030867,44121522,43289118,44082621,42964593,42964626,40057425,35762156,42964647,42964594,42964627,42964610,42964648,42964595,42964628,42964611,42964649,42964650,43283658,36215753,43009065,42962474,42962476,42962475,42962471,42962473,42962472,35141191,35145516,42962451,42962452,42962449,42962450,42962484,42962485,42962488,42962477,35138173,35147432,35129127,35148194,35153578,35131416,35141173,42962478,42962481,42962482,42962483,42962479,42962480,35151068,35157661,35154626,35139462,35157754,35129619,42962489,42962490,42962486,42962487,42962469,42962470,42962467,42962468,35133142,35135936,35131194,35155499,35159604,35141255,35131992,35140538,35129930,42962465,42962466,42962461,42962462,42962463,42962464,42962459,42962460,42962457,42962458,42962455,42962453,42962454,42962456,42962497,42962498,42962501,42962502,42962504,42962499,42962500,42962494,42962496,42962495,42962491,42962492,42962493,35153952,35143347,42962505,42962506,36244748,36244256,36241756,36241757,1111706,19085161,19015809,1111710,1111709,1111711,19120007,19103386,1111707,1111708,43296373,21053178,21033448,21082559,21082561,21082560,40725102,21171011,21171012,21023681,21082558,21151297,21043369,40725103,21112072,21141483,43269282,21121750,35137348,35138662,35152464,35162144,40101211,36219055,40101212,40101213,36219056)

) I
) C
;

with primary_events (event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id) as
(
-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.DRUG_EXPOSURE_END_DATE, DATEADD(day,C.DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,C.DRUG_EXPOSURE_START_DATE)) as end_date,
       C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM @cdm_database_schema.DRUG_EXPOSURE de
JOIN #Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 2))
) C


-- End Drug Exposure Criteria

  ) E
	JOIN @cdm_database_schema.observation_period OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE DATEADD(day,0,OP.OBSERVATION_PERIOD_START_DATE) <= E.START_DATE AND DATEADD(day,0,E.START_DATE) <= OP.OBSERVATION_PERIOD_END_DATE
) P

-- End Primary Events

)
SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id
INTO #qualified_events
FROM 
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM primary_events pe
  
) QE

;

--- Inclusion Rule Inserts

create table #inclusion_events (inclusion_rule_id bigint,
	person_id bigint,
	event_id bigint
);

with cteIncludedEvents(event_id, person_id, start_date, end_date, op_start_date, op_end_date, ordinal) as
(
  SELECT event_id, person_id, start_date, end_date, op_start_date, op_end_date, row_number() over (partition by person_id order by start_date ASC) as ordinal
  from
  (
    select Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date, SUM(coalesce(POWER(cast(2 as bigint), I.inclusion_rule_id), 0)) as inclusion_rule_mask
    from #qualified_events Q
    LEFT JOIN #inclusion_events I on I.person_id = Q.person_id and I.event_id = Q.event_id
    GROUP BY Q.event_id, Q.person_id, Q.start_date, Q.end_date, Q.op_start_date, Q.op_end_date
  ) MG -- matching groups

)
select event_id, person_id, start_date, end_date, op_start_date, op_end_date
into #included_events
FROM cteIncludedEvents Results

;

-- custom era strategy

with ctePersons(person_id) as (
	select distinct person_id from #included_events
)

select person_id, drug_exposure_start_date, drug_exposure_end_date
INTO #drugTarget
FROM (
	select de.PERSON_ID, DRUG_EXPOSURE_START_DATE, COALESCE(DRUG_EXPOSURE_END_DATE, DATEADD(day,DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,DRUG_EXPOSURE_START_DATE)) as DRUG_EXPOSURE_END_DATE 
	FROM @cdm_database_schema.DRUG_EXPOSURE de
	JOIN ctePersons p on de.person_id = p.person_id
	JOIN #Codesets cs on cs.codeset_id = 2 AND de.drug_concept_id = cs.concept_id

	UNION ALL

	select de.PERSON_ID, DRUG_EXPOSURE_START_DATE, COALESCE(DRUG_EXPOSURE_END_DATE, DATEADD(day,DAYS_SUPPLY,DRUG_EXPOSURE_START_DATE), DATEADD(day,1,DRUG_EXPOSURE_START_DATE)) as DRUG_EXPOSURE_END_DATE 
	FROM @cdm_database_schema.DRUG_EXPOSURE de
	JOIN ctePersons p on de.person_id = p.person_id
	JOIN #Codesets cs on cs.codeset_id = 2 AND de.drug_source_concept_id = cs.concept_id
) E
;

select et.event_id, et.person_id, ERAS.era_end_date as end_date
INTO #strategy_ends
from #included_events et
JOIN 
(
  select ENDS.person_id, min(drug_exposure_start_date) as era_start_date, DATEADD(day,0, ENDS.era_end_date) as era_end_date
  from
  (
    select de.person_id, de.drug_exposure_start_date, MIN(e.END_DATE) as era_end_date
    FROM #drugTarget DE
    JOIN 
    (
      --cteEndDates
      select PERSON_ID, DATEADD(day,-1 * 30,EVENT_DATE) as END_DATE -- unpad the end date by 30
      FROM
      (
				select PERSON_ID, EVENT_DATE, EVENT_TYPE, 
				MAX(START_ORDINAL) OVER (PARTITION BY PERSON_ID ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal,
				ROW_NUMBER() OVER (PARTITION BY PERSON_ID ORDER BY EVENT_DATE, EVENT_TYPE) AS OVERALL_ORD -- this re-numbers the inner UNION so all rows are numbered ordered by the event date
				from
				(
					-- select the start dates, assigning a row number to each
					Select PERSON_ID, DRUG_EXPOSURE_START_DATE AS EVENT_DATE, 0 as EVENT_TYPE, ROW_NUMBER() OVER (PARTITION BY PERSON_ID ORDER BY DRUG_EXPOSURE_START_DATE) as START_ORDINAL
					from #drugTarget D

					UNION ALL

					-- add the end dates with NULL as the row number, padding the end dates by 30 to allow a grace period for overlapping ranges.
					select PERSON_ID, DATEADD(day,30,DRUG_EXPOSURE_END_DATE), 1 as EVENT_TYPE, NULL
					FROM #drugTarget D
				) RAWDATA
      ) E
      WHERE 2 * E.START_ORDINAL - E.OVERALL_ORD = 0
    ) E on DE.PERSON_ID = E.PERSON_ID and E.END_DATE >= DE.DRUG_EXPOSURE_START_DATE
    GROUP BY de.person_id, de.drug_exposure_start_date
  ) ENDS
  GROUP BY ENDS.person_id, ENDS.era_end_date
) ERAS on ERAS.person_id = et.person_id 
WHERE et.start_date between ERAS.era_start_date and ERAS.era_end_date;

TRUNCATE TABLE #drugTarget;
DROP TABLE #drugTarget;


-- generate cohort periods into #final_cohort
with cohort_ends (event_id, person_id, end_date) as
(
	-- cohort exit dates
  -- By default, cohort exit at the event's op end date
select event_id, person_id, op_end_date as end_date from #included_events
UNION ALL
-- End Date Strategy
SELECT event_id, person_id, end_date from #strategy_ends

),
first_ends (person_id, start_date, end_date) as
(
	select F.person_id, F.start_date, F.end_date
	FROM (
	  select I.event_id, I.person_id, I.start_date, E.end_date, row_number() over (partition by I.person_id, I.event_id order by E.end_date) as ordinal 
	  from #included_events I
	  join cohort_ends E on I.event_id = E.event_id and I.person_id = E.person_id and E.end_date >= I.start_date
	) F
	WHERE F.ordinal = 1
)
select person_id, start_date, end_date
INTO #cohort_rows
from first_ends;

with cteEndDates (person_id, end_date) AS -- the magic
(	
	SELECT
		person_id
		, DATEADD(day,-1 * 30, event_date)  as end_date
	FROM
	(
		SELECT
			person_id
			, event_date
			, event_type
			, MAX(start_ordinal) OVER (PARTITION BY person_id ORDER BY event_date, event_type ROWS UNBOUNDED PRECEDING) AS start_ordinal 
			, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY event_date, event_type) AS overall_ord
		FROM
		(
			SELECT
				person_id
				, start_date AS event_date
				, -1 AS event_type
				, ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY start_date) AS start_ordinal
			FROM #cohort_rows
		
			UNION ALL
		

			SELECT
				person_id
				, DATEADD(day,30,end_date) as end_date
				, 1 AS event_type
				, NULL
			FROM #cohort_rows
		) RAWDATA
	) e
	WHERE (2 * e.start_ordinal) - e.overall_ord = 0
),
cteEnds (person_id, start_date, end_date) AS
(
	SELECT
		 c.person_id
		, c.start_date
		, MIN(e.end_date) AS end_date
	FROM #cohort_rows c
	JOIN cteEndDates e ON c.person_id = e.person_id AND e.end_date >= c.start_date
	GROUP BY c.person_id, c.start_date
)
select person_id, min(start_date) as start_date, end_date
into #final_cohort
from cteEnds
group by person_id, end_date
;

DELETE FROM @target_database_schema.@target_cohort_table where cohort_definition_id = @target_cohort_id;
INSERT INTO @target_database_schema.@target_cohort_table (cohort_definition_id, subject_id, cohort_start_date, cohort_end_date)
select @target_cohort_id as cohort_definition_id, person_id, start_date, end_date 
FROM #final_cohort CO
;



TRUNCATE TABLE #strategy_ends;
DROP TABLE #strategy_ends;


TRUNCATE TABLE #cohort_rows;
DROP TABLE #cohort_rows;

TRUNCATE TABLE #final_cohort;
DROP TABLE #final_cohort;

TRUNCATE TABLE #inclusion_events;
DROP TABLE #inclusion_events;

TRUNCATE TABLE #qualified_events;
DROP TABLE #qualified_events;

TRUNCATE TABLE #included_events;
DROP TABLE #included_events;

TRUNCATE TABLE #Codesets;
DROP TABLE #Codesets;